{"version":3,"file":"js/addon-entry-tw-comment-markdown-editor.js","sources":["webpack://GUI/./src/addons/addons/tw-comment-markdown-editor/userstyle.css","webpack://GUI/./src/addons/addons/tw-comment-markdown-editor/_runtime_entry.js","webpack://GUI/./src/addons/addons/tw-comment-markdown-editor/userscript.js"],"sourcesContent":["exports = module.exports = require(\"../../../../node_modules/css-loader/lib/css-base.js\")(false);\n// imports\n\n\n// module\nexports.push([module.id, \"/* 切换开关容器 - 集成到拖动栏 */\\n.tw-md-toggle-container {\\n  display: flex;\\n  justify-content: flex-end;\\n  align-items: center;\\n  padding: 2px 6px;\\n  background: transparent;\\n  gap: 6px;\\n  position: absolute;\\n  top: 2px;\\n  right: 2px;\\n  z-index: 10;\\n}\\n\\n/* 模式指示器 - 集成到拖动栏 */\\n.tw-md-mode-indicator {\\n  font-size: 14px;\\n  color: var(--editorTheme3-commentText, #888);\\n  margin-right: 8px;\\n  font-weight: 600;\\n  text-transform: uppercase;\\n  letter-spacing: 0.8px;\\n  opacity: 0.8;\\n  transition: all 0.2s ease;\\n  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);\\n}\\n\\n.tw-md-mode-indicator.preview-mode {\\n  color: #4CAF50;\\n  opacity: 1;\\n  font-weight: 600;\\n}\\n\\n/* 切换按钮 - 集成到拖动栏 */\\n.tw-md-toggle-button {\\n  background: rgba(var(--editorTheme3-commentBorder-rgb, 200, 200, 200), 0.3);\\n  color: var(--editorTheme3-commentText, #555);\\n  border: 1px solid rgba(0, 0, 0, 0.1);\\n  border-radius: 6px;\\n  padding: 6px 12px;\\n  font-size: 14px;\\n  font-weight: 600;\\n  cursor: pointer;\\n  opacity: 0.8;\\n  transition: all 0.2s ease;\\n  user-select: none;\\n  display: flex;\\n  align-items: center;\\n  gap: 6px;\\n  backdrop-filter: blur(2px);\\n}\\n\\n.tw-md-toggle-button:hover {\\n  opacity: 1;\\n  background: rgba(var(--editorTheme3-commentBorder-rgb, 200, 200, 200), 0.5);\\n}\\n\\n.tw-md-toggle-button:active {\\n  transform: scale(0.95);\\n}\\n\\n.tw-md-toggle-button[data-mode=\\\"preview\\\"] {\\n  background: rgba(76, 175, 80, 0.3);\\n  color: #2E7D32;\\n  border-color: rgba(76, 175, 80, 0.3);\\n}\\n\\n/* 预览容器 - 无背景框 */\\n.tw-md-preview-container {\\n  width: 100%;\\n  height: 100%;\\n  padding: 12px;\\n  background: transparent;\\n  color: var(--editorTheme3-commentText, #333);\\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\\n  font-size: 16px;\\n  line-height: 1.7;\\n  white-space: pre-wrap;\\n  overflow-y: auto;\\n  overflow-x: hidden;\\n  box-sizing: border-box;\\n  max-height: 100%;\\n}\\n\\n/* 预览内容样式 */\\n.tw-md-preview-container h1,\\n.tw-md-preview-container h2,\\n.tw-md-preview-container h3 {\\n  margin-top: 8px;\\n  margin-bottom: 6px;\\n  font-weight: 600;\\n  line-height: 1.3;\\n}\\n\\n.tw-md-preview-container h1 {\\n  font-size: 22px;\\n  color: var(--editorTheme3-commentText, #333);\\n  border-bottom: 2px solid var(--editorTheme3-commentBorder, #ddd);\\n  padding-bottom: 6px;\\n}\\n\\n.tw-md-preview-container h2 {\\n  font-size: 20px;\\n  color: var(--editorTheme3-commentText, #444);\\n}\\n\\n.tw-md-preview-container h3 {\\n  font-size: 18px;\\n  color: var(--editorTheme3-commentText, #555);\\n}\\n\\n\\n.tw-md-preview-container strong {\\n  font-weight: 600;\\n  color: var(--editorTheme3-commentText, #333);\\n}\\n\\n.tw-md-preview-container em {\\n  font-style: italic;\\n  color: var(--editorTheme3-commentText, #444);\\n}\\n\\n.tw-md-preview-container code {\\n  background-color: rgba(0, 0, 0, 0.08);\\n  color: #d73a49;\\n  padding: 3px 8px;\\n  border-radius: 4px;\\n  font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;\\n  font-size: 15px;\\n  border: 1px solid rgba(0, 0, 0, 0.1);\\n}\\n\\n/* 引用块样式 */\\n.tw-md-preview-container blockquote {\\n  border-left: 4px solid #dfe2e5;\\n  padding: 0 16px;\\n  margin: 8px 0;\\n  color: #6a737d;\\n  background-color: #f8f9fa;\\n  border-radius: 0 4px 4px 0;\\n  font-size: 14px;\\n  line-height: 1.6;\\n}\\n\\n.tw-md-preview-container pre code {\\n  display: block;\\n  padding: 12px 16px;\\n  margin: 8px 0;\\n  overflow-x: auto;\\n  background-color: #f6f8fa;\\n  border-radius: 4px;\\n  font-size: 14px;\\n  line-height: 1.6;\\n}\\n\\n.tw-md-preview-container a {\\n  color: #0366d6;\\n  text-decoration: none;\\n  font-weight: 500;\\n  border-bottom: 1px solid transparent;\\n  transition: border-color 0.2s ease;\\n}\\n\\n.tw-md-preview-container a:hover {\\n  text-decoration: underline;\\n  border-bottom-color: #0366d6;\\n}\\n\\n.tw-md-preview-container ul {\\n  margin: 8px 0;\\n  padding-left: 20px;\\n}\\n\\n.tw-md-preview-container li {\\n  margin: 2px 0;\\n  padding-left: 4px;\\n}\\n\\n.tw-md-preview-container li::marker {\\n  color: var(--editorTheme3-commentText, #666);\\n}\\n\\n/* 确保注释框内的滚动条正常显示 */\\n.tw-md-preview-container::-webkit-scrollbar {\\n  width: 10px;\\n  height: 10px;\\n}\\n\\n.tw-md-preview-container::-webkit-scrollbar-track {\\n  background: rgba(0, 0, 0, 0.05);\\n  border-radius: 5px;\\n}\\n\\n.tw-md-preview-container::-webkit-scrollbar-thumb {\\n  background: rgba(0, 0, 0, 0.3);\\n  border-radius: 5px;\\n  border: 2px solid transparent;\\n  background-clip: content-box;\\n}\\n\\n.tw-md-preview-container::-webkit-scrollbar-thumb:hover {\\n  background: rgba(0, 0, 0, 0.4);\\n  border: 2px solid transparent;\\n  background-clip: content-box;\\n}\\n\\n/* 确保注释框本身支持滚动 */\\n.tw-md-preview-container {\\n  scrollbar-width: thin;\\n  scrollbar-color: rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.05);\\n}\\n\", \"\"]);\n\n// exports\n","/* generated by pull.js */\nimport _js from \"./userscript.js\";\nimport _css from \"!css-loader!./userstyle.css\";\nexport const resources = {\n  \"userscript.js\": _js,\n  \"userstyle.css\": _css,\n};","export default async function ({ addon, console }) {\n  const vm = addon.tab.traps.vm;\n\n  // 等待Blockly加载\n  const Blockly = await addon.tab.traps.getBlockly();\n\n  // 处理注释元素的函数\n  const processCommentElements = () => {\n    // 如果插件被禁用，不处理任何元素\n    if (addon.self.disabled) return;\n\n    // 查找所有注释元素\n    const commentElements = document.querySelectorAll('.blocklyBubbleCanvas > g');\n\n    commentElements.forEach(commentEl => {\n      // 检查是否已经处理过\n      if (commentEl.dataset.markdownProcessed) return;\n\n      // 查找textarea\n      const textarea = commentEl.querySelector('textarea');\n      if (!textarea) return;\n\n      // 查找顶部栏（拖动栏）\n      const topBar = commentEl.querySelector('.scratchCommentBody') || commentEl.querySelector('[class*=\"TopBar\"]') || commentEl.firstElementChild;\n      if (!topBar) return;\n\n      // 标记为已处理\n      commentEl.dataset.markdownProcessed = 'true';\n\n      // 创建切换开关容器\n      const toggleContainer = document.createElement('div');\n      toggleContainer.className = 'tw-md-toggle-container';\n\n      // 创建模式指示器\n      const modeIndicator = document.createElement('span');\n      modeIndicator.className = 'tw-md-mode-indicator';\n      modeIndicator.textContent = '编辑模式';\n\n      // 创建切换按钮\n      const toggleButton = document.createElement('button');\n      toggleButton.className = 'tw-md-toggle-button';\n      toggleButton.innerHTML = '编辑';\n      toggleButton.dataset.mode = 'edit';\n      toggleButton.title = '切换到预览模式 (Ctrl+M)';\n\n      // 将元素添加到容器\n      toggleContainer.appendChild(modeIndicator);\n      toggleContainer.appendChild(toggleButton);\n\n      // 创建预览容器\n      const previewContainer = document.createElement('div');\n      previewContainer.className = 'tw-md-preview-container';\n      previewContainer.style.display = 'none';\n\n      // 将元素添加到DOM\n      toggleContainer.appendChild(toggleButton);\n      topBar.appendChild(toggleContainer);\n\n      // 找到注释内容区域并添加预览容器\n      const contentArea = commentEl.querySelector('.scratchCommentTextarea')?.parentElement || textarea.parentElement;\n      if (contentArea) {\n        contentArea.appendChild(previewContainer);\n      }\n\n      // 切换模式的事件处理\n      toggleButton.addEventListener('click', (e) => {\n        e.stopPropagation();\n        e.preventDefault();\n\n        toggleMode();\n      });\n\n      // 键盘快捷键支持 (Ctrl/Cmd + M) - 全局监听\n      document.addEventListener('keydown', (e) => {\n        if ((e.ctrlKey || e.metaKey) && e.key === 'm') {\n          // 检查是否有活动的注释编辑 - 通过焦点元素或当前模式\n          const activeElement = document.activeElement;\n          const isEditingComment = activeElement && (\n            activeElement === textarea ||\n            activeElement.closest('[data-markdown-processed]') === commentEl\n          );\n\n          // 如果在编辑此注释，或者当前处于预览模式，都允许切换\n          const isInPreviewMode = toggleButton.dataset.mode === 'preview';\n\n          if ((isEditingComment || isInPreviewMode) && commentEl.dataset.markdownProcessed === 'true') {\n            e.preventDefault();\n            toggleMode();\n          }\n        }\n      });\n\n      // 切换模式的函数\n      function toggleMode() {\n        const mode = toggleButton.dataset.mode;\n        if (mode === 'edit') {\n          // 切换到预览模式\n          toggleButton.dataset.mode = 'preview';\n          toggleButton.innerHTML = '预览';\n          toggleButton.title = '切换到编辑模式 (Ctrl+M)';\n          modeIndicator.textContent = '预览模式';\n          modeIndicator.classList.add('preview-mode');\n          textarea.style.display = 'none';\n          previewContainer.style.display = 'block';\n\n          // 渲染Markdown\n          renderMarkdown(textarea.value, previewContainer);\n        } else {\n          // 切换到编辑模式\n          toggleButton.dataset.mode = 'edit';\n          toggleButton.innerHTML = '编辑';\n          toggleButton.title = '切换到预览模式 (Ctrl+M)';\n          modeIndicator.textContent = '编辑模式';\n          modeIndicator.classList.remove('preview-mode');\n          textarea.style.display = 'block';\n          previewContainer.style.display = 'none';\n\n          // 重新聚焦到textarea\n          textarea.focus();\n        }\n      }\n\n      // 当textarea内容改变时，更新预览\n      textarea.addEventListener('input', () => {\n        if (toggleButton.dataset.mode === 'preview') {\n          renderMarkdown(textarea.value, previewContainer);\n        }\n      });\n\n      console.log('Processed comment element:', commentEl);\n    });\n  };\n\n  // 增强的Markdown渲染函数\n  function renderMarkdown(text, container) {\n    // 清空容器\n    container.innerHTML = '';\n\n    // 增强的Markdown渲染实现\n    let html = text\n      // 引用 - 必须在其他处理之前\n      .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')\n      // 标题\n      .replace(/^### (.*$)/gm, '<h3>$1</h3>')\n      .replace(/^## (.*$)/gm, '<h2>$1</h2>')\n      .replace(/^# (.*$)/gm, '<h1>$1</h1>')\n      // 粗体和斜体\n      .replace(/\\*\\*(.*?)\\*\\*/gm, '<strong>$1</strong>')\n      .replace(/\\*(.*?)\\*/gm, '<em>$1</em>')\n      // 代码块\n      .replace(/```([\\s\\S]*?)```/gm, '<pre><code>$1</code></pre>')\n      // 行内代码\n      .replace(/`(.*?)`/gm, '<code>$1</code>')\n      // 图片\n      .replace(/!\\[([^\\]]*)\\]\\(([^)]+)\\)/gm, '<img src=\"$2\" alt=\"$1\" style=\"max-width: 100%; height: auto; border-radius: 4px; margin: 8px 0;\">')\n      // 链接\n      .replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/gm, '<a href=\"$2\" target=\"_blank\" rel=\"noopener noreferrer\">$1</a>')\n      // 列表项\n      .replace(/^\\* (.*$)/gm, '<li>$1</li>')\n      .replace(/^- (.*$)/gm, '<li>$1</li>')\n      // 换行\n      .replace(/\\n/g, '<br>');\n\n    // 处理列表\n    html = html.replace(/(<li>.*<\\/li>)/s, '<ul>$1</ul>');\n\n    container.innerHTML = html;\n  }\n\n  // 监听DOM变化，处理新添加的注释\n  const observer = new MutationObserver((mutations) => {\n    let shouldProcess = false;\n    mutations.forEach(mutation => {\n      mutation.addedNodes.forEach(node => {\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          if (node.matches && node.matches('.blocklyBubbleCanvas > g')) {\n            shouldProcess = true;\n          } else if (node.querySelector && node.querySelector('.blocklyBubbleCanvas > g')) {\n            shouldProcess = true;\n          }\n        }\n      });\n    });\n\n    if (shouldProcess) {\n      setTimeout(processCommentElements, 100);\n    }\n  });\n\n  // 开始监听\n  observer.observe(document.body, {\n    childList: true,\n    subtree: true\n  });\n\n  // 初始处理\n  setTimeout(processCommentElements, 1000);\n\n  // 定期处理新元素\n  setInterval(processCommentElements, 2000);\n\n  // 插件禁用时清理功能\n  addon.self.addEventListener('disabled', () => {\n    // 移除所有添加的切换元素\n    const toggleContainers = document.querySelectorAll('.tw-md-toggle-container');\n    const previewContainers = document.querySelectorAll('.tw-md-preview-container');\n\n    toggleContainers.forEach(container => container.remove());\n    previewContainers.forEach(container => container.remove());\n\n    // 重置所有注释元素的处理状态\n    const processedElements = document.querySelectorAll('[data-markdown-processed]');\n    processedElements.forEach(el => {\n      delete el.dataset.markdownProcessed;\n      // 显示所有textarea\n      const textarea = el.querySelector('textarea');\n      if (textarea) {\n        textarea.style.display = 'block';\n      }\n    });\n\n    console.log('Markdown comment editor addon disabled');\n  });\n\n  // 插件启用时重新处理\n  addon.self.addEventListener('enabled', () => {\n    setTimeout(processCommentElements, 500);\n    console.log('Markdown comment editor addon enabled');\n  });\n\n  console.log('Markdown comment editor addon loaded');\n}\n"],"mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACNA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAIA;AAAA;AAGA;AAAA;AAEA;AAAA;AAEA;AAAA;AAEA;AAAA;AAEA;AAAA;AAGA;AAAA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;A","sourceRoot":""}