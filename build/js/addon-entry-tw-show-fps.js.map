{"version":3,"file":"js/addon-entry-tw-show-fps.js","sources":["webpack://GUI/./src/addons/addons/show-fps/style.css","webpack://GUI/./src/addons/addons/show-fps/_runtime_entry.js","webpack://GUI/./src/addons/addons/show-fps/userscript.js","webpack://GUI/./src/addons/libraries/common/cs/small-stage.js"],"sourcesContent":["exports = module.exports = require(\"../../../../node_modules/css-loader/lib/css-base.js\")(false);\n// imports\n\n\n// module\nexports.push([module.id, \".fps-container-container {\\n  display: flex;\\n  align-items: center;\\n  padding: 0.25rem;\\n  -webkit-user-select: none;\\n  user-select: none;\\n  width: 60px;\\n  justify-content: center;\\n  position: relative;\\n}\\n\\n.fps-container {\\n  font-size: 0.6rem;\\n  font-weight: bold;\\n  font-family: \\\"Helvetica Neue\\\", Helvetica, Arial, sans-serif;\\n  color: #82c1ff;\\n  white-space: nowrap;\\n}\\n\\n/* Use pseudo elements to avoid firing mutation observers by just moving the cursor */\\n.fps-container > span::after {\\n  content: attr(data-content);\\n}\\n\\n.sa-small-stage .fps-container-container {\\n  display: none !important;\\n}\", \"\"]);\n\n// exports\n","/* generated by pull.js */\nimport _js from \"./userscript.js\";\nimport _css from \"!css-loader!./style.css\";\nexport const resources = {\n  \"userscript.js\": _js,\n  \"style.css\": _css\n};","import addSmallStageClass from \"../../libraries/common/cs/small-stage.js\";\n\nexport default async function ({ addon, console }) {\n  // 创建 FPS 显示容器\n  const fpsContainerContainer = document.createElement(\"div\");\n  addon.tab.displayNoneWhileDisabled(fpsContainerContainer, { display: \"flex\" });\n\n  const fpsContainer = document.createElement(\"div\");\n  const fpsText = document.createElement(\"span\");\n\n  fpsContainerContainer.className = \"fps-container-container\";\n  fpsContainer.className = \"fps-container\";\n\n  fpsContainerContainer.appendChild(fpsContainer);\n  fpsContainer.appendChild(fpsText);\n\n  const vm = addon.tab.traps.vm;\n\n  // FPS 计算逻辑 - 参考 debugger/performance.js\n  const renderTimes = [];\n  let lastFpsTime = performance.now();\n  let currentFps = 60;\n  let updateInterval = null;\n\n  const updateFps = () => {\n    if (addon.self.disabled) return;\n\n    const now = performance.now();\n\n    // 移除超过 1 秒的帧时间记录\n    while (renderTimes.length > 0 && renderTimes[0] <= now - 1000) {\n      renderTimes.shift();\n    }\n    renderTimes.push(now);\n\n    // 每秒更新一次显示\n    if (now - lastFpsTime >= 1000) {\n      lastFpsTime = now;\n\n      // 获取目标帧率\n      const maxFps = vm.runtime.frameLoop.framerate === 0 ? 60 : vm.runtime.frameLoop.framerate;\n      currentFps = Math.min(renderTimes.length, maxFps);\n      fpsText.style.color = currentFps > maxFps * 0.7 ? \"#82c1ff\" : (\n        currentFps > maxFps * 0.5 ? \"#82ff97\" : (\n          currentFps > maxFps * 0.2 ? \"rgb(255, 197, 130)\" : \"rgb(255, 130, 130)\"\n        )\n\n      )\n      fpsText.setAttribute(\"data-content\", `${currentFps} FPS`);\n    }\n  };\n\n  // 使用 addAfterStepCallback 在每次 VM step 后更新 FPS\n  const originalStep = vm.runtime._step;\n  vm.runtime._step = function (...args) {\n    const ret = originalStep.call(this, ...args);\n    updateFps();\n    return ret;\n  };\n\n  // 初始化显示\n  fpsText.setAttribute(\"data-content\", \"60 FPS\");\n\n  addSmallStageClass();\n\n  while (true) {\n    await addon.tab.waitForElement('[class*=\"controls_controls-container\"]', {\n      markAsSeen: true,\n      reduxEvents: [\n        \"scratch-gui/mode/SET_PLAYER\",\n        \"fontsLoaded/SET_FONTS_LOADED\",\n        \"scratch-gui/locales/SELECT_LOCALE\"\n      ],\n    });\n\n    if (addon.tab.editorMode === \"editor\") {\n      addon.tab.appendToSharedSpace({ space: \"afterStopButton\", element: fpsContainerContainer, order: 0 });\n    } else {\n      fpsContainerContainer.remove();\n    }\n  }\n}","export default function addSmallStageClass() {\n  // TW: no-op; sa-small-stage class is handled by scratch-gui\n}\n"],"mappings":";;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;ACPA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACNA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAEA;AACA;AACA;AACA;AAKA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;ACjFA;AAAA;AAAA;AACA;AAAA;;;;A","sourceRoot":""}