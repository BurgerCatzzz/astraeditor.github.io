(window["webpackJsonpGUI"] = window["webpackJsonpGUI"] || []).push([["addon-entry-my-blocks-plus"],{

/***/ "./src/addons/addons/my-blocks-plus/_runtime_entry.js":
/*!************************************************************!*\
  !*** ./src/addons/addons/my-blocks-plus/_runtime_entry.js ***!
  \************************************************************/
/*! exports provided: resources */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "resources", function() { return resources; });
/* harmony import */ var _userscript_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./userscript.js */ "./src/addons/addons/my-blocks-plus/userscript.js");
/* generated by pull.js */

const resources = {
  "userscript.js": _userscript_js__WEBPACK_IMPORTED_MODULE_0__["default"]
};

/***/ }),

/***/ "./src/addons/addons/my-blocks-plus/userscript.js":
/*!********************************************************!*\
  !*** ./src/addons/addons/my-blocks-plus/userscript.js ***!
  \********************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (async function (_ref) {
  let {
    addon,
    console
  } = _ref;
  const vm = addon.tab.traps.vm;
  const loadExtensions = () => {
    if (addon.self.disabled) return;
    vm.extensionManager.loadExtensionURL("\n      data:text/javascript;base64,Ly8gTmFtZTogTXkgQmxvY2tzKwovLyBJRDogU1BtYnBDU1QKLy8gRGVzY3JpcHRpb246IENyZWF0ZSBCZXR0ZXIgQ3VzdG9tIEJsb2NrcwovLyBCeTogU2hhcmtQb29sCi8vIEJ5OiBDU1QxMjI5IDxodHRwczovL3NjcmF0Y2gubWl0LmVkdS91c2Vycy9DU1QxMjI5Lz4KLy8gQnk6IDB6bnp3IDxodHRwczovL3NjcmF0Y2gubWl0LmVkdS91c2Vycy8wem56dy8+Ci8vIExpY2Vuc2U6IE1JVAoKLy8gVmVyc2lvbiBWLjEuMi42NAoKLy8gTXVsdGktbGFuZ3VhZ2Ugc3VwcG9ydCBieSBLT1NISU5PClNjcmF0Y2gudHJhbnNsYXRlLnNldHVwKHsKICAiemgtY24iOiB7CiAgICAiX015IEJsb2NrcysiOiAi6Ieq5Yi256ev5pyoKyIsCiAgICAiX01ha2UgYSBCbG9jaysiOiAi5Yi25L2c5paw55qE56ev5pyoKyIsCiAgICAiX3NldCBbUEFSQU1dIHRvIFtWQUxVRV0iOiAi6K6+572uIFtQQVJBTV0g5Li6IFtWQUxVRV0iLAogICAgIl92YWx1ZSI6ICLlgLwiLAogICAgIl9nZXQgW1BBUkFNXSI6ICLojrflj5YgW1BBUkFNXSIsCiAgICAiX3BhcmFtZXRlciBuYW1lIjogIuWxnuaAp+WQjSIsCiAgICAiX3N0YXJ0IGJyYW5jaCBbSU5ERVhdIFtJQ09OXSI6ICLlvIDlp4vliIbmlK8gW0lOREVYXSBbSUNPTl0iLAogICAgIl9zdG9wIGNhbGxlciBzY3JpcHQiOiAi5YGc5q2i6LCD55So6ISa5pysIiwKICAgICJfbnVtYmVyIG9yIHRleHQiOiAi5pWw5a2X5oiW5paH5a2XIiwKICAgICJfbnVtYmVyIjogIuaVsOWtlyIsCiAgICAiX2Jvb2xlYW4iOiAi5biD5bCU5YC8IiwKICAgICJfYW5nbGUiOiAi6KeS5bqmIiwKICAgICJfY29sb3IiOiAi6aKc6ImyIiwKICAgICJfbm90ZSI6ICLpn7PnrKYiLAogICAgIl9tYXRyaXgiOiAi55+p6Zi1IiwKICAgICJfZW1wdHkiOiAi56m6IiwKICAgICJfZHJvcGRvd24iOiAi5LiL5ouJ6I+c5Y2VIiwKICAgICJfYnJhbmNoIjogIuWIhuaUryIsCiAgICAiX0FkZCBhIGxhYmVsIjogIuWinuWKoOS4gOS4quagh+etviIsCiAgICAiX3RleHQiOiAi5paH5pysIiwKICAgICJfaW1hZ2UiOiAi5Zu+5YOPIiwKICAgICJfQ2FwIGJsb2NrIjogIue7iOatouWdlyIsCiAgICAiX0F2YWlsYWJsZSBmb3IgYWxsIHNwcml0ZXMiOiAi5Zyo5omA5pyJ6KeS6Imy6YO95Y+v55SoIiwKICAgICJfU2VsZWN0IGEgRHJvcGRvd24iOiAi6YCJ5oup5LiA5Liq5LiL5ouJ6I+c5Y2VIgogIH0sCiAgImVuIjogewogICAgIl9NeSBCbG9ja3MrIjogIk15IEJsb2NrcysiLAogICAgIl9NYWtlIGEgQmxvY2srIjogIk1ha2UgYSBCbG9jaysiLAogICAgIl9zZXQgW1BBUkFNXSB0byBbVkFMVUVdIjogInNldCBbUEFSQU1dIHRvIFtWQUxVRV0iLAogICAgIl92YWx1ZSI6ICJ2YWx1ZSIsCiAgICAiX2dldCBbUEFSQU1dIjogImdldCBbUEFSQU1dIiwKICAgICJfcGFyYW1ldGVyIG5hbWUiOiAicGFyYW1ldGVyIG5hbWUiLAogICAgIl9zdGFydCBicmFuY2ggW0lOREVYXSBbSUNPTl0iOiAic3RhcnQgYnJhbmNoIFtJTkRFWF0gW0lDT05dIiwKICAgICJfc3RvcCBjYWxsZXIgc2NyaXB0IjogInN0b3AgY2FsbGVyIHNjcmlwdCIsCiAgICAiX251bWJlciBvciB0ZXh0IjogIm51bWJlciBvciB0ZXh0IiwKICAgICJfbnVtYmVyIjogIm51bWJlciIsCiAgICAiX2Jvb2xlYW4iOiAiYm9vbGVhbiIsCiAgICAiX2FuZ2xlIjogImFuZ2xlIiwKICAgICJfY29sb3IiOiAiY29sb3IiLAogICAgIl9ub3RlIjogIm5vdGUiLAogICAgIl9tYXRyaXgiOiAibWF0cml4IiwKICAgICJfZW1wdHkiOiAiZW1wdHkiLAogICAgIl9kcm9wZG93biI6ICJkcm9wZG93biIsCiAgICAiX2JyYW5jaCI6ICJicmFuY2giLAogICAgIl9BZGQgYSBsYWJlbCI6ICJBZGQgYSBsYWJlbCIsCiAgICAiX3RleHQiOiAidGV4dCIsCiAgICAiX2ltYWdlIjogImltYWdlIiwKICAgICJfQ2FwIGJsb2NrIjogIkNhcCBibG9jayIsCiAgICAiX0F2YWlsYWJsZSBmb3IgYWxsIHNwcml0ZXMiOiAiQXZhaWxhYmxlIGZvciBhbGwgc3ByaXRlcyIsCiAgICAiX1NlbGVjdCBhIERyb3Bkb3duIjogIlNlbGVjdCBhIERyb3Bkb3duIgogIH0sCiAgImVzIjogewogICAgIl9NeSBCbG9ja3MrIjogIk1pcyBCbG9xdWVzKyIsCiAgICAiX01ha2UgYSBCbG9jaysiOiAiQ3JlYXIgdW4gQmxvcXVlKyIsCiAgICAiX3NldCBbUEFSQU1dIHRvIFtWQUxVRV0iOiAiZXN0YWJsZWNlciBbUEFSQU1dIGEgW1ZBTFVFXSIsCiAgICAiX3ZhbHVlIjogInZhbG9yIiwKICAgICJfZ2V0IFtQQVJBTV0iOiAib2J0ZW5lciBbUEFSQU1dIiwKICAgICJfcGFyYW1ldGVyIG5hbWUiOiAibm9tYnJlIGRlbCBwYXLDoW1ldHJvIiwKICAgICJfc3RhcnQgYnJhbmNoIFtJTkRFWF0gW0lDT05dIjogImluaWNpYXIgcmFtYSBbSU5ERVhdIFtJQ09OXSIsCiAgICAiX3N0b3AgY2FsbGVyIHNjcmlwdCI6ICJkZXRlbmVyIHNjcmlwdCBsbGFtYWRvciIsCiAgICAiX251bWJlciBvciB0ZXh0IjogIm7Dum1lcm8gbyB0ZXh0byIsCiAgICAiX251bWJlciI6ICJuw7ptZXJvIiwKICAgICJfYm9vbGVhbiI6ICJib29sZWFubyIsCiAgICAiX2FuZ2xlIjogIsOhbmd1bG8iLAogICAgIl9jb2xvciI6ICJjb2xvciIsCiAgICAiX25vdGUiOiAibm90YSIsCiAgICAiX21hdHJpeCI6ICJtYXRyaXoiLAogICAgIl9lbXB0eSI6ICJ2YWPDrW8iLAogICAgIl9kcm9wZG93biI6ICJtZW7DuiBkZXNwbGVnYWJsZSIsCiAgICAiX2JyYW5jaCI6ICJyYW1hIiwKICAgICJfQWRkIGEgbGFiZWwiOiAiQcOxYWRpciB1bmEgZXRpcXVldGEiLAogICAgIl90ZXh0IjogInRleHRvIiwKICAgICJfaW1hZ2UiOiAiaW1hZ2VuIiwKICAgICJfQ2FwIGJsb2NrIjogIkJsb3F1ZSB0ZXJtaW5hbCIsCiAgICAiX0F2YWlsYWJsZSBmb3IgYWxsIHNwcml0ZXMiOiAiRGlzcG9uaWJsZSBwYXJhIHRvZG9zIGxvcyBvYmpldG9zIiwKICAgICJfU2VsZWN0IGEgRHJvcGRvd24iOiAiU2VsZWNjaW9uYXIgdW4gbWVuw7ogZGVzcGxlZ2FibGUiCiAgfSwKICAiZnIiOiB7CiAgICAiX015IEJsb2NrcysiOiAiTWVzIEJsb2NzKyIsCiAgICAiX01ha2UgYSBCbG9jaysiOiAiQ3LDqWVyIHVuIEJsb2MrIiwKICAgICJfc2V0IFtQQVJBTV0gdG8gW1ZBTFVFXSI6ICJtZXR0cmUgW1BBUkFNXSDDoCBbVkFMVUVdIiwKICAgICJfdmFsdWUiOiAidmFsZXVyIiwKICAgICJfZ2V0IFtQQVJBTV0iOiAib2J0ZW5pciBbUEFSQU1dIiwKICAgICJfcGFyYW1ldGVyIG5hbWUiOiAibm9tIGR1IHBhcmFtw6h0cmUiLAogICAgIl9zdGFydCBicmFuY2ggW0lOREVYXSBbSUNPTl0iOiAiZMOpbWFycmVyIGJyYW5jaGUgW0lOREVYXSBbSUNPTl0iLAogICAgIl9zdG9wIGNhbGxlciBzY3JpcHQiOiAiYXJyw6p0ZXIgc2NyaXB0IGFwcGVsYW50IiwKICAgICJfbnVtYmVyIG9yIHRleHQiOiAibm9tYnJlIG91IHRleHRlIiwKICAgICJfbnVtYmVyIjogIm5vbWJyZSIsCiAgICAiX2Jvb2xlYW4iOiAiYm9vbMOpZW4iLAogICAgIl9hbmdsZSI6ICJhbmdsZSIsCiAgICAiX2NvbG9yIjogImNvdWxldXIiLAogICAgIl9ub3RlIjogIm5vdGUiLAogICAgIl9tYXRyaXgiOiAibWF0cmljZSIsCiAgICAiX2VtcHR5IjogInZpZGUiLAogICAgIl9kcm9wZG93biI6ICJtZW51IGTDqXJvdWxhbnQiLAogICAgIl9icmFuY2giOiAiYnJhbmNoZSIsCiAgICAiX0FkZCBhIGxhYmVsIjogIkFqb3V0ZXIgdW5lIMOpdGlxdWV0dGUiLAogICAgIl90ZXh0IjogInRleHRlIiwKICAgICJfaW1hZ2UiOiAiaW1hZ2UiLAogICAgIl9DYXAgYmxvY2siOiAiQmxvYyB0ZXJtaW5hbCIsCiAgICAiX0F2YWlsYWJsZSBmb3IgYWxsIHNwcml0ZXMiOiAiRGlzcG9uaWJsZSBwb3VyIHRvdXMgbGVzIGx1dGlucyIsCiAgICAiX1NlbGVjdCBhIERyb3Bkb3duIjogIlPDqWxlY3Rpb25uZXIgdW4gbWVudSBkw6lyb3VsYW50IgogIH0sCiAgImRlIjogewogICAgIl9NeSBCbG9ja3MrIjogIk1laW5lIEJsw7Zja2UrIiwKICAgICJfTWFrZSBhIEJsb2NrKyI6ICJCbG9jayBlcnN0ZWxsZW4rIiwKICAgICJfc2V0IFtQQVJBTV0gdG8gW1ZBTFVFXSI6ICJzZXR6ZSBbUEFSQU1dIGF1ZiBbVkFMVUVdIiwKICAgICJfdmFsdWUiOiAiV2VydCIsCiAgICAiX2dldCBbUEFSQU1dIjogImhvbGUgW1BBUkFNXSIsCiAgICAiX3BhcmFtZXRlciBuYW1lIjogIlBhcmFtZXRlcm5hbWUiLAogICAgIl9zdGFydCBicmFuY2ggW0lOREVYXSBbSUNPTl0iOiAic3RhcnRlIFp3ZWlnIFtJTkRFWF0gW0lDT05dIiwKICAgICJfc3RvcCBjYWxsZXIgc2NyaXB0IjogInJ1ZmVuZGVzIFNrcmlwdCBzdG9wcGVuIiwKICAgICJfbnVtYmVyIG9yIHRleHQiOiAiWmFobCBvZGVyIFRleHQiLAogICAgIl9udW1iZXIiOiAiWmFobCIsCiAgICAiX2Jvb2xlYW4iOiAiQm9vbGVzY2hlciBXZXJ0IiwKICAgICJfYW5nbGUiOiAiV2lua2VsIiwKICAgICJfY29sb3IiOiAiRmFyYmUiLAogICAgIl9ub3RlIjogIk5vdGUiLAogICAgIl9tYXRyaXgiOiAiTWF0cml4IiwKICAgICJfZW1wdHkiOiAibGVlciIsCiAgICAiX2Ryb3Bkb3duIjogIkRyb3Bkb3duLU1lbsO8IiwKICAgICJfYnJhbmNoIjogIlp3ZWlnIiwKICAgICJfQWRkIGEgbGFiZWwiOiAiTGFiZWwgaGluenVmw7xnZW4iLAogICAgIl90ZXh0IjogIlRleHQiLAogICAgIl9pbWFnZSI6ICJCaWxkIiwKICAgICJfQ2FwIGJsb2NrIjogIkVuZGJsb2NrIiwKICAgICJfQXZhaWxhYmxlIGZvciBhbGwgc3ByaXRlcyI6ICJGw7xyIGFsbGUgRmlndXJlbiB2ZXJmw7xnYmFyIiwKICAgICJfU2VsZWN0IGEgRHJvcGRvd24iOiAiRHJvcGRvd24tTWVuw7wgYXVzd8OkaGxlbiIKICB9LAogICJpdCI6IHsKICAgICJfTXkgQmxvY2tzKyI6ICJJIE1pZWkgQmxvY2NoaSsiLAogICAgIl9NYWtlIGEgQmxvY2srIjogIkNyZWEgdW4gQmxvY2NvKyIsCiAgICAiX3NldCBbUEFSQU1dIHRvIFtWQUxVRV0iOiAiaW1wb3N0YSBbUEFSQU1dIGEgW1ZBTFVFXSIsCiAgICAiX3ZhbHVlIjogInZhbG9yZSIsCiAgICAiX2dldCBbUEFSQU1dIjogIm90dGllbmkgW1BBUkFNXSIsCiAgICAiX3BhcmFtZXRlciBuYW1lIjogIm5vbWUgZGVsIHBhcmFtZXRybyIsCiAgICAiX3N0YXJ0IGJyYW5jaCBbSU5ERVhdIFtJQ09OXSI6ICJhdnZpYSByYW1vIFtJTkRFWF0gW0lDT05dIiwKICAgICJfc3RvcCBjYWxsZXIgc2NyaXB0IjogImZlcm1hIHNjcmlwdCBjaGlhbWFudGUiLAogICAgIl9udW1iZXIgb3IgdGV4dCI6ICJudW1lcm8gbyB0ZXN0byIsCiAgICAiX251bWJlciI6ICJudW1lcm8iLAogICAgIl9ib29sZWFuIjogImJvb2xlYW5vIiwKICAgICJfYW5nbGUiOiAiYW5nb2xvIiwKICAgICJfY29sb3IiOiAiY29sb3JlIiwKICAgICJfbm90ZSI6ICJub3RhIiwKICAgICJfbWF0cml4IjogIm1hdHJpY2UiLAogICAgIl9lbXB0eSI6ICJ2dW90byIsCiAgICAiX2Ryb3Bkb3duIjogIm1lbnUgYSBkaXNjZXNhIiwKICAgICJfYnJhbmNoIjogInJhbW8iLAogICAgIl9BZGQgYSBsYWJlbCI6ICJBZ2dpdW5naSB1bidldGljaGV0dGEiLAogICAgIl90ZXh0IjogInRlc3RvIiwKICAgICJfaW1hZ2UiOiAiaW1tYWdpbmUiLAogICAgIl9DYXAgYmxvY2siOiAiQmxvY2NvIHRlcm1pbmFsZSIsCiAgICAiX0F2YWlsYWJsZSBmb3IgYWxsIHNwcml0ZXMiOiAiRGlzcG9uaWJpbGUgcGVyIHR1dHRpIGdsaSBzcHJpdGUiLAogICAgIl9TZWxlY3QgYSBEcm9wZG93biI6ICJTZWxlemlvbmEgdW4gbWVudSBhIGRpc2Nlc2EiCiAgfSwKICAiamEiOiB7CiAgICAiX015IEJsb2NrcysiOiAi44Oe44Kk44OW44Ot44OD44KvKyIsCiAgICAiX01ha2UgYSBCbG9jaysiOiAi44OW44Ot44OD44Kv44KS5L2c44KLKyIsCiAgICAiX3NldCBbUEFSQU1dIHRvIFtWQUxVRV0iOiAiW1BBUkFNXSDjgpIgW1ZBTFVFXSDjgavjgZnjgosiLAogICAgIl92YWx1ZSI6ICLlgKQiLAogICAgIl9nZXQgW1BBUkFNXSI6ICJbUEFSQU1dIOOCkuWPluW+lyIsCiAgICAiX3BhcmFtZXRlciBuYW1lIjogIuODkeODqeODoeODvOOCv+WQjSIsCiAgICAiX3N0YXJ0IGJyYW5jaCBbSU5ERVhdIFtJQ09OXSI6ICLjg5bjg6njg7Pjg4EgW0lOREVYXSBbSUNPTl0g44KS6ZaL5aeLIiwKICAgICJfc3RvcCBjYWxsZXIgc2NyaXB0IjogIuWRvOOBs+WHuuOBl+WFg+OCueOCr+ODquODl+ODiOOCkuWBnOatoiIsCiAgICAiX251bWJlciBvciB0ZXh0IjogIuaVsOWtl+OBvuOBn+OBr+ODhuOCreOCueODiCIsCiAgICAiX251bWJlciI6ICLmlbDlrZciLAogICAgIl9ib29sZWFuIjogIuODluODvOODq+WApCIsCiAgICAiX2FuZ2xlIjogIuinkuW6piIsCiAgICAiX2NvbG9yIjogIuiJsiIsCiAgICAiX25vdGUiOiAi6Z+z56ymIiwKICAgICJfbWF0cml4IjogIuODnuODiOODquODg+OCr+OCuSIsCiAgICAiX2VtcHR5IjogIuepuiIsCiAgICAiX2Ryb3Bkb3duIjogIuODieODreODg+ODl+ODgOOCpuODsyIsCiAgICAiX2JyYW5jaCI6ICLjg5bjg6njg7Pjg4EiLAogICAgIl9BZGQgYSBsYWJlbCI6ICLjg6njg5njg6vjgpLov73liqAiLAogICAgIl90ZXh0IjogIuODhuOCreOCueODiCIsCiAgICAiX2ltYWdlIjogIueUu+WDjyIsCiAgICAiX0NhcCBibG9jayI6ICLntYLnq6/jg5bjg63jg4Pjgq8iLAogICAgIl9BdmFpbGFibGUgZm9yIGFsbCBzcHJpdGVzIjogIuOBmeOBueOBpuOBruOCueODl+ODqeOCpOODiOOBp+WIqeeUqOWPr+iDvSIsCiAgICAiX1NlbGVjdCBhIERyb3Bkb3duIjogIuODieODreODg+ODl+ODgOOCpuODs+OCkumBuOaKniIKICB9LAogICJrbyI6IHsKICAgICJfTXkgQmxvY2tzKyI6ICLrgrQg67iU66GdKyIsCiAgICAiX01ha2UgYSBCbG9jaysiOiAi67iU66GdIOunjOuTpOq4sCsiLAogICAgIl9zZXQgW1BBUkFNXSB0byBbVkFMVUVdIjogIltQQVJBTV0g7J2EKOulvCkgW1ZBTFVFXSAo7Jy8KeuhnCDshKTsoJUiLAogICAgIl92YWx1ZSI6ICLqsJIiLAogICAgIl9nZXQgW1BBUkFNXSI6ICJbUEFSQU1dIOyWu+q4sCIsCiAgICAiX3BhcmFtZXRlciBuYW1lIjogIuunpOqwnOuzgOyImCDsnbTrpoQiLAogICAgIl9zdGFydCBicmFuY2ggW0lOREVYXSBbSUNPTl0iOiAi67iM656c7LmYIFtJTkRFWF0gW0lDT05dIOyLnOyekSIsCiAgICAiX3N0b3AgY2FsbGVyIHNjcmlwdCI6ICLtmLjstpzsnpAg7Iqk7YGs66a97Yq4IOykkeyngCIsCiAgICAiX251bWJlciBvciB0ZXh0IjogIuyIq+yekCDrmJDripQg7YWN7Iqk7Yq4IiwKICAgICJfbnVtYmVyIjogIuyIq+yekCIsCiAgICAiX2Jvb2xlYW4iOiAi67aA7Jq4IOqwkiIsCiAgICAiX2FuZ2xlIjogIuqwgeuPhCIsCiAgICAiX2NvbG9yIjogIuyDieyDgSIsCiAgICAiX25vdGUiOiAi7J2M7ZGcIiwKICAgICJfbWF0cml4IjogIu2WieugrCIsCiAgICAiX2VtcHR5IjogIuu5iCDqsJIiLAogICAgIl9kcm9wZG93biI6ICLrk5zroa3ri6TsmrQiLAogICAgIl9icmFuY2giOiAi67iM656c7LmYIiwKICAgICJfQWRkIGEgbGFiZWwiOiAi652867KoIOy2lOqwgCIsCiAgICAiX3RleHQiOiAi7YWN7Iqk7Yq4IiwKICAgICJfaW1hZ2UiOiAi7J2066+47KeAIiwKICAgICJfQ2FwIGJsb2NrIjogIuyiheuLqCDruJTroZ0iLAogICAgIl9BdmFpbGFibGUgZm9yIGFsbCBzcHJpdGVzIjogIuuqqOuToCDsiqTtlITrnbzsnbTtirjsl5DshJwg7IKs7JqpIOqwgOuKpSIsCiAgICAiX1NlbGVjdCBhIERyb3Bkb3duIjogIuuTnOuhreuLpOyatCDshKDtg50iCiAgfSwKICAicHQiOiB7CiAgICAiX015IEJsb2NrcysiOiAiTWV1cyBCbG9jb3MrIiwKICAgICJfTWFrZSBhIEJsb2NrKyI6ICJDcmlhciB1bSBCbG9jbysiLAogICAgIl9zZXQgW1BBUkFNXSB0byBbVkFMVUVdIjogImRlZmluaXIgW1BBUkFNXSBwYXJhIFtWQUxVRV0iLAogICAgIl92YWx1ZSI6ICJ2YWxvciIsCiAgICAiX2dldCBbUEFSQU1dIjogIm9idGVyIFtQQVJBTV0iLAogICAgIl9wYXJhbWV0ZXIgbmFtZSI6ICJub21lIGRvIHBhcsOibWV0cm8iLAogICAgIl9zdGFydCBicmFuY2ggW0lOREVYXSBbSUNPTl0iOiAiaW5pY2lhciByYW1vIFtJTkRFWF0gW0lDT05dIiwKICAgICJfc3RvcCBjYWxsZXIgc2NyaXB0IjogInBhcmFyIHNjcmlwdCBjaGFtYWRvciIsCiAgICAiX251bWJlciBvciB0ZXh0IjogIm7Dum1lcm8gb3UgdGV4dG8iLAogICAgIl9udW1iZXIiOiAibsO6bWVybyIsCiAgICAiX2Jvb2xlYW4iOiAiYm9vbGVhbm8iLAogICAgIl9hbmdsZSI6ICLDom5ndWxvIiwKICAgICJfY29sb3IiOiAiY29yIiwKICAgICJfbm90ZSI6ICJub3RhIiwKICAgICJfbWF0cml4IjogIm1hdHJpeiIsCiAgICAiX2VtcHR5IjogInZhemlvIiwKICAgICJfZHJvcGRvd24iOiAibWVudSBzdXNwZW5zbyIsCiAgICAiX2JyYW5jaCI6ICJyYW1vIiwKICAgICJfQWRkIGEgbGFiZWwiOiAiQWRpY2lvbmFyIHVtIHLDs3R1bG8iLAogICAgIl90ZXh0IjogInRleHRvIiwKICAgICJfaW1hZ2UiOiAiaW1hZ2VtIiwKICAgICJfQ2FwIGJsb2NrIjogIkJsb2NvIHRlcm1pbmFsIiwKICAgICJfQXZhaWxhYmxlIGZvciBhbGwgc3ByaXRlcyI6ICJEaXNwb27DrXZlbCBwYXJhIHRvZG9zIG9zIGF0b3JlcyIsCiAgICAiX1NlbGVjdCBhIERyb3Bkb3duIjogIlNlbGVjaW9uYXIgdW0gbWVudSBzdXNwZW5zbyIKICB9LAogICJydSI6IHsKICAgICJfTXkgQmxvY2tzKyI6ICLQnNC+0Lgg0JHQu9C+0LrQuCsiLAogICAgIl9NYWtlIGEgQmxvY2srIjogItCh0L7Qt9C00LDRgtGMINCR0LvQvtC6KyIsCiAgICAiX3NldCBbUEFSQU1dIHRvIFtWQUxVRV0iOiAi0YPRgdGC0LDQvdC+0LLQuNGC0YwgW1BBUkFNXSDQsiBbVkFMVUVdIiwKICAgICJfdmFsdWUiOiAi0LfQvdCw0YfQtdC90LjQtSIsCiAgICAiX2dldCBbUEFSQU1dIjogItC/0L7Qu9GD0YfQuNGC0YwgW1BBUkFNXSIsCiAgICAiX3BhcmFtZXRlciBuYW1lIjogItC40LzRjyDQv9Cw0YDQsNC80LXRgtGA0LAiLAogICAgIl9zdGFydCBicmFuY2ggW0lOREVYXSBbSUNPTl0iOiAi0L3QsNGH0LDRgtGMINCy0LXRgtCy0YwgW0lOREVYXSBbSUNPTl0iLAogICAgIl9zdG9wIGNhbGxlciBzY3JpcHQiOiAi0L7RgdGC0LDQvdC+0LLQuNGC0Ywg0LLRi9C30YvQstCw0Y7RidC40Lkg0YHQutGA0LjQv9GCIiwKICAgICJfbnVtYmVyIG9yIHRleHQiOiAi0YfQuNGB0LvQviDQuNC70Lgg0YLQtdC60YHRgiIsCiAgICAiX251bWJlciI6ICLRh9C40YHQu9C+IiwKICAgICJfYm9vbGVhbiI6ICLQu9C+0LPQuNGH0LXRgdC60L7QtSDQt9C90LDRh9C10L3QuNC1IiwKICAgICJfYW5nbGUiOiAi0YPQs9C+0LsiLAogICAgIl9jb2xvciI6ICLRhtCy0LXRgiIsCiAgICAiX25vdGUiOiAi0L3QvtGC0LAiLAogICAgIl9tYXRyaXgiOiAi0LzQsNGC0YDQuNGG0LAiLAogICAgIl9lbXB0eSI6ICLQv9GD0YHRgtC+IiwKICAgICJfZHJvcGRvd24iOiAi0LLRi9C/0LDQtNCw0Y7RidC40Lkg0YHQv9C40YHQvtC6IiwKICAgICJfYnJhbmNoIjogItCy0LXRgtCy0YwiLAogICAgIl9BZGQgYSBsYWJlbCI6ICLQlNC+0LHQsNCy0LjRgtGMINC80LXRgtC60YMiLAogICAgIl90ZXh0IjogItGC0LXQutGB0YIiLAogICAgIl9pbWFnZSI6ICLQuNC30L7QsdGA0LDQttC10L3QuNC1IiwKICAgICJfQ2FwIGJsb2NrIjogItCa0L7QvdC10YfQvdGL0Lkg0LHQu9C+0LoiLAogICAgIl9BdmFpbGFibGUgZm9yIGFsbCBzcHJpdGVzIjogItCU0L7RgdGC0YPQv9C90L4g0LTQu9GPINCy0YHQtdGFINGB0L/RgNCw0LnRgtC+0LIiLAogICAgIl9TZWxlY3QgYSBEcm9wZG93biI6ICLQktGL0LHRgNCw0YLRjCDQstGL0L/QsNC00LDRjtGJ0LjQuSDRgdC/0LjRgdC+0LoiCiAgfQp9KTsKCihmdW5jdGlvbihTY3JhdGNoKSB7CiAgInVzZSBzdHJpY3QiOwogIGlmICghU2NyYXRjaC5leHRlbnNpb25zLnVuc2FuZGJveGVkKSB0aHJvdyBuZXcgRXJyb3IoIk15IEJsb2NrcysgbXVzdCBydW4gdW5zYW5kYm94ZWQhIik7CgogIGNvbnN0IG1lbnVJY29uVVJJID0KICAgICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSTBOeTQ1TkRnaUlHaGxhV2RvZEQwaU5EY3VPVFE0SWlCMmFXVjNRbTk0UFNJd0lEQWdORGN1T1RRNElEUTNMamswT0NJK1BIQmhkR2dnWkQwaVRUQWdNak11T1RjMFF6QWdNVEF1TnpNMElERXdMamN6TXlBd0lESXpMamszTkNBd2N6SXpMamszTkNBeE1DNDNNek1nTWpNdU9UYzBJREl6TGprM05DMHhNQzQzTXpNZ01qTXVPVGMwTFRJekxqazNOQ0F5TXk0NU56UlRNQ0F6Tnk0eU1UVWdNQ0F5TXk0NU56UWlJR1pwYkd3OUlpTmpZelV5TmpZaUx6NDhjR0YwYUNCa1BTSk5NaTR5TVRFZ01qTXVPVGMwWXpBdE1USXVNRElnT1M0M05EUXRNakV1TnpZeklESXhMamMyTXkweU1TNDNOak56TWpFdU56WXpJRGt1TnpRMElESXhMamMyTXlBeU1TNDNOak10T1M0M05EUWdNakV1TnpZekxUSXhMamMyTXlBeU1TNDNOak5UTWk0eU1URWdNelV1T1RreklESXVNakV4SURJekxqazNOQ0lnWm1sc2JEMGlJMlptTmpZNE1DSXZQanh3WVhSb0lHUTlJazB6T1M0eE5USWdNVFF1TkRVMWRqRTVMakF6T0dFeExqRXlJREV1TVRJZ01DQXdJREV0TGpZMUlERXVNREU1YkMweE5DNDFOVGdnTmk0M01UbGhNUzR4TWlBeExqRXlJREFnTUNBeExTNDVOQ0F3YkMweE5DNDFOVGd0Tmk0M01tRXhMakV5SURFdU1USWdNQ0F3SURFdExqWTFMVEV1TURFNFZqRTBMalExTkdFeExqRXlJREV1TVRJZ01DQXdJREVnTGpZMUxURXVNREU1YkRFMExqVTFPQzAyTGpjeE9XRXhMakV5SURFdU1USWdNQ0F3SURFZ0xqazBJREJzTVRRdU5UVTRJRFl1TnpKakxqTTVOeTR4T0RNdU5qVXhMalU0TGpZMUlERXVNREU0YlMweU55NDFOaUF3SURFeExqZzRNaUExTGpRNE9DQXhNUzQ0T0RJdE5TNDBPRGd0TVRFdU9EZ3lMVFV1TkRnM2VtMHRNUzQxTlRZZ01UZ3VNekl4SURFeUxqTXhPQ0ExTGpZNE9WWXlNUzQ0T1d3dE1USXVNekU0TFRVdU5qZzVlbTB5Tmk0NE56WWdNRll4Tmk0eU1ERnNMVEV5TGpNeE9DQTFMalk1ZGpFMkxqVTNNM29pSUdacGJHdzlJaU5tWm1ZaUx6NDhjR0YwYUNCa1BTSk5Nekl1TXpRMklETTJMakUyT1hZdE1pNDJOemhvTFRJdU5qYzRZeTB4TGpNMk5TQXdMVEl1TkRjeUxTNDVOVE10TWk0ME56SXRNaTR4TWpoek1TNHhNRGN0TWk0eE1qZ2dNaTQwTnpJdE1pNHhNamhvTWk0Mk56aDJMVEl1TmpjNFl6QXRNUzR6TmpVdU9UVXpMVEl1TkRjeUlESXVNVEk0TFRJdU5EY3ljekl1TVRJNElERXVNVEEzSURJdU1USTRJREl1TkRjeWRqSXVOamM0YURJdU5qYzRZekV1TXpZMUlEQWdNaTQwTnpJdU9UVXlJREl1TkRjeUlESXVNVEk0SURBZ01TNHhOelV0TVM0eE1EY2dNaTR4TWpndE1pNDBOeklnTWk0eE1qaG9MVEl1TmpjNGRqSXVOamM0WXpBZ01TNHpOalV0TGprMU15QXlMalEzTWkweUxqRXlPQ0F5TGpRM01uTXRNaTR4TWpndE1TNHhNRGN0TWk0eE1qZ3RNaTQwTnpKNklpQm1hV3hzUFNKdWIyNWxJaUJ6ZEhKdmEyVTlJaU5tWmpZMk9EQWlJSE4wY205clpTMTNhV1IwYUQwaU5DSXZQanh3WVhSb0lHUTlJazB6TWk0ek5EWWdNell1TVRZNWRpMHlMalkzT0dndE1pNDJOemhqTFRFdU16WTFJREF0TWk0ME56SXRMamsxTXkweUxqUTNNaTB5TGpFeU9ITXhMakV3TnkweUxqRXlPU0F5TGpRM01pMHlMakV5T1dneUxqWTNPSFl0TWk0Mk56ZGpNQzB4TGpNMk5TNDVOVE10TWk0ME56SWdNaTR4TWpndE1pNDBOekp6TWk0eE1qZ2dNUzR4TURjZ01pNHhNamdnTWk0ME56SjJNaTQyTnpkb01pNDJOemhqTVM0ek5qVWdNQ0F5TGpRM01pNDVOVE1nTWk0ME56SWdNaTR4TWprZ01DQXhMakUzTlMweExqRXdOeUF5TGpFeU9DMHlMalEzTWlBeUxqRXlPR2d0TWk0Mk56aDJNaTQyTnpoak1DQXhMak0yTlMwdU9UVXlJREl1TkRjeUxUSXVNVEk0SURJdU5EY3lMVEV1TVRjMUlEQXRNaTR4TWpndE1TNHhNRGN0TWk0eE1qZ3RNaTQwTnpJaUlHWnBiR3c5SWlObVptWWlMejQ4TDNOMlp6ND0iOwoKICBjb25zdCBndWlVUklzID0gKG5hbWUpID0+IHsKICAgIGNvbnN0IHN0YXJ0ID0gImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIZHBaSFJvUFNJIjsKICAgIHJldHVybiBzdGFydCArIHsKICAgICAgImRyb3Bkd24iOiAiMU55SWdhR1ZwWjJoMFBTSTBPU0lnZG1sbGQwSnZlRDBpTUNBd0lEVTNJRFE1SWo0OFp5QnpkSEp2YTJVdGJXbDBaWEpzYVcxcGREMGlNVEFpUGp4d1lYUm9JR1E5SWswMExqVWdORGd1TldFMElEUWdNQ0F3SURFdE5DMDBkaTAwTUdFMElEUWdNQ0F3SURFZ05DMDBhRFE0WVRRZ05DQXdJREFnTVNBMElEUjJOREJoTkNBMElEQWdNQ0F4TFRRZ05Ib2lJR1pwYkd3OUlpTm1aalkyT0RBaUlITjBjbTlyWlQwaUkyWXpOU0l2UGp4d1lYUm9JR1E5SWsweE1pNHhNak1nTXprdU9ETmpMVEV1TlRBM0lEQXRNaTQzTXkweExqRTBOQzB5TGpjekxUSXVOVFUxZGkweU5TNDFOV013TFRFdU5ERXhJREV1TWpJekxUSXVOVFUxSURJdU56TXRNaTQxTlRWb016SXVOelUwWXpFdU5UQTNJREFnTWk0M015QXhMakUwTkNBeUxqY3pJREl1TlRVMWRqSTFMalUxWXpBZ01TNDBNVEV0TVM0eU1qTWdNaTQxTlRVdE1pNDNNeUF5TGpVMU5Yb2lJR1pwYkd3OUlpTm1aalJrTm1FaUlITjBjbTlyWlQwaUkyWXpOU0l2UGp4d1lYUm9JR1E5SWswek5pNHdPRFFnTWpJdU1UWTNZVEl1T0RnZ01pNDRPQ0F3SURBZ01TMHVPRFE0SURJdU1EVXpiQzAwTGpZM055QTBMalkzTjJFeUxqa3lOQ0F5TGpreU5DQXdJREFnTVMwMExqRXhPQ0F3YkMwMExqWTJOUzAwTGpZM04yRXlMamtnTWk0NUlEQWdNQ0F4TFM0NE5pMHlMakExTXlBeUxqazJJREl1T1RZZ01DQXdJREVnTGpnME9DMHlMakEyTkdNdU16UTJMUzR5T0RjdU9EVTVMUzQ0TkRnZ05pNDNOREl0TGpnME9ITTJMalF6TWk0MU5TQTJMamN6TGpnME9HTXVOVFEyTGpVME9DNDROU0F4TGpJNUxqZzBPQ0F5TGpBMk5DSWdabWxzYkQwaUkyWXpOU0l2UGp4d1lYUm9JR1E5SWsweU9DNDFNRFlnTWpndU5UVXhZVEV1TnlBeExqY2dNQ0F3SURFdE1TNHhPVE10TGpWc0xUUXVOekF5TFRRdU5qYzVZVEV1TnpJZ01TNDNNaUF3SURBZ01TQXdMVEl1TXpnMll5NDJOamd0TGpZMk9TQXhNUzR4TVMwdU5qWTVJREV4TGpjM09DQXdJQzQyTkRNdU5qWTFMalkwTXlBeExqY3lJREFnTWk0ek9EWnNMVFF1TmpjNElEUXVOamM0WXkwdU16SXVNekl0TGpjMU15NDFMVEV1TWpBMUxqVXdNU0lnWm1sc2JEMGlJMlptWmlJdlBqd3ZaejQ4TDNOMlp6ND0iLAogICAgICAiY29sb3JQa3IiOiAieU1DSWdhR1ZwWjJoMFBTSXlNQ0lnZG1sbGQwSnZlRDBpTFRJZ0xUTWdNakFnTWpBaVBqeHdZWFJvSUdROUlrMHhNUzR3TmpRZ05TNDFOaklnT1M0ME1Ea2dNeTQ1TURoc0xUTXVPVFFnTXk0NU1tTXRMakV5TGpFek55MHVNakExTGpJM05DMHVNalF1TkRFdExqRTROeTQ0TlRJdExqZ3hPQ0F4TGpVdE1TNDFNVGNnTVM0M01qSmhNU0F4SURBZ01DQXdMUzQxT0M0MU1URnNMUzQ0TXpZZ01TNDNPV010TGpBMU1TNHhNaTB1TURVeExqRTRPQzB1TURVeExqSXdOV3d1TWpjekxqSTFOV0V1Tmk0MklEQWdNQ0F3SUM0eE9EY3RMakExYkRFdU56YzBMUzQ0TXpaakxqSTBMUzR4TWk0ME5pMHVNelU0TGpVekxTNDFPQzR5TURRdExqWTVPUzQ0TnkweExqTXpJREV1TlRZNExURXVORGd6TGpJM015MHVNRFk0TGpReU55MHVNVFV6TGpVME5pMHVNamw2YlRJdU1ETXRNUzQzT1M0eE16WXVNVE0yTGpVNExqVTRZUzQ0T0RRdU9EZzBJREFnTUNBeElEQWdNUzR5TkRSc0xTNDJOalV1TmpRNFlTNDRORGN1T0RRM0lEQWdNQ0F4TFRFdU1UWXVNRFk0YkMwekxqazFPQ0F6TGprek9HRXlMakEzSURJdU1EY2dNQ0F3SURFdE1TNHdNRFl1TlRrM1l5MHVOREV1TURnMUxTNDNNVFl1TXpjMUxTNDNPRFV1TmpRM0xTNHhOeTQxTmpNdExqWTBPQ0F4TGpBNU1TMHhMakl4SURFdU16WTBiQzB4TGpjNU1pNDRNelpqTFM0eU16a3VNVEF5TFM0ME9UVXVNVGN0TGpjeE5pNHhOMkV4TGpJZ01TNHlJREFnTUNBeExTNDROeTB1TXpSc0xTNHpOREV0TGpNME1tTXRMak0zTmkwdU16a3lMUzQwTkRRdE1TNHdNRFl0TGpFM01TMHhMall3TW13dU9ETTJMVEV1Tnpjell5NHlOVFl0TGpVMk15NDRNREl0TVM0d05DQXhMak0yTkMweExqSXhMakkzTXkwdU1EZzJMalUyTXkwdU16YzJMall4TlMwdU5qTXhMakV4T1MwdU5URXlMak15TkMwdU9EY3VOakUwTFRFdU1UYzNiRE11T1RVM0xUTXVPVE0zWXkwdU1qa3RMak0wTVMwdU1qY3pMUzQ0TXpZdU1EVXhMVEV1TVRjM2JDNDJOalV0TGpZME9HRXVPRGcyTGpnNE5pQXdJREFnTVNBeExqSTBOaUF3YkM0MU5EWXVOVFEyTGpFM0xqRTNUREV5TGpZNE5DNHpPVFpoTVM0ek15QXhMak16SURBZ01DQXhJREV1T0RrMElEQmpMakkxTmk0eU5UWXVNemt5TGpVNU55NHpPVEl1T1RNNGN5MHVNVE0yTGpZNU9TMHVNemt5TGprMU5Yb2lJR1pwYkd3OUltNXZibVVpSUhOMGNtOXJaUzF2Y0dGamFYUjVQU0l1TWpVaUlITjBjbTlyWlQwaUl6QXdNQ0lnYzNSeWIydGxMWGRwWkhSb1BTSXpJaTgrUEhCaGRHZ2daRDBpVFRFeExqQTJOQ0ExTGpVMk1pQTVMalF3T1NBekxqa3dPR3d0TXk0NU5DQXpMamt5WXkwdU1USXVNVE0zTFM0eU1EVXVNamMwTFM0eU5DNDBNUzB1TVRnM0xqZzFNaTB1T0RFNElERXVOUzB4TGpVeE55QXhMamN5TW1FeElERWdNQ0F3SURBdExqVTRMalV4TVd3dExqZ3pOaUF4TGpjNVl5MHVNRFV4TGpFeUxTNHdOVEV1TVRnNExTNHdOVEV1TWpBMWJDNHlOek11TWpVMVlTNDJMallnTUNBd0lEQWdMakU0TnkwdU1EVnNNUzQzTnpRdExqZ3pObU11TWpRdExqRXlMalEyTFM0ek5UZ3VOVE10TGpVNExqSXdOQzB1TmprNUxqZzNMVEV1TXpNZ01TNDFOamt0TVM0ME9ETXVNamN5TFM0d05qZ3VOREkyTFM0eE5UTXVOVFExTFM0eU9YcHRNaTR3TXkweExqYzVMakV6Tmk0eE16WXVOVGd1TlRoaExqZzROQzQ0T0RRZ01DQXdJREVnTUNBeExqSTBOR3d0TGpZMk5TNDJORGhoTGpnME55NDRORGNnTUNBd0lERXRNUzR4Tmk0d05qaHNMVE11T1RVNElETXVPVE00WVRJdU1EY2dNaTR3TnlBd0lEQWdNUzB4TGpBd05pNDFPVGRqTFM0ME1TNHdPRFV0TGpjeE5pNHpOelV0TGpjNE5TNDJORGN0TGpFM0xqVTJNeTB1TmpRNElERXVNRGt4TFRFdU1qRWdNUzR6TmpSc0xURXVOemt5TGpnek5tTXRMakl6T1M0eE1ESXRMalE1TlM0eE55MHVOekUyTGpFM1lURXVNaUF4TGpJZ01DQXdJREV0TGpnM0xTNHpOREZzTFM0ek5ERXRMak0wWXkwdU16YzJMUzR6T1RNdExqUTBOQzB4TGpBd055MHVNVGN4TFRFdU5qQXpiQzQ0TXpZdE1TNDNOek5qTGpJMU5pMHVOVFl6TGpnd01pMHhMakEwSURFdU16WTBMVEV1TWpFdU1qY3pMUzR3T0RZdU5UWXpMUzR6TnpZdU5qRTFMUzQyTXpFdU1URTVMUzQxTVRJdU16STBMUzQ0Tnk0Mk1UUXRNUzR4Tnpkc015NDVOVGN0TXk0NU16aGpMUzR5T1MwdU16UXRMakkzTXkwdU9ETTFMakExTVMweExqRTNObXd1TmpZMkxTNDJORGhoTGpnNE5pNDRPRFlnTUNBd0lERWdNUzR5TkRVZ01Hd3VOVFEyTGpVME5pNHhOeTR4TjB3eE1pNDJPRFF1TXprMllURXVNek1nTVM0ek15QXdJREFnTVNBeExqZzVOQ0F3WXk0eU5UWXVNalUyTGpNNU1pNDFPVGN1TXpreUxqa3pPSE10TGpFek5pNDJPVGt0TGpNNU1pNDVOVFY2SWlCbWFXeHNQU0lqWm1abUlpOCtQQzl6ZG1jKyIsCiAgICAgICJicmFuY2hTdGFydCI6ICJ5TUM0ek9Ua2lJR2hsYVdkb2REMGlNakV1TkRJeUlpQjJhV1YzUW05NFBTSXdJREFnTWpBdU16azVJREl4TGpReU1pSStQSEJoZEdnZ1pEMGlUVEV6TGpZMUlERTJMamMwTm1NdExqWTFOUzB1TWpndE1TMHVPUzB4TFRFdU5YWXRNUzQyWXkweExqTXRMakV0TWk0MUxTNDFMVE11TmkweExqRnNMUzR4TkRZdExqQTNPR011TURVMExqWTBOaTR3T0RjZ01TNHdPQzR3T1RZZ01TNHlNRFJvTVM0Mll5NDJJREFnTVM0eU1UZ3VNelFnTVM0MUlERnpMakE1TmlBeExqRTROaTB1TXlBeExqaGpMUzR3TmpNdU1EazRMVFF1TlNBMExqVXROQzQxSURRdU5TMHVOeTQyTFRFdU55NDJMVEl1TkNBd2JDMDBMalF0TkM0MFl5MHVNeTB1TXkwdU5TMHVPQzB1TlMweExqSWdNQzB4SUM0NExURXVOeUF4TGpjdE1TNDNhREV1TldNd0xTNHhPRE11TWpVNExUTXVPVGd6TGpRNExUY3VOREUyTGpFeU15MHhMamt3T0M0eU16VXRNeTQzTnpJdU1qZzFMVFF1TnpZNUxqQXhNeTB1TURZMkxqQXpMUzR5TURFdU1EVXlMUzR5TmpRdU1UWTBMUzQzTURZdU9ESXlMVEV1TWpFZ01TNDJOeTB4TGpJeExqZzRMUzR4TWpJZ01TNDRPREV1TmpFMElERXVPU0F4TGpZMGNTNHdNakl1TURReUxqQXlPQzR3TmpWakxqRTJOUzQ0TlRZdU16SWdNUzQ0TlRNdU5EWXlJREl1T1M0eU55NDFNRGN1TmpRNExqazRNeTQ1T0RFZ01TNDBNamd1T0NBeExqRWdNaTR4T1RFZ01TNDRJRE11TlRreElERXVPSFl0TVM0MVl6QXRMamt1TnkweExqY2dNUzQzTFRFdU55NDBJREFnTGprdU1pQXhMakl1Tld3MExqUWdOQzQwWXk0MkxqY3VOaUF4TGpjZ01DQXlMalJzTFRRdU5TQTBMalZ6TFRFdU1UUTFMalU0TFRFdU9DNHpJaUJtYVd4c0xXOXdZV05wZEhrOUlpNHlJaTgrUEhCaGRHZ2daRDBpVFRRdU5qWTVJREl1TURjNVF6UXVOVGcxSURFdU5EZ3lJRFV1TURrM0xqa3dOU0ExTGpnd055NDVNRFpqTGpVNU5pMHVNRGcwSURFdU1qYzJMalF5T0NBeExqSTNOU0F4TGpFek9DQXdJQzR3TVRNdU1URTBJREV1TURZM0xqSTJJREl1TlRnellUY2dOeUF3SURBZ01DQXVPVEkxSURFdU56Y3hZeTQyTGprZ01TNDFPVElnTVM0MklESXVOamt5SURJZ0xqa3VNeUF4TGpndU5DQXlMamd1TW5ZdE1pNDBZekF0TGpRdU15MHVOeTQzTFM0M0xqSWdNQ0F1TXk0eExqUXVNbXcwTGpRZ05DNDBZeTR6TGpNdU15NDNJREFnTGpsc0xUUXVOQ0EwTGpSakxTNHpMak10TGpRMU9DNDBNekV0TGpnek1pNHpOamx6TFM0ek5qZ3RMalUyT1MwdU16WTRMUzQxTmpsMkxUSXVObU10TVM0MUlEQXRNaTQ1TFM0ekxUUXVNaTB4WVRndU15QTRMak1nTUNBd0lERXRNUzQxTnkweExqQXlOR011TVRVeElESXVNVGc0TGpJMU5DQXpMamc0TWk0eU5UUWdOQzR4TkRob01pNDJjeTQwTmpJdU1EYzJMalV1TXlBd0lDNDJMUzR6TGpsc0xUUXVOQ0EwTGpSakxTNHlMak10TGpZdU15MHVPU0F3YkMwMExqUXROQzQwWXkwdU1TMHVNUzB1TWkwdU1pMHVNaTB1TkNBd0xTNDBMak10TGpjdU55MHVOMmd5TGpNNU9HTXVNRFUwTFRFdU5UazNMakUwTlMwMExqSXlMakl6T1MwMkxqWTJOQzR3TWkwdU5Ua3VNRFF4TFRFdU1UZzJMakEyTXkweExqYzNObkV1TURBekxTNHdPVGt1TURFMUxTNHhPVEpqTGpBMUxURXVNVGd6TGpJeExUUXVNVEV4TGpJeExUUXVNVEV4SWlCbWFXeHNQU0lqWm1abUlpOCtQQzl6ZG1jKyIsCiAgICAgICJhZGRJbWciOiAieU1DSWdhR1ZwWjJoMFBTSXlNQ0lnZG1sbGQwSnZlRDBpTUNBd0lESXdJREl3SWo0OFp5Qm1hV3hzUFNKdWIyNWxJaUJtYVd4c0xYSjFiR1U5SW1WMlpXNXZaR1FpUGp4bklITjBjbTlyWlQwaUkwWkdSaUlnYzNSeWIydGxMV3hwYm1WallYQTlJbkp2ZFc1a0lpQnpkSEp2YTJVdGQybGtkR2c5SWpFdU5TSStQSEJoZEdnZ1pEMGliVEUyTGpFME5DQXhNaTQzT0MweUxqUTFPQzB5TGpVek1XRXVPVGN1T1RjZ01DQXdJREF0TVM0ek5EY3RMakEyVERrdU1qazFJREV5TGpZMll5MHVORFk1TGpNMk1pMHhMakV4TXk0ek1ESXRNUzQwTmpRdExqRTRiQzB1TWprekxTNHpOak5qTFM0ek5TMHVORGd5TFRFdU1EVXpMUzQxTkRNdE1TNDBOak10TGpFNFRETXVPRFVnTVRNdU9EQTFhREJqTUNBdU9EVXlMalk1SURFdU5UUXpJREV1TlRReklERXVOVFF6YURndU9ERmhNaUF5SURBZ01DQXdJREl0TW5ZdExqVTJPSG9pSUdacGJHdzlJaU5HUmtZaUlITjBjbTlyWlMxc2FXNWxhbTlwYmowaWNtOTFibVFpTHo0OGNHRjBhQ0JrUFNKTk1UWXVNakF6SURndU1UaDJOUzR5T1RSak1DQXVPVGMwTFM0M09TQXhMamMyTkMweExqYzJOU0F4TGpjMk5FZzFMall4TldNdExqazNOU0F3TFRFdU56WTFMUzQzT1MweExqYzJOUzB4TGpjMk5IWXROeTR3Tm1Nd0xTNDVOelF1TnprdE1TNDNOalFnTVM0M05qVXRNUzQzTmpSb055NHdOVGtpTHo0OEwyYytQSEJoZEdnZ1pEMGlUVEUyTGpnNU55QXpMams0TldndU5qWXlZUzQyTmpJdU5qWXlJREFnTVNBeElEQWdNUzR6TWpSb0xTNDJOakoyTGpZMk1tRXVOall5TGpZMk1pQXdJREVnTVMweExqTXlNeUF3ZGkwdU5qWXlhQzB1TmpZeVlTNDJOakl1TmpZeUlEQWdNQ0F4SURBdE1TNHpNalJvTGpZMk1uWXRMalkyTVdFdU5qWXlMalkyTWlBd0lEQWdNU0F4TGpNeU15QXdlaUlnWm1sc2JEMGlJMFpHUmlJdlBqeHdZWFJvSUhOMGNtOXJaVDBpSTBaR1JpSWdjM1J5YjJ0bExYZHBaSFJvUFNJdU1pSWdaRDBpVFRFMkxqazBOeUF6TGprek5XZ3VOakV5WVM0M01USXVOekV5SURBZ01TQXhJREFnTVM0ME1qUnNMUzQyTVRJdExqQTFkaTQyTmpKaExqY3hNaTQzTVRJZ01DQXhJREV0TVM0ME1qTWdNR3d1TURVdExqWXhNbWd0TGpZMk1tRXVOekV5TGpjeE1pQXdJREVnTVNBd0xURXVOREkwYkM0Mk1USXVNRFYyTFM0Mk5qRmhMamN4TWk0M01USWdNQ0F4SURFZ01TNDBNak1nTUhvaUx6NDhMMmMrUEM5emRtYysiCiAgICB9W25hbWVdOwogIH07CiAgY29uc3QgaW5wdXRVUklzID0gKG5hbWUpID0+IHsKICAgIGxldCBzdGFydCA9ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJaiI7CiAgICBpZiAobmFtZSA9PT0gImJyYyIpIHJldHVybiBzdGFydCArICJJeE1TNDFJREUxTlM0MUlEVTNJRFE1SWo0OGNHRjBhQ0JrUFNKTk1qRTJJREl3TkdFMElEUWdNQ0F3SURFdE5DMDBkaTAwTUdFMElEUWdNQ0F3SURFZ05DMDBiRFE0TGpZMU1TNHdOVE5CTkNBMElEQWdNQ0F4SURJMk9DQXhOakIyT0M0eE1qaGpNQ0F4TGpNdE1pNHhPRFFnTXk0ek9ETXRNeTQ0TnpjZ015NHpPRE5vTFRFekxqazRNbU10TVM0eE1EVWdNQzB4TGpZMU55NDFOVEl0TWk0eU1TQXhMakV3Tld3dE1pNHlNRGtnTWk0eU1EbGpMUzQxTlRJdU5UVXlMVEV1TVRBMUlERXVNVEExTFRJdU1qRWdNUzR4TURWb0xUWXVOakkzWXkweExqRXdOU0F3TFRFdU5qVTNMUzQxTlRNdE1pNHlNUzB4TGpFd05Xd3RNaTR5TURrdE1pNHlNV010TGpVMU1pMHVOVFV5TFRFdU1UQTFMVEV1TVRBMExUSXVNakV0TVM0eE1EUm9MVFF1TkRFNFl5MHhMakl5SURBdE1pNHlNUzQ1T1MweUxqSXhJREl1TWpGMk1USXVOVFUwWXpBZ01TNHlNaTQ1T1NBeUxqSXdPQ0F5TGpJeElESXVNakE0YURRdU5ERTVZekV1TVRBMElEQWdNUzQyTlRjdU5UVXpJREl1TWpFZ01TNHhNRFZzTWk0eU1EZ2dNaTR5TVdNdU5UVXpMalUxTWlBeExqRXdOU0F4TGpFd05DQXlMakl4SURFdU1UQTBhRFl1TmpJNFl6RXVNVEEwSURBZ01TNDJOVGN0TGpVMU1pQXlMakl3T1MweExqRXdOV3d5TGpJeExUSXVNakE1WXk0MU5USXRMalUxTWlBeExqRXdOQzB4TGpFd05TQXlMakl3T1MweExqRXdOV2d4TXk0NU9ESmpNUzQyT1RNZ01DQXpMamczTnlBeUxqRXdOQ0F6TGpnM055QXpMalV3TWxZeU1EQmhOQ0EwSURBZ01DQXhMVFFnTkhvaUlITjBlV3hsUFNKbWFXeHNPaU5tWmpZMk9EQTdjM1J5YjJ0bE9pTm1NelVpTHo0OEwzTjJaejQ9IjsKICAgIGVsc2UgaWYgKG5hbWUgPT09ICJpbWciKSByZXR1cm4gc3RhcnQgKyAiQWdNQ0ExTnlBME9TSStQSEJoZEdnZ1pEMGlUVFF1TlNBME9DNDFZVFFnTkNBd0lEQWdNUzAwTFRSMkxUUXdZVFFnTkNBd0lEQWdNU0EwTFRSb05EaGhOQ0EwSURBZ01DQXhJRFFnTkhZME1HRTBJRFFnTUNBd0lERXROQ0EwZWlJZ1ptbHNiRDBpSTJabU5qWTRNQ0lnYzNSeWIydGxQU0lqWmpNMUlpOCtQSEJoZEdnZ1pEMGlUVE01TGpNeUlERTJMak0wTW5ZeE1DNDBNalJqTUNBdU5EVXpMUzR4TVRNdU56a3pMUzQwTlRNZ01TNHdNaTB6TGpFM01pQXlMall3TmkwM0xqZ3hPQ0F5TGpZd05pMHhNUzR4TURNZ01HRTJMakUxSURZdU1UVWdNQ0F3SURBdE15NDROVE10TVM0ek5tTXRNUzQwTnpNdU1URXpMVEl1TnpFNUxqWTRMVE11T0RVeUlERXVORGN6ZGpjdU1qVXhZekFnTGpVMk55MHVOVFkzSURFdU1UTXpMVEV1TVRNeklERXVNVE16YUMwdU1URXpZeTB1TlRZM0lEQXRNUzR4TXpNdExqVTJOaTB4TGpFek15MHhMakV6TTNZdE1qRXVNMk13TFM0Mk9DNDFOall0TVM0eE16UWdNUzR4TXpNdE1TNHhNelF1TlRZMklEQWdNUzR4TXpNdU5EVTBJREV1TVRNeklERXVNVE0wZGk0ME5UTmpNeTR3TlRrdE1TNDBOek1nTmk0M09UZ3RNUzR3TWlBNUxqUXdOQ0F4TGpFek0yRTJMakUwSURZdU1UUWdNQ0F3SURBZ055NDNNRFFnTUdNdU16UXRMak0wTGprd055MHVORFV6SURFdU16WXRMakl5Tnk0MU5qWXVNVEV6TGprd05pNDFOamN1T1RBMklERXVNVE16YlMweExqRXpNeUF3TFM0eE1UTXRMakV4TTJndExqSXlOMk10TWk0M01Ua2dNaTR4TlRNdE5pNDBOVGdnTWk0eE5UTXRPUzR4TnpjZ01DMHlMalE1TXkweExqa3lOaTAxTGpnNU1pMHlMakkyTmkwNExqY3lOQzB1TmpoMk1UQXVPVGxqTVM0eU5EWXRMalk0SURJdU5Ea3lMVEV1TVRNeklETXVPRFV5TFRFdU1qUTJJREV1TnlBd0lETXVNamcyTGpVMk55QTBMalV6TWlBeExqVTRObUUzTGpZNE5TQTNMalk0TlNBd0lEQWdNQ0E1TGpjME5DMHVNVEV6ZWlJZ1ptbHNiRDBpSXpRMU9Ua3paQ0l2UGp4d1lYUm9JR1E5SW0wek9DNHhPRGNnTVRZdU5EVTFMUzR4TVRNZ01UQXVNekV4ZGk0eE1UTmpMVEl1T0RNeUlESXVNalkyTFRZdU9URXhJREl1TWpZMkxUa3VOelEwSURBdE1TNHlORFl0TVM0d01pMHlMamd6TXkweExqVTROaTAwTGpVek1pMHhMalU0TmkweExqTTJMakV4TXkweUxqWXdOaTQxTmpjdE15NDROVElnTVM0eU5EWjJMVEV3TGprNVl6SXVPRE15TFRFdU5UZzJJRFl1TWpNeExURXVNalEySURndU56STBMalk0SURJdU56SWdNaTR4TlRNZ05pNDBOVGdnTWk0eE5UTWdPUzR4TnpjZ01HZ3VNakkzWXpBZ0xqRXhNeTR4TVRNdU1URXpMakV4TXk0eU1qWWlJR1pwYkd3OUlpTTBZMkptTlRZaUx6NDhMM04yWno0PSI7CgogICAgc3RhcnQgKz0gIkFnTUNBMU55QTBPU0krUEhKbFkzUWdlRDBpTGpVaUlIazlJaTQxSWlCM2FXUjBhRDBpTlRZaUlHaGxhV2RvZEQwaU5EZ2lJSEo0UFNJMElpQnllVDBpTkNJZ2MzUjViR1U5SW1acGJHdzZJMlptTmpZNE1EdHpkSEp2YTJVdGJXbDBaWEpzYVcxcGREb3hNRHR6ZEhKdmEyVTZJMll6TlNJdlBqeHlaV04wSUhnOUlqZ3VOU0lnZVQwaU9DNDFJaUIzYVdSMGFEMGlOREFpSUdobGFXZG9kRDBpTXpJaUlISjRQU0l4TmlJZ2NuazlJakUySWlCemRIbHNaVDBpYzNSeWIydGxPaU5tIjsKICAgIHJldHVybiBzdGFydCArIHsKICAgICAgIm5vcm0iOiAiTXpVN1ptbHNiRG9qWm1abU8zTjBjbTlyWlMxc2FXNWxZMkZ3T25KdmRXNWtPM04wY205clpTMXNhVzVsYW05cGJqcHliM1Z1WkNJdlBqeDBaWGgwSUhOMGVXeGxQU0ptYjI1MExYTnBlbVU2TVRKd2VEdG1hV3hzT2lNMlpUYzBPRGc3Wm05dWRDMW1ZVzFwYkhrNlNHVnNkbVYwYVdOaFRtVjFaUzFDYjJ4a0xDQklaV3gyWlhScFkyRWdUbVYxWlN3Z2MyRnVjeTF6WlhKcFpqdG1iMjUwTFhkbGFXZG9kRG8zTURBN2JHVjBkR1Z5TFhOd1lXTnBibWM2TUdWdE95SWdkSEpoYm5ObWIzSnRQU0owY21GdWMyeGhkR1VvTVRjdU5TQXlPU2tpUG5SbGVIUThMM1JsZUhRK1BDOXpkbWMrIiwKICAgICAgIm51bSI6ICJNelU3Wm1sc2JEb2pabVptTzNOMGNtOXJaUzFzYVc1bFkyRndPbkp2ZFc1a08zTjBjbTlyWlMxc2FXNWxhbTlwYmpweWIzVnVaQ0l2UGp4MFpYaDBJSE4wZVd4bFBTSm1iMjUwTFhOcGVtVTZNVEp3ZUR0bWFXeHNPaU0yWlRjME9EZzdabTl1ZEMxbVlXMXBiSGs2U0dWc2RtVjBhV05oVG1WMVpTMUNiMnhrTEVobGJIWmxkR2xqWVNCT1pYVmxMSE5oYm5NdGMyVnlhV1k3Wm05dWRDMTNaV2xuYUhRNk56QXdPMnhsZEhSbGNpMXpjR0ZqYVc1bk9qQWlJSFJ5WVc1elptOXliVDBpZEhKaGJuTnNZWFJsS0RJMUlESTVLU0krTUR3dmRHVjRkRDQ4TDNOMlp6ND0iLAogICAgICAiY29sIjogIlptWTdabWxzYkRvak1HWXdPM04wY205clpTMXNhVzVsWTJGd09uSnZkVzVrTzNOMGNtOXJaUzFzYVc1bGFtOXBianB5YjNWdVpDSXZQand2YzNablBnPT0iLAogICAgICAiYW5nIjogIlptWTdabWxzYkRvak5EUTRPR1UyTzNOMGNtOXJaUzFzYVc1bFkyRndPbkp2ZFc1a08zTjBjbTlyWlMxc2FXNWxhbTlwYmpweWIzVnVaQ0l2UGp4d1lYUm9JR1E5SWsweE5pNHhOVFFnTWpRdU5XTXdMVFl1TnpnZ05TNDBPVFl0TVRJdU1qYzJJREV5TGpJM05pMHhNaTR5TnpaVE5EQXVOekExSURFM0xqY3lJRFF3TGpjd05TQXlOQzQxSURNMUxqSXhJRE0yTGpjM05pQXlPQzQwTXlBek5pNDNOellnTVRZdU1UVTBJRE14TGpJNElERTJMakUxTkNBeU5DNDFlaUlnWm1sc2JEMGlJelF5T0RCa055SWdjM1J5YjJ0bFBTSWpNek0zTTJOaklpQnpkSEp2YTJVdGQybGtkR2c5SWk0MUlpOCtQSEJoZEdnZ1pEMGlUVEk0TGpReklESTBMalZXTVRJdU5UQTBZell1TmpJMUlEQWdNVEV1T1RrMklEVXVNemNnTVRFdU9UazJJREV4TGprNU5ub2lJR1pwYkd3dGIzQmhZMmwwZVQwaUxqSWlJR1pwYkd3OUlpTm1abVlpTHo0OGNHRjBhQ0JrUFNKTk1qZ3VORE1nTWpRdU5XZ3hNaTR5TnpVaUlITjBjbTlyWlQwaUkyWm1aaUlnYzNSeWIydGxMWGRwWkhSb1BTSXVOU0lnYzNSeWIydGxMV3hwYm1WallYQTlJbkp2ZFc1a0lpOCtQSEJoZEdnZ1pEMGlUVEk0TGpReklESTBMalZXTVRJdU5EUTRJaUJ6ZEhKdmEyVTlJaU5tWm1ZaUlITjBjbTlyWlMxM2FXUjBhRDBpTGpVaUx6NDhjR0YwYUNCa1BTSk5NemN1TXpFZ01qUXVOV2d4TGpVMk4yMHRMak0xTmlBeUxqY3dOQzB4TGpVeE15MHVOREEyYlMwdU9EZzRJREl1TVRReUlERXVNelU0TGpjNE5FMHpOQzQzTVNBek1DNDNPR3d4TGpFd055QXhMakV3TjIwdE1pNDVORGN1TXpBekxqYzROQ0F4TGpNMU9HMHRNaTQ1TWpZdExqUTNMalF3TmlBeExqVXhNMjB0TWk0M01EUXVNelUyVmpNekxqTTRiUzB5TGpJNU9DMHVNekF5TFM0ME1EWWdNUzQxTVROdExUSXVOVEl0TVM0d05ETXVOemcwTFRFdU16VTRiUzB4TGpnMExURXVOREV0TVM0eE1EY2dNUzR4TURkdExTNHpNRE10TWk0NU5EY3RNUzR6TlRndU56ZzBiUzQwTnkweUxqa3lOaTB4TGpVeE15NDBNRFpOTVRrdU5UVWdNalF1TldndE1TNDFOamR0TVM0NE5qa3RNaTR5T1RndE1TNDFNVE10TGpRd05tMHhMakEwTXkweUxqVXlJREV1TXpVM0xqYzRORzB4TGpReE1TMHhMamcwTFRFdU1UQTNMVEV1TVRBM2JUSXVPVFEzTFM0ek1ETXRMamM0TkMweExqTTFPRzB5TGpreU5pNDBOeTB1TkRBMkxURXVOVEV6YlRJdU56QTBJREV1TWpFeGRpMHhMalUyTjIweUxqY3dOQzR6TlRZdExqUXdOaUF4TGpVeE0yMHlMamt5TmkwdU5EY3RMamM0TkNBeExqTTFPRzB4TGpnMElERXVOREVnTVM0eE1EY3RNUzR4TURkdE1TNDJOakVnTWk0eE5qTXRNUzR6TlRndU56ZzBiUzQ0T0RnZ01pNHhORElnTVM0MU1UTXRMalF3TmlJZ2MzUnliMnRsTFc5d1lXTnBkSGs5SWk0MUlpQnpkSEp2YTJVOUlpTm1abVlpSUhOMGNtOXJaUzEzYVdSMGFEMGlMakkxSWk4K1BIQmhkR2dnWkQwaVRUSTNMamt3T0NBeU5DNDFZUzQxTWpJdU5USXlJREFnTVNBeElERXVNRFEwSURBZ0xqVXlNaTQxTWpJZ01DQXdJREV0TVM0d05EUWdNSG9pSUdacGJHdzlJaU5tWm1ZaUlITjBjbTlyWlQwaUkyWm1aaUlnYzNSeWIydGxMWGRwWkhSb1BTSXVOU0l2UGp4d1lYUm9JR1E5SWswek9DNDFOVFVnTWpRdU5XRXlMall4TWlBeUxqWXhNaUF3SURFZ01TQTFMakl5TXlBd0lESXVOakV5SURJdU5qRXlJREFnTUNBeExUVXVNakl6SURCNklpQm1hV3hzUFNJalptWm1JaUJ6ZEhKdmEyVXRiM0JoWTJsMGVUMGlMakkxSWlCemRISnZhMlU5SWlObVptWWlJSE4wY205clpTMTNhV1IwYUQwaU1pSXZQanhuSUhSeVlXNXpabTl5YlQwaWRISmhibk5zWVhSbEtDMHlNVEV1TlNBdE1UVTFMalVwSWlCbWFXeHNQU0lqTkdNNU4yWm1JaUJtYVd4c0xYSjFiR1U5SW1WMlpXNXZaR1FpTHo0OGNHRjBhQ0JrUFNKTk5ERXVNVGN4SURJekxqY3hOV013TFM0eE5EUXVNRGt6TFM0eE9TNHlNUzB1TVRBemJERWdMamMwT1dNdU1URTJMakE0Tmk0eE1UY3VNakkwTFM0d01ETXVNekZzTFM0NU9UUXVOekpqTFM0eE1UZ3VNRGcwTFM0eU1UTXVNRE0xTFM0eU1UTXRMakV3TjNZdExqUXpObXd0TVM0eE56Z3RMakU1Tm1FdU1UWXVNVFlnTUNBd0lERXRMakV5T0MwdU1UVXlZekF0TGpBM015NHdOaTB1TVRRdU1USTRMUzR4TlRKc01TNHhOemd0TGpFNU4zb2lJR1pwYkd3OUlpTTBZemszWm1ZaUlHWnBiR3d0Y25Wc1pUMGlaWFpsYm05a1pDSXZQand2YzNablBnPT0iLAogICAgICAibm90ZSI6ICJNelU3Wm1sc2JEb2pabVptSWk4K1BIQmhkR2dnWkQwaVRUTTFMamMwSURJNExqTXdOR011TWprMklERXVORGM1TFRFdU1EZ2dNaTQyTnpNdE15NHdOek1nTWk0Mk56TXRNUzQ1T0RrZ01DMHpMamd6TmkweExqRTVOQzAwTGpFeU55MHlMalkzTXkwdU1qazNMVEV1TkRnZ01TNHdOemd0TWk0Mk56Z2dNeTR3TnpJdE1pNDJOemd1TkRFNUlEQWdMamd6TGpBMU5DQXhMakl5TkM0eE5URXVNakU1TGpBMU5pNDBNVEl1TVRFM0xqWXdOeTR4T1RZdU5UWTBMUzR3TVRNdExqQTJOeTB4TGpRNE5pMHhMakU0T0MwM0xqa3lMVEV1TXpneUxUY3VPVFk0SURFdU9UZ3hMVEV1TWpFeUlEVXVOamM0TFRFdU56Z3pJRE11TmprM0xTNDFOek11TURVZ015NHhNakV0TWk0ek5qUWdNaTQwT1MweUxqUXhNaTB1TmpRdE15NHdNVEV0TkM0Mk16TXVNVGNnT1M0MU5EUjZiUzB4TVM0d01EZ2dNeTQ0T0dNdU1qa2dNUzQwT0MweExqQTROU0F5TGpZM09TMHpMakEzTVNBeUxqWTNPUzB4TGprNE9DQXdMVE11T0RNMUxURXVNaTAwTGpFek1pMHlMalk0TFM0eU9TMHhMalEzT0NBeExqQTROQzB5TGpZM055QXpMakEzTmkweUxqWTNOeTQyTlNBd0lERXVNamd1TVRJM0lERXVPRFV1TXpVeUxqVXpNaTB1TURNMkxTNHdPVGd0TVM0MU5DMHhMakl3TnkwM0xqa3lMVEV1TXpndE55NDVOamdnTVM0NU9ESXRNUzR5TVRFZ05TNDJOell0TVM0M09ETWdNeTQyT1RZdExqVTNPUzR3TlNBekxqRXlNaTB5TGpNMk1pQXlMalE0TXkweUxqUXhNaTB1TmpRdE15NHdNVEl0TkM0Mk16SXVNVGNnT1M0MU5EVjZJaUJtYVd4c1BTSWpObVUzTkRnNElpOCtQQzl6ZG1jKyIsCiAgICAgICJtYXQiOiAiTXpVN1ptbHNiRG9qTUdSaE5UZGhJaTgrUEhCaGRHZ2daRDBpVFRFM0xqVWdNVFl1TldFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhwdE5TQXdZVEVnTVNBd0lEQWdNUzB4TFRGMkxUSmhNU0F4SURBZ01DQXhJREV0TVdneVlURWdNU0F3SURBZ01TQXhJREYyTW1FeElERWdNQ0F3SURFdE1TQXhlaUlnWm1sc2JEMGlJMlptWmlJdlBqeHdZWFJvSUdROUlrMHlOeTQxSURFMkxqVmhNU0F4SURBZ01DQXhMVEV0TVhZdE1tRXhJREVnTUNBd0lERWdNUzB4YURKaE1TQXhJREFnTUNBeElERWdNWFl5WVRFZ01TQXdJREFnTVMweElERjZJaUJtYVd4c1BTSWpNR1ppWkRoaklpOCtQSEJoZEdnZ1pEMGlUVE15TGpVZ01UWXVOV0V4SURFZ01DQXdJREV0TVMweGRpMHlZVEVnTVNBd0lEQWdNU0F4TFRGb01tRXhJREVnTUNBd0lERWdNU0F4ZGpKaE1TQXhJREFnTUNBeExURWdNWHB0TlNBd1lURWdNU0F3SURBZ01TMHhMVEYyTFRKaE1TQXhJREFnTUNBeElERXRNV2d5WVRFZ01TQXdJREFnTVNBeElERjJNbUV4SURFZ01DQXdJREV0TVNBeGVtMHRNakFnTldFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhwdE5TQXdZVEVnTVNBd0lEQWdNUzB4TFRGMkxUSmhNU0F4SURBZ01DQXhJREV0TVdneVlURWdNU0F3SURBZ01TQXhJREYyTW1FeElERWdNQ0F3SURFdE1TQXhlbTAxSURCaE1TQXhJREFnTUNBeExURXRNWFl0TW1FeElERWdNQ0F3SURFZ01TMHhhREpoTVNBeElEQWdNQ0F4SURFZ01YWXlZVEVnTVNBd0lEQWdNUzB4SURGNmJUVWdNR0V4SURFZ01DQXdJREV0TVMweGRpMHlZVEVnTVNBd0lEQWdNU0F4TFRGb01tRXhJREVnTUNBd0lERWdNU0F4ZGpKaE1TQXhJREFnTUNBeExURWdNWHB0TlNBd1lURWdNU0F3SURBZ01TMHhMVEYyTFRKaE1TQXhJREFnTUNBeElERXRNV2d5WVRFZ01TQXdJREFnTVNBeElERjJNbUV4SURFZ01DQXdJREV0TVNBeGVtMHRNakFnTldFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhvaUlHWnBiR3c5SWlObVptWWlMejQ4Y0dGMGFDQmtQU0pOTWpJdU5TQXlOaTQxWVRFZ01TQXdJREFnTVMweExURjJMVEpoTVNBeElEQWdNQ0F4SURFdE1XZ3lZVEVnTVNBd0lEQWdNU0F4SURGMk1tRXhJREVnTUNBd0lERXRNU0F4ZWlJZ1ptbHNiRDBpSXpCbVltUTRZeUl2UGp4d1lYUm9JR1E5SWsweU55NDFJREkyTGpWaE1TQXhJREFnTUNBeExURXRNWFl0TW1FeElERWdNQ0F3SURFZ01TMHhhREpoTVNBeElEQWdNQ0F4SURFZ01YWXlZVEVnTVNBd0lEQWdNUzB4SURGNklpQm1hV3hzUFNJalptWm1JaTgrUEhCaGRHZ2daRDBpVFRNeUxqVWdNall1TldFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhvaUlHWnBiR3c5SWlNd1ptSmtPR01pTHo0OGNHRjBhQ0JrUFNKTk16Y3VOU0F5Tmk0MVlURWdNU0F3SURBZ01TMHhMVEYyTFRKaE1TQXhJREFnTUNBeElERXRNV2d5WVRFZ01TQXdJREFnTVNBeElERjJNbUV4SURFZ01DQXdJREV0TVNBeGVtMHRNakFnTldFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhvaUlHWnBiR3c5SWlObVptWWlMejQ4Y0dGMGFDQmtQU0pOTWpJdU5TQXpNUzQxWVRFZ01TQXdJREFnTVMweExURjJMVEpoTVNBeElEQWdNQ0F4SURFdE1XZ3lZVEVnTVNBd0lEQWdNU0F4SURGMk1tRXhJREVnTUNBd0lERXRNU0F4ZW0wMUlEQmhNU0F4SURBZ01DQXhMVEV0TVhZdE1tRXhJREVnTUNBd0lERWdNUzB4YURKaE1TQXhJREFnTUNBeElERWdNWFl5WVRFZ01TQXdJREFnTVMweElERjZiVFVnTUdFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhvaUlHWnBiR3c5SWlNd1ptSmtPR01pTHo0OGNHRjBhQ0JrUFNKTk16Y3VOU0F6TVM0MVlURWdNU0F3SURBZ01TMHhMVEYyTFRKaE1TQXhJREFnTUNBeElERXRNV2d5WVRFZ01TQXdJREFnTVNBeElERjJNbUV4SURFZ01DQXdJREV0TVNBeGVtMHRNakFnTldFeElERWdNQ0F3SURFdE1TMHhkaTB5WVRFZ01TQXdJREFnTVNBeExURm9NbUV4SURFZ01DQXdJREVnTVNBeGRqSmhNU0F4SURBZ01DQXhMVEVnTVhwdE5TQXdZVEVnTVNBd0lEQWdNUzB4TFRGMkxUSmhNU0F4SURBZ01DQXhJREV0TVdneVlURWdNU0F3SURBZ01TQXhJREYyTW1FeElERWdNQ0F3SURFdE1TQXhlaUlnWm1sc2JEMGlJMlptWmlJdlBqeHdZWFJvSUdROUlrMHlOeTQxSURNMkxqVmhNU0F4SURBZ01DQXhMVEV0TVhZdE1tRXhJREVnTUNBd0lERWdNUzB4YURKaE1TQXhJREFnTUNBeElERWdNWFl5WVRFZ01TQXdJREFnTVMweElERjZJaUJtYVd4c1BTSWpNR1ppWkRoaklpOCtQSEJoZEdnZ1pEMGlUVE15TGpVZ016WXVOV0V4SURFZ01DQXdJREV0TVMweGRpMHlZVEVnTVNBd0lEQWdNU0F4TFRGb01tRXhJREVnTUNBd0lERWdNU0F4ZGpKaE1TQXhJREFnTUNBeExURWdNWHB0TlNBd1lURWdNU0F3SURBZ01TMHhMVEYyTFRKaE1TQXhJREFnTUNBeElERXRNV2d5WVRFZ01TQXdJREFnTVNBeElERjJNbUV4SURFZ01DQXdJREV0TVNBeGVpSWdabWxzYkQwaUkyWm1aaUl2UGp3dmMzWm5QZz09IiwKICAgICAgImVtcCI6ICJNelU3Wm1sc2JEb2pabVkwWkRaaE8zTjBjbTlyWlMxc2FXNWxZMkZ3T25KdmRXNWtPM04wY205clpTMXNhVzVsYW05cGJqcHliM1Z1WkNJdlBqd3ZjM1puUGc9PSIKICAgIH1bbmFtZV07CiAgfTsKCiAgY29uc3Qgdm0gPSBTY3JhdGNoLnZtOwogIGNvbnN0IHJ1bnRpbWUgPSB2bS5ydW50aW1lOwogIGNvbnN0IGlzUE0gPSBTY3JhdGNoLmV4dGVuc2lvbnMuaXNQZW5ndWluTW9kOwoKICBjb25zdCBURU1QX0JMT0NLX09QQ09ERSA9ICJTUG1icENTVF8kLSwuX19fU1BtYnBDU1RfVEVNUF9CTE9DSyI7IC8vIG9wY29kZSBvZiB0aGUgdGVtcG9yYXJ5IGJsb2NrIGFkZGVkIHRvIGtlZXAgdGhlIGV4dGVuc2lvbiBpbiB0aGUgcHJvamVjdAogIGNvbnN0IENVU1RPTV9NRU5VX0lEID0gIlNQMHpNZW51TWFrZXJfbWVudV8iOwogIGNvbnN0IHRhcmdldFByb2NEYXRhID0gU3ltYm9sKCJNQlBwcm9jZWR1cmVEYXRhIik7IC8vIHBsYWNlIHRvIHN0b3JlIGltcG9ydGFudCBnbG9iYWwgcHJvY2VkdXJlIGRhdGEKCiAgbGV0IHByb2NlZHVyZXNYTUwgPSAiIiwgdGVtcFN0b3JlID0ge30sIHN0b3JhZ2UgPSB7fTsKICBsZXQgZ2xvYmFsQmxvY2tzQ2FjaGUgPSB7fTsKICBsZXQgZ2xvYmFsVGFyZ2V0Rm9jdXMgPSB1bmRlZmluZWQ7IC8vIG5vdCB0byBiZSBjb25mdXNlZCB3aXRoIGdsb2JhbEJsb2Nrc0NhY2hlLCB0aGlzIGhlbHBzIGZpbmQgYmxvY2sgSURzIGluIHN0YWNrcwoKICBsZXQgaW1nU3RvcmFnZSA9IHt9LCBpbWdTdG9yZVNpemUgPSAwOwoKICBsZXQgZXh0ZW5zaW9uUmVtb3ZhYmxlID0gZmFsc2U7CiAgbGV0IGV4dDsgLy8gZXh0ZW5zaW9uIG9iamVjdAogIGxldCBleGVjdXRlLCBUaHJlYWQ7IC8vIHNldCBieSBleHBvcnRzCgogIGZ1bmN0aW9uIHRoZW1laWZ5Q29sb3IoaGV4KSB7CiAgICBpZiAoaXNQTSkgcmV0dXJuIFtoZXhdOwogICAgY29uc3QgdGhlbWVPYmogPSBSZWR1eFN0b3JlLmdldFN0YXRlKCkuc2NyYXRjaEd1aS50aGVtZS50aGVtZS5nZXRDdXN0b21FeHRlbnNpb25Db2xvcnMoKTsKICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGVtZU9iaikubGVuZ3RoID09PSAwID8gW2hleF0gOiBbCiAgICAgIHRoZW1lT2JqLnByaW1hcnkoaGV4KSwgdGhlbWVPYmouc2Vjb25kYXJ5KGhleCksIHRoZW1lT2JqLnRlcnRpYXJ5KGhleCkKICAgIF07CiAgfQoKICBjb25zdCBpbnB1dFR5cGVzID0gewogICAgY29sOiB7IG9wY29kZTogImNvbG91cl9waWNrZXIiLCBmaWVsZE5hbWU6ICJDT0xPVVIiLCBkZWZhdWx0VmFsdWU6ICgoKSA9PiBgIyR7TWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogTWF0aC5wb3coMiwgMjQpKS50b1N0cmluZygxNikucGFkU3RhcnQoNiwgIjAiKX1gKSB9LAogICAgbm90ZTogeyBvcGNvZGU6ICJub3RlIiwgZmllbGROYW1lOiAiTk9URSIsIGRlZmF1bHRWYWx1ZTogIjYwIiB9LAogICAgbWF0OiB7IG9wY29kZTogIm1hdHJpeCIsIGZpZWxkTmFtZTogIk1BVFJJWCIsIGRlZmF1bHRWYWx1ZTogaXNQTSA/ICIxMTExMDAxMDEwMDExMTAwMTAwMDExMDAwIiA6ICIxMTExMTEwMTAxMDAxMDAwMDEwMDAxMTEwIiB9LAogICAgYW5nOiB7IG9wY29kZTogIm1hdGhfYW5nbGUiLCBmaWVsZE5hbWU6ICJOVU0iLCBkZWZhdWx0VmFsdWU6ICI5MCIgfSwKICAgIC8vICVuIHRlY2huaWNhbGx5IGFscmVhZHkgZXhpc3RzIGJ1dCBzb21lIHBhcnRzIG9mIHNjcmF0Y2gtYmxvY2tzIHJlcGxhY2UgaXQgd2l0aCAlcyBzbyB3ZSBjYW4ndCB1c2UgaXQKICAgIG51bTogeyBvcGNvZGU6ICJtYXRoX251bWJlciIsIGZpZWxkTmFtZTogIk5VTSIsIGRlZmF1bHRWYWx1ZTogIjAiIH0sCiAgICBlbXA6IHsgb3Bjb2RlOiAiZW1wIiwgZmllbGROYW1lOiAiRU1QVFkifSwKICAgIGJyYzogeyBvcGNvZGU6ICJicmMiLCBmaWVsZE5hbWU6ICJTVUJTVEFDSyIgfSwKICAgIGltZzogeyBvcGNvZGU6ICJpbWciLCBmaWVsZE5hbWU6ICJJTUFHRSIgfQogIH07CiAgZnVuY3Rpb24gZ2V0SW5wdXREYXRhKGlucHV0KSB7CiAgICBpZiAoaW5wdXQuaXNEcm9wKSByZXR1cm4geyBvcGNvZGU6IGlucHV0LnR5cGUsIGZpZWxkTmFtZTogbnVsbCwgZGVmYXVsdFZhbHVlOiBudWxsIH07CiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChpbnB1dFR5cGVzLCBpbnB1dC50eXBlKSkgcmV0dXJuIHt9OwogICAgcmV0dXJuIGlucHV0VHlwZXNbaW5wdXQudHlwZV07CiAgfQogIC8vIFVzZWQgZm9yIHNldHRpbmcgaW5wdXRzIHRvIHRoZSBjb3JyZWN0IGJsb2NrIGNvbG9yCiAgZnVuY3Rpb24gaXNOb3JtYWxJbnB1dChvcGNvZGUpIHsKICAgIHJldHVybiBvcGNvZGUgPT09ICJub3RlIiB8fCBvcGNvZGUgPT09ICJtYXRyaXgiIHx8IG9wY29kZSA9PT0gImNvbG91cl9waWNrZXIiCiAgICAgIHx8IG9wY29kZSA9PT0gIm1hdGhfYW5nbGUiIHx8IG9wY29kZSA9PT0gIm1hdGhfbnVtYmVyIiB8fCBvcGNvZGUgPT09ICJ0ZXh0IjsKICB9CgogIC8vIGlmIHRydWUsIHNjcm9sbGluZyB0byBNeSBCbG9ja3Mgd2lsbCBzY3JvbGwgdG8gTXkgQmxvY2tzKyBpbnN0ZWFkCiAgLy8gdXNlZCB0byBtYWtlIHRoZSBNYWtlIGEgQmxvY2sgZGlhbG9nIHNjcm9sbCB0byB0aGUgTUIrIGNhdGVnb3J5CiAgbGV0IHNob3VsZFNjcm9sbFRvTUJQID0gZmFsc2U7CgogIC8vIHJlZnJlc2ggdGhlIGJsb2NrIGxpc3QgaWYgdHJ1ZSB3aGVuIGNhbGxlZCwgb3RoZXJ3aXNlIGRvZXMgbm90aGluZwogIGxldCBsaXN0TmVlZHNSZWZyZXNoID0gZmFsc2UsIHN1c3BlbmRSZW1vdmFsID0gZmFsc2UsIG9sZExpc3RMZW5ndGggPSAwOwoKICAvLyBDdXN0b20gQmxvY2sgTW9kYWwKICBjb25zdCByZXR1cm5UeXBlRXJyb3IgPSAoZSkgPT4gewogICAgLy8gdXNlZCBmb3IgUGVuZ3Vpbk1vZAogICAgY29uc3QgbW9kYWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGBkaXZbY2xhc3M9IlJlYWN0TW9kYWxQb3J0YWwiXWApOwogICAgaWYgKG1vZGFsPy5wYXJlbnROb2RlKSB7CiAgICAgIGNvbnNvbGUud2FybigiSWdub3JlIHRoZSBmb2xsb3dpbmcgRXJyb3IgYWJvdXQgJ2Nvbm5lY3Rpb25EQkxpc3QnLCBpdCBmaXhlcyBpdHNlbGYiKTsKICAgICAgbW9kYWwucXVlcnlTZWxlY3RvcihgW2NsYXNzXj0iY2xvc2UtYnV0dG9uX2Nsb3NlLWJ1dHRvbl8iXWApLmNsaWNrKCk7CiAgICB9CiAgfTsKCiAgLy8gQ2xlYW4gbm9uZXhpc3RlbnQgaW5wdXRzIGZyb20gdGhlIGlucHV0cyBvYmplY3QKICBmdW5jdGlvbiBjbGVhbnVwQmxvY2tJbnB1dHMoaW5wdXRzLCBhcmdzKSB7CiAgICBmb3IgKGNvbnN0IGlucHV0SWQgaW4gaW5wdXRzKSB7CiAgICAgIGlmICghYXJncy5pbmNsdWRlcyhpbnB1dElkKSkgZGVsZXRlIGlucHV0c1tpbnB1dElkXTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9wZW5CbG9ja01ha2VyKHdvcmtzcGFjZSwgaXNFZGl0aW5nKSB7CiAgICBpZiAoZXh0ZW5zaW9uUmVtb3ZhYmxlKSByZXR1cm47CiAgICBsaXN0TmVlZHNSZWZyZXNoID0gdHJ1ZTsKICAgIHNob3VsZFNjcm9sbFRvTUJQID0gdHJ1ZTsKICAgIGNvbnN0IGlzRGFyayA9IGlzUE0gPyBkb2N1bWVudC5ib2R5LmdldEF0dHJpYnV0ZSgidGhlbWUiKSA9PT0gImRhcmsiIDogUmVkdXhTdG9yZS5nZXRTdGF0ZSgpLnNjcmF0Y2hHdWkudGhlbWUudGhlbWUuZ3VpID09PSAiZGFyayI7CiAgICAvLyBTY3JhdGNoIGNyZWF0ZXMgYSBuZXcgd29ya3NwYWNlIGZvciBDdXN0b20gQmxvY2tzLCB3ZSBuZWVkIHRvIGNhcHR1cmUgaXQKICAgIGNvbnN0IG5ld1dvcmtzcGFjZSA9IFNjcmF0Y2hCbG9ja3MubWFpbldvcmtzcGFjZTsKICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgZGl2W2NsYXNzPSJSZWFjdE1vZGFsUG9ydGFsIl1gKTsKICAgIG1vZGFsLnF1ZXJ5U2VsZWN0b3IoYGRpdltjbGFzcyo9Im1vZGFsX2hlYWRlci1pdGVtLXRpdGxlIl1gKS50ZXh0Q29udGVudCA9IFNjcmF0Y2gudHJhbnNsYXRlKCJNYWtlIGEgQmxvY2srIik7CiAgICBpZiAoIWlzUE0pIG1vZGFsLnF1ZXJ5U2VsZWN0b3IoYGRpdltjbGFzcyo9Im1vZGFsX21vZGFsLW92ZXJsYXlfIl1gKS5zdHlsZS50b3AgPSAiLTI1cHgiOwogICAgZWxzZSB7CiAgICAgIGNvbnN0IG9wdGlvblJvdyA9IG1vZGFsLnF1ZXJ5U2VsZWN0b3JBbGwoYFtjbGFzc149ImN1c3RvbS1wcm9jZWR1cmVzX29wdGlvbnMtcm93XyJdYCk7CiAgICAgIGNvbnN0IHJldHVybkNoZWNrID0gbW9kYWwucXVlcnlTZWxlY3RvckFsbChgaW5wdXRbdHlwZT0iY2hlY2tib3giXWApOwoKICAgICAgY29uc3QgaW5uZXJNb2RhbCA9IG1vZGFsLmZpcnN0Q2hpbGQ7CiAgICAgIGlubmVyTW9kYWwuc3R5bGUub3ZlcmZsb3cgPSAiYXV0byI7CiAgICAgIAogICAgICBsZXQgb2dUb3A7CiAgICAgIGlubmVyTW9kYWwuYWRkRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgKCkgPT4gewogICAgICAgIGNvbnN0IGFjdGl2ZUlucHV0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihgZGl2W2NsYXNzXj0iYmxvY2tseVdpZGdldERpdiJdW2NsYXNzKj0iZmllbGRUZXh0SW5wdXQiXWApOwogICAgICAgIGlmIChhY3RpdmVJbnB1dCkgewogICAgICAgICAgaWYgKCFvZ1RvcCkgewogICAgICAgICAgICBjb25zdCBtb2RhbFJlY3QgPSBpbm5lck1vZGFsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgICAgICBjb25zdCBpbnB1dFJlY3QgPSBhY3RpdmVJbnB1dC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgb2dUb3AgPSBpbnB1dFJlY3QudG9wIC0gbW9kYWxSZWN0LnRvcCArIGlubmVyTW9kYWwuc2Nyb2xsVG9wOwogICAgICAgICAgfQogICAgICAgICAgYWN0aXZlSW5wdXQuc3R5bGUudG9wID0gYCR7b2dUb3AgLSBpbm5lck1vZGFsLnNjcm9sbFRvcH1weGA7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIG1vZGFsLnF1ZXJ5U2VsZWN0b3IoYFtjbGFzc149ImN1c3RvbS1wcm9jZWR1cmVzX2NvbG9yLXBpY2tlci1hcmVhXyJdYCkuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgaWYgKG9wdGlvblJvd1sxXSkgb3B0aW9uUm93WzFdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIGlmIChyZXR1cm5DaGVja1sxXSkgcmV0dXJuQ2hlY2tbMV0ucGFyZW50Tm9kZS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChlKSA9PiB7CiAgICAgICAgb3B0aW9uUm93WzFdLnN0eWxlLmRpc3BsYXkgPSBlLnRhcmdldC5jaGVja2VkID8gIiIgOiAibm9uZSI7CiAgICAgIH0pOwogICAgfQogICAgY29uc3Qgcm93ID0gbW9kYWwucXVlcnlTZWxlY3RvcihgW2NsYXNzXj0iY3VzdG9tLXByb2NlZHVyZXNfb3B0aW9ucy1yb3dfIl1gKTsKICAgIGNvbnN0IGJsb2NrRWRpdG9yID0gbmV3V29ya3NwYWNlLmdldEJsb2NrQnlJZChtb2RhbC5xdWVyeVNlbGVjdG9yKCJnW2RhdGEtaWRdIikuZ2V0QXR0cmlidXRlKCJkYXRhLWlkIikpOwogICAgY29uc3Qgb2xkUHJvYyA9IGJsb2NrRWRpdG9yLnByb2NDb2RlXzsKICAgIHRlbXBTdG9yZSA9IHN0cnVjdHVyZWRDbG9uZShzdG9yZUdldChvbGRQcm9jKSkgfHwge307IC8vIFJlc2V0CiAgICBibG9ja0VkaXRvci5TUG1icENTVF9zdG9yZSA9IHRlbXBTdG9yZTsKCiAgICBhdHRhY2hJbnB1dEJ0bnMocm93LCBibG9ja0VkaXRvciwgaXNEYXJrLCB3b3Jrc3BhY2UpOwogICAgYXR0YWNoQ29sb3JzKHJvdywgaXNEYXJrLCBibG9ja0VkaXRvcik7CiAgICBhdHRhY2hDaGVja2JveGVzKG1vZGFsLCBibG9ja0VkaXRvciwgaXNFZGl0aW5nLCBvbGRQcm9jKTsKCiAgICAvLyBBdHRhY2ggT2theSBCdXR0b24gTGlzdGVuZXIKICAgIGNvbnN0IG9rQnRuID0gbW9kYWwucXVlcnlTZWxlY3RvcihgYnV0dG9uW2NsYXNzXj0iY3VzdG9tLXByb2NlZHVyZXNfb2stYnV0dG9uXyJdYCk7CiAgICBva0J0bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChlKSA9PiB7CiAgICAgIC8vIHByZXZlbnQgcHJvY2NvZGUgY29uZmxpY3RzCiAgICAgIGNvbnN0IG5ld1Byb2MgPSBibG9ja0VkaXRvci5wcm9jQ29kZV87CiAgICAgIGxldCBwcm90b0V4aXN0cyA9IFNjcmF0Y2hCbG9ja3MuUHJvY2VkdXJlcy5nZXRQcm90b3R5cGVCbG9jayhuZXdQcm9jLCB3b3Jrc3BhY2UpOwogICAgICBpZiAoIXByb3RvRXhpc3RzKSB7CiAgICAgICAgcmVmcmVzaEdsb2JhbEJsb2Nrc0NhY2hlKCk7CiAgICAgICAgY29uc3QgdGhpc0lEID0gdm0uZWRpdGluZ1RhcmdldC5pZDsKICAgICAgICBmb3IgKGNvbnN0IHRhcmdldCBvZiBydW50aW1lLnRhcmdldHMpIHsKICAgICAgICAgIHByb3RvRXhpc3RzID0gdGFyZ2V0LmJsb2Nrcy5nZXRQcm9jZWR1cmVEZWZpbml0aW9uKG5ld1Byb2MpOwogICAgICAgICAgaWYgKHByb3RvRXhpc3RzKSB7CiAgICAgICAgICAgIGlmICh0aGlzSUQgPT09IGdsb2JhbEJsb2Nrc0NhY2hlW25ld1Byb2NdPy5pZCkgewogICAgICAgICAgICAgIHByb3RvRXhpc3RzID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0aGlzSUQgPT09IHRhcmdldC5pZCAmJiBpc0VkaXRpbmcpIHByb3RvRXhpc3RzID0gdW5kZWZpbmVkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICgocHJvdG9FeGlzdHMgJiYgKCFpc0VkaXRpbmcgfHwgb2xkUHJvYyAhPT0gbmV3UHJvYykpKSB7CiAgICAgICAgYWxlcnQoIkEgY3VzdG9tIGJsb2NrIHdpdGggdGhpcyB0ZXh0IGFscmVhZHkgZXhpc3RzISIpOwogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjbGVhbnVwQmxvY2tJbnB1dHModGVtcFN0b3JlLmlucHV0cywgYmxvY2tFZGl0b3IuYXJndW1lbnRJZHNfKTsKICAgICAgc3RvcmVTZXQobmV3UHJvYywgdGVtcFN0b3JlKTsKICAgICAgaWYgKGlzRWRpdGluZyAmJiBvbGRQcm9jICE9PSBuZXdQcm9jKSBzdG9yZURlbChvbGRQcm9jKTsKICAgICAgcmVmcmVzaEdsb2JhbEJsb2Nrc0NhY2hlKCk7CgogICAgICAvLyB1cGRhdGUgYWxsIGdsb2JhbCBibG9ja3Mgb3V0c2lkZSB0aGlzIHRhcmdldAogICAgICBpZiAoaXNQTSAmJiBpc0VkaXRpbmcgJiYgb2xkUHJvYyAhPT0gbmV3UHJvYykgewogICAgICAgIC8vIFRPRE8gbWFrZSB0aGlzIHdvcmsgaW4gVHVyYm93YXJwCiAgICAgICAgY29uc3QgZGVmYXVsdHMgPSBibG9ja0VkaXRvci5hcmd1bWVudERlZmF1bHRzXzsKICAgICAgICBjb25zdCBhcmdMaXN0ID0gYmxvY2tFZGl0b3IuYXJndW1lbnRJZHNfOwogICAgICAgIGNvbnN0IGFyZ0xpc3RTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShhcmdMaXN0KTsKICAgICAgICBjb25zdCB3YXJwID0gYmxvY2tFZGl0b3IuZ2V0V2FycCgpOwogICAgICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHJ1bnRpbWUudGFyZ2V0cykgewogICAgICAgICAgaWYgKHRhcmdldC5pZCA9PT0gdm0uZWRpdGluZ1RhcmdldC5pZCkgY29udGludWU7CgogICAgICAgICAgY29uc3QgYmxvY2tDYWNoZSA9IHRhcmdldC5ibG9ja3M7CiAgICAgICAgICBjb25zdCBwcm9jQ2FsbGVycyA9IE9iamVjdC52YWx1ZXMoYmxvY2tDYWNoZS5fYmxvY2tzKS5maWx0ZXIoKGIpID0+IGIub3Bjb2RlID09PSAicHJvY2VkdXJlc19jYWxsIik7CiAgICAgICAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIHByb2NDYWxsZXJzKSB7CiAgICAgICAgICAgIGlmIChibG9jay5tdXRhdGlvbi5wcm9jY29kZSAhPT0gb2xkUHJvYykgY29udGludWU7CiAgICAgICAgICAgIGJsb2NrLm11dGF0aW9uLnByb2Njb2RlID0gbmV3UHJvYzsKICAgICAgICAgICAgYmxvY2subXV0YXRpb24uYXJndW1lbnRpZHMgPSBhcmdMaXN0U3RyaW5nOwogICAgICAgICAgICBibG9jay5tdXRhdGlvbi53YXJwID0gU2NyYXRjaC5DYXN0LnRvU3RyaW5nKHdhcnApOwoKICAgICAgICAgICAgLy8gaW5qZWN0IG1pc3NpbmcgaW5wdXRzCiAgICAgICAgICAgIGNvbnN0IGlucHV0cyA9IE9iamVjdC52YWx1ZXMoYmxvY2suaW5wdXRzKTsKICAgICAgICAgICAgY29uc3QgbWlzc2luZyA9IGFyZ0xpc3QuZmlsdGVyKChhKSA9PiBpbnB1dHMuZmluZEluZGV4KChpKSA9PiBpLm5hbWUgPT09IGEpIDwgMCk7CiAgICAgICAgICAgIGZvciAoY29uc3QgaW5wdXQgb2YgbWlzc2luZykgewogICAgICAgICAgICAgIGxldCB0eXBlID0gdGVtcFN0b3JlPy5pbnB1dHM/LltpbnB1dF07CiAgICAgICAgICAgICAgaWYgKHR5cGUpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlLmlzRHJvcCkgdHlwZSA9IHR5cGUudHlwZTsKICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICB0eXBlID0gZ2V0SW5wdXREYXRhKHR5cGUpPy5vcGNvZGU7CiAgICAgICAgICAgICAgICAgIGlmICghaXNOb3JtYWxJbnB1dCh0eXBlKSkgdHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IGRlZmF1bHRzW2FyZ0xpc3QuaW5kZXhPZihpbnB1dCldOwogICAgICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZSA9PT0gIiIpIHR5cGUgPSAidGV4dCI7CiAgICAgICAgICAgICAgICAvLyBlbHNlICJmYWxzZSIgLT4gYm9vbGVhbiwgbGVhdmUgdW5kZWZpbmVkCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAodHlwZSkgewogICAgICAgICAgICAgICAgY29uc3QgdGVtcEJsb2NrID0gbmV3V29ya3NwYWNlLm5ld0Jsb2NrKHR5cGUpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJ0ZXh0IikgdGVtcEJsb2NrLnNldEZpZWxkVmFsdWUoIiIsICJURVhUIik7CiAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHRlbXBCbG9jay5pZDsKICAgICAgICAgICAgICAgIGNvbnN0IHNoYWRvdyA9IGJsb2NrQ2FjaGUuWE1MVG9CbG9jayh7IHhtbDogU2NyYXRjaEJsb2Nrcy5YbWwuYmxvY2tUb0RvbSh0ZW1wQmxvY2spIH0pOwogICAgICAgICAgICAgICAgc2hhZG93WzBdLnBhcmVudCA9IGJsb2NrLmlkOwogICAgICAgICAgICAgICAgc2hhZG93WzBdLnNoYWRvdyA9IHRydWU7CiAgICAgICAgICAgICAgICB0ZW1wQmxvY2suZGlzcG9zZSgpOwogICAgICAgICAgICAgICAgYmxvY2tDYWNoZS5jcmVhdGVCbG9jayhzaGFkb3dbMF0pOwogICAgICAgICAgICAgICAgYmxvY2suaW5wdXRzW2lkXSA9IHsgbmFtZTogaW5wdXQsIGJsb2NrOiBpZCwgc2hhZG93OiBpZCB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGlzUE0pIHsKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCByZXR1cm5UeXBlRXJyb3IsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCByZXR1cm5UeXBlRXJyb3IsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnZW5EcnBCdXR0b24oY29udGFpbmVyLCBvcHRzLCBkZWZhdWx0VmFsdWUsIGlzRGFyaywgaXNMYWJlbCwgY2hhbmdlRnVuYywgc2V0RnVuYykgewogICAgY29uc3QgaW1nID0gY29udGFpbmVyLmNoaWxkTm9kZXNbMF0sIGJ0biA9IGNvbnRhaW5lci5jaGlsZE5vZGVzWzJdOwogICAgaW1nLnNyYyA9IGRlZmF1bHRWYWx1ZTsKICAgIGlmIChpc0xhYmVsKSBjb250YWluZXIuY2hpbGROb2Rlc1sxXS5maXJzdENoaWxkLnRleHRDb250ZW50ID0gU2NyYXRjaC50cmFuc2xhdGUoIkFkZCBhIGxhYmVsIik7CgogICAgLy8gcmVwbGFjZSB0ZXh0IHdpdGggZHJvcGRvd24gaW5wdXQKICAgIGxldCBkcnBkb3duID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VsZWN0Iik7CiAgICBkcnBkb3duLnNldEF0dHJpYnV0ZSgic3R5bGUiLCBgJHtpc0xhYmVsID8gIndpZHRoOiAxMDAlOyAiIDogIiJ9IGJvcmRlci1yYWRpdXM6IDVweDsgdGV4dC1hbGlnbjogY2VudGVyOyBiYWNrZ3JvdW5kOiAke2lzRGFyayA/ICIjMWUxZTFlIiA6ICIjZmZmIn07IGJvcmRlcjogMnB4IHNvbGlkIHZhcigtLXVpLWJsYWNrLXRyYW5zcGFyZW50LCByZ2JhKDAsIDAsIDAsIDAuMTUpKTtgKTsKICAgIGZvciAoY29uc3QgW3R4dCwgdmFsXSBvZiBvcHRzKSB7CiAgICAgIGxldCBvcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKTsKICAgICAgb3B0LnRleHQgPSB0eHQ7IG9wdC52YWx1ZSA9IHZhbDsKICAgICAgZHJwZG93bi5hcHBlbmRDaGlsZChvcHQpOwogICAgfTsKICAgIGJ0bi5yZXBsYWNlQ2hpbGQoZHJwZG93biwgYnRuLnF1ZXJ5U2VsZWN0b3IoInNwYW4iKSk7CgogICAgLy8gb24gRmlyZWZveCwgdGhlICJjbGljayIgZXZlbnQgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIGJ1dHRvbiwgd2hpY2ggd2lsbCBhZGQgYW5vdGhlciBpbnB1dC4gZG9uJ3QgZG8gdGhhdAogICAgZHJwZG93bi5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpKTsKICAgIGRycGRvd24uYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKGUpID0+IHsKICAgICAgY2hhbmdlRnVuYyhlLnRhcmdldC52YWx1ZSwgaW1nKTsKICAgICAgY29udGFpbmVyLmNsaWNrKCk7CiAgICB9KTsKICAgIGNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIChlKSA9PiBzZXRGdW5jKGUsIGRycGRvd24pKTsKICAgIHJldHVybiBjb250YWluZXI7CiAgfQoKICBmdW5jdGlvbiBhdHRhY2hJbnB1dEJ0bnMocm93LCBlZGl0b3IsIGlzRGFyaywgd29ya3NwYWNlKSB7CiAgICBjb25zdCBvbGRCb29sVVJMID0gcm93LmNoaWxkTm9kZXNbMV0uY2hpbGROb2Rlc1swXS5zcmM7CiAgICBjb25zdCBvbGRMYWJlbFVSTCA9IHJvdy5jaGlsZE5vZGVzW2lzUE0gPyAzIDogMl0uY2hpbGROb2Rlc1swXS5zcmM7CgogICAgLy8gZHJvcGRvd24gYnRuCiAgICBjb25zdCBkcm9wQnRuID0gcm93LmNoaWxkTm9kZXNbMV0uY2xvbmVOb2RlKHRydWUpOwogICAgZHJvcEJ0bi5jaGlsZE5vZGVzWzBdLnNyYyA9IGd1aVVSSXMoImRyb3Bkd24iKTsKICAgIGRyb3BCdG4uY2hpbGROb2Rlc1syXS50ZXh0Q29udGVudCA9IFNjcmF0Y2gudHJhbnNsYXRlKCJkcm9wZG93biIpOwogICAgcm93Lmluc2VydEJlZm9yZShkcm9wQnRuLCByb3cuY2hpbGROb2Rlc1syXSk7CiAgICBkcm9wQnRuLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gb3Blbk1lbnVTZWxlY3RvcihlZGl0b3IsIGlzRGFyaywgd29ya3NwYWNlKSk7CgogICAgLy8gYnJhbmNoIGJ0bgogICAgY29uc3QgYnJhbmNoQnRuID0gcm93LmNoaWxkTm9kZXNbMV0uY2xvbmVOb2RlKHRydWUpOwogICAgYnJhbmNoQnRuLmNoaWxkTm9kZXNbMF0uc3JjID0gaW5wdXRVUklzKCJicmMiKTsKICAgIGJyYW5jaEJ0bi5jaGlsZE5vZGVzWzJdLnRleHRDb250ZW50ID0gU2NyYXRjaC50cmFuc2xhdGUoImJyYW5jaCIpOwogICAgaWYgKGlzUE0pIGJyYW5jaEJ0bi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgcm93Lmluc2VydEJlZm9yZShicmFuY2hCdG4sIHJvdy5jaGlsZE5vZGVzWzNdKTsKICAgIGlmICghaXNQTSkgewogICAgICBicmFuY2hCdG4uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSkgPT4gewogICAgICAgIGVkaXRvci5hZGRTdHJpbmdOdW1iZXJFeHRlcm5hbCgpOwogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgogICAgICAgIGNvbnN0IGFyZ3MgPSBlZGl0b3IuYXJndW1lbnRJZHNfOwogICAgICAgIGNvbnN0IGlkID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwogICAgICAgIGNvbnN0IGlucHV0cyA9IHRlbXBTdG9yZS5pbnB1dHMgfHwge307CiAgICAgICAgaW5wdXRzW2lkXSA9IHsgdHlwZTogImJyYyIsIGlzRHJvcDogZmFsc2UgfTsKICAgICAgICB0ZW1wU3RvcmUuaW5wdXRzID0gaW5wdXRzOwogICAgICAgIGNsZWFudXBCbG9ja0lucHV0cyhpbnB1dHMsIGFyZ3MpOwoKICAgICAgICBlZGl0b3IuZGlzcGxheU5hbWVzX1thcmdzLmxlbmd0aCAtIDFdID0gImJyYW5jaCI7CiAgICAgICAgZWRpdG9yLnVwZGF0ZURpc3BsYXlfKCk7CiAgICAgICAgZWRpdG9yLmZvY3VzTGFzdEVkaXRvcl8oKTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gZHluYW1pYyBidG5zCiAgICBjb25zdCBsYWJQYXRocyA9IFtbU2NyYXRjaC50cmFuc2xhdGUoInRleHQiKSwgInRleHQiXSwgW1NjcmF0Y2gudHJhbnNsYXRlKCJpbWFnZSIpLCAiaW1nIl1dOwogICAgY29uc3QgaW5wUGF0aHMgPSBbCiAgICAgIFtTY3JhdGNoLnRyYW5zbGF0ZSgibnVtYmVyIG9yIHRleHQiKSwgIm5vcm0iXSwgW1NjcmF0Y2gudHJhbnNsYXRlKCJudW1iZXIiKSwgIm51bSJdLCBbU2NyYXRjaC50cmFuc2xhdGUoImJvb2xlYW4iKSwgImJvb2wiXSwgW1NjcmF0Y2gudHJhbnNsYXRlKCJhbmdsZSIpLCAiYW5nIl0sCiAgICAgIFtTY3JhdGNoLnRyYW5zbGF0ZSgiY29sb3IiKSwgImNvbCJdLCBbU2NyYXRjaC50cmFuc2xhdGUoIm5vdGUiKSwgIm5vdGUiXSwgW1NjcmF0Y2gudHJhbnNsYXRlKCJtYXRyaXgiKSwgIm1hdCJdLCBbU2NyYXRjaC50cmFuc2xhdGUoImVtcHR5IiksICJlbXAiXQogICAgXTsKCiAgICBjb25zdCB0ZW1wQnRuID0gcm93LmNoaWxkTm9kZXNbMV07CiAgICByb3cucmVwbGFjZUNoaWxkKGdlbkRycEJ1dHRvbigKICAgICAgdGVtcEJ0bi5jbG9uZU5vZGUodHJ1ZSksIGlucFBhdGhzLCBpbnB1dFVSSXMoIm5vcm0iKSwgaXNEYXJrLCBmYWxzZSwKICAgICAgKHZhbHVlLCBpbWcpID0+IHsKICAgICAgICBpbWcuc3JjID0gdmFsdWUgPT09ICJib29sIiA/IG9sZEJvb2xVUkwgOiBpbnB1dFVSSXModmFsdWUpOwogICAgICB9LAogICAgICAoZSwgZHJwZG93bikgPT4gewogICAgICAgIGlmIChlLnRhcmdldCA9PT0gZHJwZG93bikgcmV0dXJuOwogICAgICAgIGlmIChkcnBkb3duLnZhbHVlID09PSAiYm9vbCIpIHsKICAgICAgICAgIGVkaXRvci5hZGRCb29sZWFuRXh0ZXJuYWwoKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZWRpdG9yLmFkZFN0cmluZ051bWJlckV4dGVybmFsKCk7CiAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsgLy8gZG9uJ3QgcnVuIHRoZSBvbGQgYWRkIGV2ZW50CiAgICAgICAgaWYgKGRycGRvd24udmFsdWUgPT09ICJub3JtIikgcmV0dXJuOwoKICAgICAgICBjb25zdCBhcmdzID0gZWRpdG9yLmFyZ3VtZW50SWRzXzsKICAgICAgICBjb25zdCBpZCA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTsKICAgICAgICBjb25zdCBpbnB1dHMgPSB0ZW1wU3RvcmUuaW5wdXRzIHx8IHt9OwogICAgICAgIGlucHV0c1tpZF0gPSB7IHR5cGU6IGRycGRvd24udmFsdWUsIGlzRHJvcDogZmFsc2UgfTsKICAgICAgICB0ZW1wU3RvcmUuaW5wdXRzID0gaW5wdXRzOwogICAgICAgIGNsZWFudXBCbG9ja0lucHV0cyhpbnB1dHMsIGFyZ3MpOwoKICAgICAgICBlZGl0b3IuZGlzcGxheU5hbWVzX1thcmdzLmxlbmd0aCAtIDFdID0gZHJwZG93bi5zZWxlY3RlZE9wdGlvbnNbMF0udGV4dENvbnRlbnQ7CiAgICAgICAgZWRpdG9yLnVwZGF0ZURpc3BsYXlfKCk7CiAgICAgICAgZWRpdG9yLmZvY3VzTGFzdEVkaXRvcl8oKTsKICAgICAgfQogICAgKSwgcm93LmNoaWxkTm9kZXNbMF0pOwogICAgcm93LnJlcGxhY2VDaGlsZChnZW5EcnBCdXR0b24oCiAgICAgIHRlbXBCdG4uY2xvbmVOb2RlKHRydWUpLCBsYWJQYXRocywgb2xkTGFiZWxVUkwsIGlzRGFyaywgdHJ1ZSwKICAgICAgKHZhbHVlLCBpbWcpID0+IHsKICAgICAgICBpbWcuc3JjID0gdmFsdWUgPT09ICJ0ZXh0IiA/IG9sZExhYmVsVVJMIDogaW5wdXRVUklzKHZhbHVlKTsKICAgICAgfSwKICAgICAgKGUsIGRycGRvd24pID0+IHsKICAgICAgICBpZiAoZS50YXJnZXQgPT09IGRycGRvd24pIHJldHVybjsKICAgICAgICBpZiAoZHJwZG93bi52YWx1ZSA9PT0gInRleHQiKSBlZGl0b3IuYWRkTGFiZWxFeHRlcm5hbCgpOwogICAgICAgIGVsc2Ugb3BlbkltZ1NlbGVjdG9yKGVkaXRvciwgaXNEYXJrLCB3b3Jrc3BhY2UpOwogICAgICB9CiAgICApLCByb3cuY2hpbGROb2Rlc1tpc1BNID8gNSA6IDRdKTsKICAgIHJvdy5jaGlsZE5vZGVzWzFdLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgfQoKICBmdW5jdGlvbiBhdHRhY2hDaGVja2JveGVzKG1vZGFsLCBlZGl0b3IsIGlzRWRpdGluZywgb2dQcm9jb2RlKSB7CiAgICBjb25zdCBjaGVja1JvdyA9IGlzUE0gPyBtb2RhbC5xdWVyeVNlbGVjdG9yKGBkaXZbY2xhc3NePSJjdXN0b20tcHJvY2VkdXJlc19idXR0b24tcm93XyJdYCkucHJldmlvdXNTaWJsaW5nCiAgICAgIDogbW9kYWwucXVlcnlTZWxlY3RvcihgW2NsYXNzXj0iY3VzdG9tLXByb2NlZHVyZXNfY2hlY2tib3gtcm93Il1gKTsKICAgIGNvbnN0IG1ha2VCb3ggPSAodHh0LCB2YWwsIGZ1bmMpID0+IHsKICAgICAgY29uc3QgYm94ID0gY2hlY2tSb3cuZmlyc3RDaGlsZC5jbG9uZU5vZGUodHJ1ZSk7CiAgICAgIGJveC5jaGlsZE5vZGVzWzFdLnRleHRDb250ZW50ID0gdHh0OwogICAgICBib3guY2hpbGROb2Rlc1swXS5jaGVja2VkID0gdmFsOwogICAgICBib3guYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiBmdW5jKGJveC5jaGlsZE5vZGVzWzBdLmNoZWNrZWQpKTsKICAgICAgcmV0dXJuIGJveDsKICAgIH07CiAgICBpZiAoaXNFZGl0aW5nICYmIGlzUE0pIHsKICAgICAgY29uc3QgaXNSZXR1cm5lciA9IGVkaXRvci5nZXRSZXR1cm5zKCk7CiAgICAgIGNvbnN0IHJldHVyblR5cGUgPSBtYWtlQm94KAogICAgICAgICJCb29sZWFuIiwgZWRpdG9yLm91dHB1dFR5cGUgPT09ICJib29sZWFuIiwKICAgICAgICAodmFsKSA9PiB7IGVkaXRvci5zZXRUeXBlKHZhbCA/ICJib29sZWFuIiA6ICJzdHJpbmciKSB9CiAgICAgICk7CiAgICAgIHJldHVyblR5cGUuc3R5bGUuZGlzcGxheSA9IGlzUmV0dXJuZXIgPyAiIiA6ICJub25lIjsKICAgICAgcmV0dXJuVHlwZS5zdHlsZS5tYXJnaW5MZWZ0ID0gIjVweCI7CiAgICAgIGNvbnN0IHJldHVybkNoZWNrID0gbWFrZUJveCgKICAgICAgICAiUmV0dXJucyBhIHZhbHVlIiwgaXNSZXR1cm5lciwKICAgICAgICAodmFsKSA9PiB7CiAgICAgICAgICBlZGl0b3Iuc2V0UmV0dXJucyh2YWwpOwogICAgICAgICAgaWYgKHZhbCkgewogICAgICAgICAgICBlZGl0b3Iuc2V0VHlwZSgic3RyaW5nIik7CiAgICAgICAgICAgIHJldHVyblR5cGUuY2hpbGROb2Rlc1swXS5jaGVja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVyblR5cGUuc3R5bGUuZGlzcGxheSA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWRpdG9yLnNldFR5cGUoInN0YXRlbWVudCIpOwogICAgICAgICAgICByZXR1cm5UeXBlLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICApOwogICAgICBjaGVja1Jvdy5hcHBlbmQocmV0dXJuQ2hlY2ssIHJldHVyblR5cGUpOwogICAgfQogICAgY2hlY2tSb3cuYXBwZW5kKGlzUE0gJiYgIWlzRWRpdGluZyA/ICIiIDogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnIiKSwgbWFrZUJveCgKICAgICAgU2NyYXRjaC50cmFuc2xhdGUoIkNhcCBibG9jayIpLCB0ZW1wU3RvcmUuaXNUZXJtaW5hbCAhPT0gdW5kZWZpbmVkID8gdGVtcFN0b3JlLmlzVGVybWluYWwgOiBmYWxzZSwKICAgICAgKHZhbCkgPT4gewogICAgICAgIGVkaXRvci5zZXROZXh0U3RhdGVtZW50KCF2YWwpOwogICAgICAgIHRlbXBTdG9yZS5pc1Rlcm1pbmFsID0gdmFsOwogICAgICB9CiAgICApKTsKICAgIGNoZWNrUm93LmFwcGVuZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJiciIpLCBtYWtlQm94KAogICAgICBTY3JhdGNoLnRyYW5zbGF0ZSgiQXZhaWxhYmxlIGZvciBhbGwgc3ByaXRlcyIpLCB0ZW1wU3RvcmUuZ2xvYmFsICE9PSB1bmRlZmluZWQgPyB0ZW1wU3RvcmUuZ2xvYmFsIDogZmFsc2UsCiAgICAgICh2YWwpID0+IHsgdGVtcFN0b3JlLmdsb2JhbCA9IHZhbCB9CiAgICApKTsKICB9CgogIGZ1bmN0aW9uIGF0dGFjaENvbG9ycyhyb3csIGlzRGFyaywgZWRpdG9yKSB7CiAgICBjb25zdCBjb2xvclV0aWwgPSBTY3JhdGNoQmxvY2tzLmdvb2cuY29sb3I7CiAgICBjb25zdCBib3VuY2VBbmltID0gKGNpcmMpID0+IHsKICAgICAgY2lyYy5hbmltYXRlKAogICAgICAgIFt7IHRyYW5zZm9ybTogInNjYWxlKDAuNzUpIiB9LCB7IHRyYW5zZm9ybTogInNjYWxlKDEpIiB9XSwgeyBkdXJhdGlvbjogMjAwLCBlYXNpbmc6ICJlYXNlLWluLW91dCIgfQogICAgICApOwogICAgfTsKICAgIGNvbnN0IHNldENvbCA9IChjb2wpID0+IHsKICAgICAgdGVtcFN0b3JlLmNvbG9yID0gY29sOwogICAgICBjb25zdCByZ2IgPSBjb2xvclV0aWwuaGV4VG9SZ2IoY29sKTsKICAgICAgaWYgKGlzUE0pIHsKICAgICAgICBlZGl0b3Iuc2V0Q29sb3IoCiAgICAgICAgICBjb2wsCiAgICAgICAgICBjb2xvclV0aWwucmdiQXJyYXlUb0hleChjb2xvclV0aWwuZGFya2VuKHJnYiwgMC4xKSksCiAgICAgICAgICBjb2xvclV0aWwucmdiQXJyYXlUb0hleChjb2xvclV0aWwuZGFya2VuKHJnYiwgMC4yKSkKICAgICAgICApOwogICAgICB9IGVsc2UgewogICAgICAgIGVkaXRvci5zZXRDb2xvdXIoLi4udGhlbWVpZnlDb2xvcihjb2wpKTsKICAgICAgICBlZGl0b3IudXBkYXRlRGlzcGxheV8oKTsKICAgICAgfQogICAgfTsKCiAgICBjb25zdCBjb2xvckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgY29sb3JEaXYuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJkaXNwbGF5OiBmbGV4OyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgYWxpZ24taXRlbXM6IGNlbnRlcjsgbWFyZ2luLXRvcDogMTVweDsgYm9yZGVyLXJhZGl1czogMTBweDsiKTsKICAgIGlmIChpc1BNKSBjb2xvckRpdi5zdHlsZS5tYXJnaW5Cb3R0b20gPSAiMTVweCI7CiAgICBjb2xvckRpdi5zdHlsZS5ib3JkZXIgPSBgc29saWQgJHtpc0RhcmsgPyAiIzM0MzQzNCIgOiAiI0Q5RDlEOSJ9IDIuNXB4YDsKCiAgICBjb25zdCBjb2xvckxpc3QgPSBpc1BNID8gU2NyYXRjaEJsb2Nrcy5Db2xvdXJzIDogUmVkdXhTdG9yZS5nZXRTdGF0ZSgpLnNjcmF0Y2hHdWkudGhlbWUudGhlbWUuZ2V0U3RhZ2VCbG9ja0NvbG9ycygpOwogICAgY29uc3QgY29sb3JzID0gWwogICAgICBjb2xvckxpc3QubW90aW9uLnByaW1hcnksIGNvbG9yTGlzdC5sb29rcy5wcmltYXJ5LCBjb2xvckxpc3Quc291bmRzLnByaW1hcnksCiAgICAgIGNvbG9yTGlzdC5ldmVudC5wcmltYXJ5LCBjb2xvckxpc3QuY29udHJvbC5wcmltYXJ5LCBjb2xvckxpc3Quc2Vuc2luZy5wcmltYXJ5LAogICAgICBjb2xvckxpc3Qub3BlcmF0b3JzLnByaW1hcnksIGNvbG9yTGlzdC5kYXRhLnByaW1hcnksIGNvbG9yTGlzdC5kYXRhX2xpc3RzLnByaW1hcnksCiAgICAgIGNvbG9yTGlzdC5tb3JlLnByaW1hcnksIGNvbG9yTGlzdC5wZW4ucHJpbWFyeSwgInJlZCIsCiAgICBdOwogICAgY29sb3JzLmZvckVhY2goY29sb3IgPT4gewogICAgICBjb25zdCBjaXJjbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgY2lyY2xlLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAid2lkdGg6IDM1cHg7IGhlaWdodDogMzVweDsgYm9yZGVyLXJhZGl1czogNTAlOyBib3JkZXI6IDIuNXB4IHNvbGlkIHJnYmEoMCwgMCwgMCwgMC4xMyk7IG1hcmdpbjogN3B4OyBjdXJzb3I6IHBvaW50ZXI7Iik7CiAgICAgIGNpcmNsZS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKICAgICAgY2lyY2xlLnN0eWxlLmJveFNoYWRvdyA9IGAwcHggMHB4IDBweCAyLjVweCAke2lzRGFyayA/ICIjMzQzNDM0IiA6ICIjRDlEOUQ5In1gOwogICAgICBjb2xvckRpdi5hcHBlbmRDaGlsZChjaXJjbGUpOwogICAgICBpZiAoY29sb3IgPT09ICJyZWQiKSB7CiAgICAgICAgY29uc3QgaW5uZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgICBpbm5lckltZy5zcmMgPSBndWlVUklzKCJjb2xvclBrciIpOwogICAgICAgIGlubmVySW1nLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAid2lkdGg6IDI1cHg7IGhlaWdodDogMjVweDsgcG9zaXRpb246IHJlbGF0aXZlOyBwYWRkaW5nOiAycHg7IGxlZnQ6IDUwJTsgdG9wOiA1MCU7IHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOyIpOwogICAgICAgIGNpcmNsZS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICAgIGJvdW5jZUFuaW0oY2lyY2xlKTsKICAgICAgICAgIGNvbElucC5jbGljaygpOwogICAgICAgIH0pOwoKICAgICAgICBjb25zdCBjb2xJbnAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgIGNvbElucC50eXBlID0gImNvbG9yIjsKICAgICAgICBjb2xJbnAuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJvcGFjaXR5OiAwOyBjdXJzb3I6IHBvaW50ZXI7IHdpZHRoOiAxcHg7IGhlaWdodDogMXB4OyB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgxNXB4LCAtMjVweCk7Iik7CiAgICAgICAgY2lyY2xlLmFwcGVuZChpbm5lckltZywgY29sSW5wKTsKICAgICAgICBjb2xJbnAuYWRkRXZlbnRMaXN0ZW5lcigiaW5wdXQiLCAoKSA9PiB7CiAgICAgICAgICBjaXJjbGUuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sSW5wLnZhbHVlOwogICAgICAgICAgc2V0Q29sKGNvbElucC52YWx1ZSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2lyY2xlLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gewogICAgICAgICAgYm91bmNlQW5pbShjaXJjbGUpOwogICAgICAgICAgc2V0Q29sKGNvbG9yKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBpZiAoIXRlbXBTdG9yZS5jb2xvcikgc2V0Q29sKGNvbG9yc1s5XSk7CiAgICByb3cucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY29sb3JEaXYsIHJvdy5wYXJlbnROb2RlLmxhc3RDaGlsZC5wcmV2aW91c1NpYmxpbmcpOwogIH0KCiAgLy8gQ3VzdG9tIE1pbmkgTW9kYWxzCiAgZnVuY3Rpb24gb3Blbk1vZGFsKHRpdGxlTmFtZSwgd29ya2VyRm4sIGNhbGxiYWNrRm4pIHsKICAgIGNvbnN0IG1vZGFsU3RvcmFnZSA9IHt9OwogICAgU2NyYXRjaEJsb2Nrcy5wcm9tcHQoCiAgICAgICIiLCAiIiwgKCkgPT4gY2FsbGJhY2tGbihtb2RhbFN0b3JhZ2UudmFsdWUpLAogICAgICB0aXRsZU5hbWUsICJicm9hZGNhc3RfbXNnIgogICAgKTsKCiAgICBsZXQgbW9kYWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGBkaXZbY2xhc3M9IlJlYWN0TW9kYWxQb3J0YWwiXWApOwogICAgbW9kYWwgPSBtb2RhbFttb2RhbC5sZW5ndGggLSAxXTsKICAgIG1vZGFsLnN0eWxlLnBvc2l0aW9uID0gInJlbGF0aXZlIjsgbW9kYWwuc3R5bGUuekluZGV4ID0gIjk5OTk5IjsKICAgIGNvbnN0IGJveE1vZGFsID0gbW9kYWwucXVlcnlTZWxlY3RvcigiaW5wdXQiKS5wYXJlbnROb2RlOwogICAgYm94TW9kYWwucHJldmlvdXNTaWJsaW5nLnJlbW92ZSgpOyBib3hNb2RhbC5maXJzdENoaWxkLnJlbW92ZSgpOwogICAgd29ya2VyRm4oYm94TW9kYWwsIG1vZGFsU3RvcmFnZSk7CiAgfQoKICBmdW5jdGlvbiBvcGVuTWVudVNlbGVjdG9yKGVkaXRvciwgaXNEYXJrLCBvZ1dvcmtzcGFjZSkgewogICAgY29uc3QgYXJyb3dJY29uID0gaXNQTSA/ICJzdGF0aWMvYmxvY2tzLW1lZGlhL2Ryb3Bkb3duLWFycm93IiA6ICIvc3RhdGljL2Jsb2Nrcy1tZWRpYS9kZWZhdWx0L2Ryb3Bkb3duLWFycm93IjsKCiAgICAvLyBHZXQgQWxsIERyb3Bkb3ducwogICAgY29uc3QgYXZvaWQgPSBbImxvb2tzX2Nvc3R1bWVudW1iZXJuYW1lIiwgImV4dGVuc2lvbl93ZWRvX3RpbHRfbWVudSIsICJsbXNNb3JlRXZlbnRzX21lbnVfc3RhdGUiXTsKICAgIGxldCBhbGxCbG9ja3MgPSBPYmplY3Qua2V5cyhTY3JhdGNoQmxvY2tzLkJsb2Nrcyk7CiAgICBhbGxCbG9ja3MgPSBhbGxCbG9ja3MuZmlsdGVyKChpKSA9PiBpLmluY2x1ZGVzKCJtZW51IikgJiYgIWF2b2lkLmluY2x1ZGVzKGkpKTsKICAgIGFsbEJsb2Nrcy51bnNoaWZ0KCJsb29rc19jb3N0dW1lIiwgImxvb2tzX2JhY2tkcm9wcyIsICJzZW5zaW5nX2tleW9wdGlvbnMiKTsKICAgIGFsbEJsb2Nrcy5mb3JFYWNoKChlLCBpKSA9PiB7CiAgICAgIGlmIChlLnN0YXJ0c1dpdGgoQ1VTVE9NX01FTlVfSUQpKSB7CiAgICAgICAgYWxsQmxvY2tzLnVuc2hpZnQoZSk7CiAgICAgICAgYWxsQmxvY2tzLnNwbGljZShpICsgMSwgMSk7CiAgICAgIH0KICAgIH0pOwoKICAgIG9wZW5Nb2RhbCgKICAgICAgU2NyYXRjaC50cmFuc2xhdGUoIlNlbGVjdCBhIERyb3Bkb3duIiksCiAgICAgIChtb2RhbCwgbW9kYWxTdG9yYWdlKSA9PiB7CiAgICAgICAgbW9kYWxTdG9yYWdlLnZhbHVlID0gYWxsQmxvY2tzWzBdOwogICAgICAgIGNvbnN0IGRyb3BEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkcm9wRGl2LnNldEF0dHJpYnV0ZSgic3R5bGUiLCBgd2lkdGg6IDEwMCU7IGhlaWdodDogMjAwcHg7IG1hcmdpbi1ib3R0b206IDE1cHg7IG92ZXJmbG93OiBzY3JvbGw7IHJlc2l6ZTogYmxvY2s7Ym9yZGVyOiBzb2xpZCAke2lzRGFyayA/ICIjMzQzNDM0IiA6ICIjRDlEOUQ5In0gMnB4OyBib3JkZXItcmFkaXVzOiAxMHB4O2ApOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWxsQmxvY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBkcm9wSXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLCB0ZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksIHByZXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIGRyb3BJdGVtLnNldEF0dHJpYnV0ZSgic3R5bGUiLCBgY3Vyc29yOiBwb2ludGVyOyBwYWRkaW5nOiA4cHg7IHdpZHRoOiAxMDAlOyBoZWlnaHQ6IG1heC1jb250ZW50OyBkaXNwbGF5OiBmbGV4OyBmbGV4LWRpcmVjdGlvbjogY29sdW1uOyBhbGlnbi1pdGVtczogY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjtgKTsKICAgICAgICAgIGRyb3BJdGVtLmFwcGVuZChwcmV2LCB0ZXh0KTsKICAgICAgICAgIHRleHQudGV4dENvbnRlbnQgPSBhbGxCbG9ja3NbaV0ucmVwbGFjZShDVVNUT01fTUVOVV9JRCwgIiIpOwoKICAgICAgICAgIGNvbnN0IGlzQ3VzdG9tID0gYWxsQmxvY2tzW2ldLmluY2x1ZGVzKENVU1RPTV9NRU5VX0lEKTsKICAgICAgICAgIGNvbnN0IGJsb2NrID0gb2dXb3Jrc3BhY2UuZ2V0QmxvY2tCeUlkKGFsbEJsb2Nrc1tpXSk7CiAgICAgICAgICBsZXQgcHJldlR4dCA9IGJsb2NrID8gYmxvY2suaW5wdXRMaXN0WzBdLmZpZWxkUm93WzBdLnRleHRfLnN1YnN0cmluZygwLCAxNykgOiAiIjsKICAgICAgICAgIGlmIChwcmV2VHh0Lmxlbmd0aCA9PT0gMTcpIHByZXZUeHQgKz0gIi4uLiI7CiAgICAgICAgICBwcmV2Lm91dGVySFRNTCA9IGAKICAgICAgICAgICAgPGRpdiBzdHlsZT0iY29sb3I6ICNmZmY7IGJhY2tncm91bmQ6ICR7aXNDdXN0b20gPyAiI0ZGNjY4MCIgOiBibG9jayA/IGJsb2NrLmNvbG91cl8gOiAiIzUwNTA1MCJ9OyBib3JkZXItcmFkaXVzOiAke2Jsb2NrID8gNTAgOiA1fXB4OyB3aWR0aDogbWF4LWNvbnRlbnQ7IHRleHQtYWxpZ246IGNlbnRlcjsgbWFyZ2luLWJvdHRvbTogNXB4OyBwYWRkaW5nOiA1cHggMTBweCA1cHggMTBweDsgZm9udC13ZWlnaHQ6IDUwMDsgYm9yZGVyOiBzb2xpZCAxcHggcmdiYSgwLDAsMCwwLjMpIj4KICAgICAgICAgICAgICA8c3Bhbj4ke2Jsb2NrID8gcHJldlR4dCA6ICI/Pz8ifTwvc3Bhbj48aW1nIHN0eWxlPSJtYXJnaW4tbGVmdDogNXB4OyIgc3JjPSIke2Fycm93SWNvbn0uc3ZnIj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICBgOwoKICAgICAgICAgIGNvbnN0IGJnQ29sb3IgPSBpICUgMiA9PT0gMCA/IGlzQ3VzdG9tID8gIiNjYzUyNjY0MCIgOiAiI2FhYTMiIDogaXNDdXN0b20gPyAiI2NjNTI2NjgwIiA6ICJ0cmFuc3BhcmVudCI7CiAgICAgICAgICBkcm9wSXRlbS5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBgdmFyKC0tc2VsZWN0ZWQtY29sb3IsICR7YmdDb2xvcn0pYDsKICAgICAgICAgIGlmIChpID09PSAwKSBkcm9wSXRlbS5zdHlsZS5zZXRQcm9wZXJ0eSgiLS1zZWxlY3RlZC1jb2xvciIsIGlzQ3VzdG9tID8gIiNmNzg4OWE5OSIgOiAiI2FhYWEiKTsKICAgICAgICAgIGRyb3BEaXYuYXBwZW5kQ2hpbGQoZHJvcEl0ZW0pOwogICAgICAgICAgZHJvcEl0ZW0uYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgICAgICAgIEFycmF5LmZyb20oZHJvcERpdi5jaGlsZHJlbikuZm9yRWFjaChjID0+IGMuc3R5bGUucmVtb3ZlUHJvcGVydHkoIi0tc2VsZWN0ZWQtY29sb3IiKSk7CiAgICAgICAgICAgIGRyb3BJdGVtLnN0eWxlLnNldFByb3BlcnR5KCItLXNlbGVjdGVkLWNvbG9yIiwgaXNDdXN0b20gPyAiI2Y3ODg5YTk5IiA6ICIjYWFhYSIpOwogICAgICAgICAgICBtb2RhbFN0b3JhZ2UudmFsdWUgPSBhbGxCbG9ja3NbaV07CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgbW9kYWwuaW5zZXJ0QmVmb3JlKGRyb3BEaXYsIG1vZGFsLmxhc3RDaGlsZCk7CiAgICAgIH0sCiAgICAgICh2YWx1ZSkgPT4gewogICAgICAgIGVkaXRvci5hZGRTdHJpbmdOdW1iZXJFeHRlcm5hbCgpOwogICAgICAgIGNvbnN0IGFyZ3MgPSBlZGl0b3IuYXJndW1lbnRJZHNfOwogICAgICAgIGNvbnN0IGlkID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwogICAgICAgIGVkaXRvci5kaXNwbGF5TmFtZXNfW2FyZ3MubGVuZ3RoIC0gMV0gPSB2YWx1ZS5yZXBsYWNlKENVU1RPTV9NRU5VX0lELCAiIik7CiAgICAgICAgZWRpdG9yLnVwZGF0ZURpc3BsYXlfKCk7CiAgICAgICAgZWRpdG9yLmZvY3VzTGFzdEVkaXRvcl8oKTsKCiAgICAgICAgY29uc3QgaW5wdXRzID0gdGVtcFN0b3JlLmlucHV0cyB8fCB7fTsKICAgICAgICBpbnB1dHNbaWRdID0geyB0eXBlOiB2YWx1ZSwgaXNEcm9wOiB0cnVlIH07CiAgICAgICAgdGVtcFN0b3JlLmlucHV0cyA9IGlucHV0czsKICAgICAgICBjbGVhbnVwQmxvY2tJbnB1dHMoaW5wdXRzLCBhcmdzKTsKICAgICAgfQogICAgKTsKICB9CgogIC8vIEltYWdlIE1vZGFsCiAgZnVuY3Rpb24gb3BlbkltZ1NlbGVjdG9yKGVkaXRvciwgaXNEYXJrLCBvZ1dvcmtzcGFjZSkgewogICAgLy8gR2V0IEFsbCBJbWFnZXMKICAgIGNvbnN0IGltYWdlcyA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IGV4dHJhY3RJbWFnZSA9IChibG9jaykgPT4gewogICAgICBpZiAoIWJsb2NrLmluaXQpIHJldHVybjsKICAgICAgbGV0IGpzb24gPSB7fTsKICAgICAgY29uc3QganNvbkluaXQgPSAoanNvbjApID0+IHsganNvbiA9IGpzb24wOyB9OwogICAgICB0cnkgewogICAgICAgIGJsb2NrLmluaXQuY2FsbCh7IGpzb25Jbml0IH0pOwogICAgICB9IGNhdGNoIHsgcmV0dXJuIH0KCiAgICAgIGZvciAoY29uc3Qga2V5IGluIGpzb24pIHsKICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoImFyZ3MiKSkgZm9yIChjb25zdCBhcmcgb2YganNvbltrZXldKSB7CiAgICAgICAgICBpZiAoYXJnLnR5cGUgPT09ICJmaWVsZF9pbWFnZSIgJiYgYXJnLnNyYykgaW1hZ2VzLmFkZChhcmcuc3JjKTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgICBPYmplY3QudmFsdWVzKFNjcmF0Y2hCbG9ja3MuQmxvY2tzKS5mb3JFYWNoKGV4dHJhY3RJbWFnZSk7CgogICAgY29uc3Qgc2VsZWN0QnRuID0gKGRyb3BEaXYsIGJ0bikgPT4gewogICAgICBBcnJheS5mcm9tKGRyb3BEaXYuY2hpbGRyZW4pLmZvckVhY2goYyA9PiB7CiAgICAgICAgYy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidmFyKC0tZGVmYXVsdC1iZykiOwogICAgICAgIGMuc3R5bGUuYm9yZGVyID0gInNvbGlkIHZhcigtLWRlZmF1bHQtYm9yZGVyKSAycHgiOwogICAgICB9KTsKICAgICAgYnRuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ2YXIoLS1sb29rcy10cmFuc3BhcmVudCwgaHNsYSgxOTQsIDEwMCUsIDUwJSwgMC4zNSkpIjsKICAgICAgYnRuLnN0eWxlLmJvcmRlciA9ICJzb2xpZCB2YXIoLS1sb29rcy1zZWNvbmRhcnksIGhzbCgxOTQsIDEwMCUsIDUwJSkpIDJweCI7CiAgICB9OwoKICAgIG9wZW5Nb2RhbCgKICAgICAgIlNlbGVjdCBhbiBJbWFnZSIsCiAgICAgIChtb2RhbCwgbW9kYWxTdG9yYWdlKSA9PiB7CiAgICAgICAgY29uc3QgZmxleENvbnN0ID0gImRpc3BsYXk6IGZsZXg7IGZsZXgtd3JhcDogd3JhcDsgYWxpZ24taXRlbXM6IGNlbnRlcjsganVzdGlmeS1jb250ZW50OiBjZW50ZXI7IjsKICAgICAgICBjb25zdCBib3JkZXJDb25zdCA9IGBib3JkZXI6IHNvbGlkIHZhcigtLWRlZmF1bHQtYm9yZGVyKSAycHg7IGJvcmRlci1yYWRpdXM6IDEwcHg7YDsKICAgICAgICBjb25zdCBpdGVtQ1NTID0gYGN1cnNvcjogcG9pbnRlcjsgd2lkdGg6IDc1cHg7IGhlaWdodDogNzVweDsgJHtmbGV4Q29uc3R9IHBhZGRpbmc6IDVweDsgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tZGVmYXVsdC1iZyk7IG1hcmdpbjogN3B4OyAke2JvcmRlckNvbnN0fSAtLWRlZmF1bHQtYm9yZGVyOiAke2lzRGFyayA/ICIjMzQzNDM0IiA6ICIjRDlEOUQ5In07IC0tZGVmYXVsdC1iZzogJHtpc0RhcmsgPyAiIzFmMWYxZiIgOiAiI2Y1ZjVmNSJ9O2A7CgogICAgICAgIGNvbnN0IGRyb3BEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICBkcm9wRGl2LnNldEF0dHJpYnV0ZSgic3R5bGUiLCBgd2lkdGg6IDEwMCU7IGhlaWdodDogMjAwcHg7ICR7ZmxleENvbnN0fSBvdmVyZmxvdzogaGlkZGVuIHNjcm9sbDsgbWFyZ2luLWJvdHRvbTogMTVweDsgJHtib3JkZXJDb25zdH0gLS1kZWZhdWx0LWJvcmRlcjogJHtpc0RhcmsgPyAiIzM0MzQzNCIgOiAiI0Q5RDlEOSJ9O2ApOwoKICAgICAgICBjb25zdCBkcm9wSXRlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIGRyb3BJdGVtLnNldEF0dHJpYnV0ZSgic3R5bGUiLCBpdGVtQ1NTKTsKICAgICAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbWciKTsKICAgICAgICBpbWcuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJ3aWR0aDogNzUlOyBoZWlnaHQ6IDc1JTsiKTsKICAgICAgICBpbWcuc3JjID0gZ3VpVVJJcygiYWRkSW1nIik7CiAgICAgICAgCiAgICAgICAgY29uc3QgdGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgIHRleHQuc2V0QXR0cmlidXRlKCJzdHlsZSIsICJ0ZXh0LXdyYXA6IG5vd3JhcDsgZm9udC1zaXplOiA2MCU7Iik7CiAgICAgICAgdGV4dC50ZXh0Q29udGVudCA9ICJDdXN0b20gSW1hZ2UiOwogICAgICAgIGRyb3BJdGVtLmFwcGVuZChpbWcsIHRleHQpOwoKICAgICAgICBkcm9wRGl2LmFwcGVuZENoaWxkKGRyb3BJdGVtKTsKICAgICAgICBkcm9wSXRlbS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICAgIGNvbnN0IHNyYyA9IHByb21wdCgiRW50ZXIgdGhlIFVSTCBvciBEYXRhLlVSSSBvZiB5b3VyIGltYWdlOiIpOwogICAgICAgICAgaWYgKHNyYykgewogICAgICAgICAgICBtb2RhbFN0b3JhZ2UudmFsdWUgPSBzcmM7CiAgICAgICAgICAgIHNlbGVjdEJ0bihkcm9wRGl2LCBkcm9wSXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIGltYWdlcy5mb3JFYWNoKChpbWFnZSwgaSwgZCkgPT4gewogICAgICAgICAgY29uc3QgZHJvcEl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIGRyb3BJdGVtLnNldEF0dHJpYnV0ZSgic3R5bGUiLCBpdGVtQ1NTKTsKICAgICAgICAgIGNvbnN0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImltZyIpOwogICAgICAgICAgaW1nLnNldEF0dHJpYnV0ZSgic3R5bGUiLCAid2lkdGg6IDEwMCU7IGhlaWdodDogMTAwJTsiKTsKICAgICAgICAgIGltZy5zcmMgPSBpbWFnZTsKICAgICAgICAgIGRyb3BJdGVtLmFwcGVuZENoaWxkKGltZyk7CgogICAgICAgICAgZHJvcERpdi5hcHBlbmRDaGlsZChkcm9wSXRlbSk7CiAgICAgICAgICBkcm9wSXRlbS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICAgICAgc2VsZWN0QnRuKGRyb3BEaXYsIGRyb3BJdGVtKTsKICAgICAgICAgICAgbW9kYWxTdG9yYWdlLnZhbHVlID0gaW1hZ2U7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBtb2RhbC5pbnNlcnRCZWZvcmUoZHJvcERpdiwgbW9kYWwubGFzdENoaWxkKTsKICAgICAgfSwKICAgICAgKHZhbHVlKSA9PiB7CiAgICAgICAgaWYgKCF2YWx1ZSkgcmV0dXJuOwogICAgICAgIGVkaXRvci5hZGRTdHJpbmdOdW1iZXJFeHRlcm5hbCgpOwogICAgICAgIGNvbnN0IGFyZ3MgPSBlZGl0b3IuYXJndW1lbnRJZHNfOwogICAgICAgIGNvbnN0IGlkID0gYXJnc1thcmdzLmxlbmd0aCAtIDFdOwogICAgICAgIGVkaXRvci5kaXNwbGF5TmFtZXNfW2FyZ3MubGVuZ3RoIC0gMV0gPSAiaW1hZ2UiOwogICAgICAgIGVkaXRvci51cGRhdGVEaXNwbGF5XygpOwogICAgICAgIGVkaXRvci5mb2N1c0xhc3RFZGl0b3JfKCk7CgogICAgICAgIGNvbnN0IGlucHV0cyA9IHRlbXBTdG9yZS5pbnB1dHMgfHwge307CiAgICAgICAgaW5wdXRzW2lkXSA9IHsgdHlwZTogImltZyIsIGlzRHJvcDogZmFsc2UsIHNyYzogc3RvcmVJbWFnZSh2YWx1ZSkgfTsKICAgICAgICB0ZW1wU3RvcmUuaW5wdXRzID0gaW5wdXRzOwogICAgICAgIGNsZWFudXBCbG9ja0lucHV0cyhpbnB1dHMsIGFyZ3MpOwogICAgICB9CiAgICApOwogIH0KCiAgLy8gQ29tcGlsZXIgUGF0Y2hlcwogIGZ1bmN0aW9uIGdldEV4cG9ydHMoKSB7CiAgICBpZiAodm0uZXhwb3J0cy5pX3dpbGxfbm90X2Fza19mb3JfaGVscF93aGVuX3RoZXNlX2JyZWFrKSByZXR1cm4gdm0uZXhwb3J0cy5pX3dpbGxfbm90X2Fza19mb3JfaGVscF93aGVuX3RoZXNlX2JyZWFrKCk7CiAgICBlbHNlIGlmICh2bS5leHBvcnRzLkpTR2VuZXJhdG9yICYmIHZtLmV4cG9ydHMuSVJHZW5lcmF0b3I/LmV4cG9ydHMpIHJldHVybiB7CiAgICAgIC4uLnZtLmV4cG9ydHMsIFNjcmlwdFRyZWVHZW5lcmF0b3I6IHZtLmV4cG9ydHMuSVJHZW5lcmF0b3IuZXhwb3J0cy5TY3JpcHRUcmVlR2VuZXJhdG9yCiAgICB9OwogIH0KICBjb25zdCBleHBvcnRzID0gZ2V0RXhwb3J0cygpOwogIGlmIChleHBvcnRzKSB7CiAgICBjb25zdCBzYW5pdGl6ZSA9IHN0cmluZyA9PiB7CiAgICAgIGlmICh0eXBlb2Ygc3RyaW5nICE9PSAic3RyaW5nIikgewogICAgICAgIGNvbnNvbGUud2Fybihgc2FuaXRpemUgZ290IHVuZXhwZWN0ZWQgdHlwZTogJHt0eXBlb2Ygc3RyaW5nfWApOwogICAgICAgIHN0cmluZyA9ICIiICsgc3RyaW5nOwogICAgICB9CiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShzdHJpbmcpLnNsaWNlKDEsIC0xKTsKICAgIH07CgogICAgVGhyZWFkID0gZXhwb3J0cy5UaHJlYWQ7IGV4ZWN1dGUgPSBleHBvcnRzLmV4ZWN1dGU7CiAgICBjb25zdCB7IEpTR2VuZXJhdG9yLCBTY3JpcHRUcmVlR2VuZXJhdG9yIH0gPSBleHBvcnRzOwogICAgY29uc3QgZXhwID0gSlNHZW5lcmF0b3IuZXhwb3J0cyA9PT0gdW5kZWZpbmVkID8gSlNHZW5lcmF0b3IudW5zdGFibGVfZXhwb3J0cyA6IEpTR2VuZXJhdG9yLmV4cG9ydHM7CiAgICBpZiAoIWlzUE0pIHsKICAgICAgSlNHZW5lcmF0b3IucHJvdG90eXBlLmlzTGFzdEJsb2NrSW5Mb29wID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuZnJhbWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICBjb25zdCBmcmFtZSA9IHRoaXMuZnJhbWVzW2ldOwogICAgICAgICAgaWYgKGZyYW1lLm1icFJ1bm5pbmdCcmFuY2gpIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmICghZnJhbWUuaXNMYXN0QmxvY2spIHJldHVybiBmYWxzZTsKICAgICAgICAgIGlmIChmcmFtZS5pc0xvb3ApIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IF9vZ0lSZGVzY2VuZFN0YWNrID0gU2NyaXB0VHJlZUdlbmVyYXRvci5wcm90b3R5cGUuZGVzY2VuZFN0YWNrZWRCbG9jazsKICAgIFNjcmlwdFRyZWVHZW5lcmF0b3IucHJvdG90eXBlLmRlc2NlbmRTdGFja2VkQmxvY2sgPSBmdW5jdGlvbihibG9jaykgewogICAgICBzd2l0Y2ggKGJsb2NrLm9wY29kZSkgewogICAgICAgIGNhc2UgInByb2NlZHVyZXNfY2FsbCI6IHsKICAgICAgICAgIGNvbnN0IHByb2MgPSBibG9jay5tdXRhdGlvbi5wcm9jY29kZTsKICAgICAgICAgIGNvbnN0IHN0b3JlID0gc3RvcmVHZXQocHJvYywgdGhpcy50YXJnZXQuc3ByaXRlLmNsb25lc1swXSk7CiAgICAgICAgICBpZiAoIXRoaXMudGhyZWFkW3RhcmdldFByb2NEYXRhXSkgdGhpcy50aHJlYWRbdGFyZ2V0UHJvY0RhdGFdID0ge307CiAgICAgICAgICB0aGlzLnRocmVhZFt0YXJnZXRQcm9jRGF0YV1bcHJvY10gPSB7IGJsb2NrLCBzdG9yZSB9OyAvLyBhdHRhY2ggc29tZSBkYXRhIHdlIG5lZWQKICAgICAgICAgIGlmICghc3RvcmUgfHwgIXN0b3JlLmlucHV0cykgcmV0dXJuIF9vZ0lSZGVzY2VuZFN0YWNrLmNhbGwodGhpcywgYmxvY2spOwoKICAgICAgICAgIC8vIGlnbm9yZSBicmFuY2hlcyB0ZW1wb3JhcmlseQogICAgICAgICAgY29uc3QgYXJnSWRzID0gSlNPTi5wYXJzZShibG9jay5tdXRhdGlvbi5hcmd1bWVudGlkcyk7CiAgICAgICAgICBjb25zdCBhcHBlbmRlcnMgPSBbXTsKICAgICAgICAgIGNvbnN0IHRlbXBCbG9jayA9IHN0cnVjdHVyZWRDbG9uZShibG9jayk7CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ0lkcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCBpbnB1dCA9IGJsb2NrLmlucHV0c1thcmdJZHNbaV1dOwogICAgICAgICAgICBpZiAoc3RvcmUuaW5wdXRzW2lucHV0Py5uYW1lXT8udHlwZSA9PT0gImJyYyIpIHsKICAgICAgICAgICAgICBhcHBlbmRlcnMucHVzaChbaSwgaW5wdXQuYmxvY2tdKTsKICAgICAgICAgICAgICBkZWxldGUgdGVtcEJsb2NrLmlucHV0c1tpbnB1dC5uYW1lXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIHRoaXMudGhyZWFkW3RhcmdldFByb2NEYXRhXVtwcm9jXS5hcHBlbmRlcnMgPSBhcHBlbmRlcnM7CiAgICAgICAgICBjb25zdCBub2RlID0gX29nSVJkZXNjZW5kU3RhY2suY2FsbCh0aGlzLCB0ZW1wQmxvY2spOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcHBlbmRlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgbm9kZS5hcmd1bWVudHNbYXBwZW5kZXJzW2ldWzBdXSA9IHsga2luZDogImNvbnN0YW50IiwgbWJwS2V5OiB0cnVlLCB2YWx1ZTogdGhpcy53YWxrU3RhY2soYXBwZW5kZXJzW2ldWzFdKSB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGNhc2UgIlNQbWJwQ1NUX3NldFBhcmFtIjogewogICAgICAgICAgbGV0IHBhcmFtSW5kZXggPSB0aGlzLnNjcmlwdC5hcmd1bWVudHMubGFzdEluZGV4T2YoYmxvY2suZmllbGRzLlBBUkFNLnZhbHVlKTsKICAgICAgICAgIGlmIChwYXJhbUluZGV4ID09PSAtMSkgewogICAgICAgICAgICBwYXJhbUluZGV4ID0gdGhpcy5zY3JpcHQuYXJndW1lbnRzLmxlbmd0aDsKICAgICAgICAgICAgdGhpcy5zY3JpcHQuYXJndW1lbnRzLnB1c2goYmxvY2suZmllbGRzLlBBUkFNLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGtpbmQ6ICJTUG1icENTVC5zZXRQYXJhbSIsIHBhcmFtSW5kZXgsIHZhbDogdGhpcy5kZXNjZW5kSW5wdXRPZkJsb2NrKGJsb2NrLCAiVkFMVUUiKQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgY2FzZSAiU1BtYnBDU1RfZXZhbFBhcmFtIjogewogICAgICAgICAgY29uc3Qgbm9kZSA9IHsga2luZDogIlNQbWJwQ1NULmV2YWxQYXJhbSIgfTsKICAgICAgICAgIGlmICghdGhpcy50aHJlYWRbdGFyZ2V0UHJvY0RhdGFdKSByZXR1cm4gbm9kZTsKICAgICAgICAgIGNvbnN0IHByb2NEYXRhID0gdGhpcy50aHJlYWRbdGFyZ2V0UHJvY0RhdGFdW3RoaXMuc2NyaXB0LnByb2NlZHVyZUNvZGVdOwogICAgICAgICAgY29uc3QgcHJvY2VkdXJlQmxvY2sgPSBwcm9jRGF0YT8uYmxvY2s7CiAgICAgICAgICBpZiAocHJvY2VkdXJlQmxvY2spIHsKICAgICAgICAgICAgY29uc3QgcGFyYW1JbmRleCA9IHRoaXMuc2NyaXB0LmFyZ3VtZW50cy5sYXN0SW5kZXhPZihibG9jay5maWVsZHMuUEFSQU0udmFsdWUpOwogICAgICAgICAgICBjb25zdCBhcmdJZHMgPSBKU09OLnBhcnNlKHByb2NlZHVyZUJsb2NrLm11dGF0aW9uLmFyZ3VtZW50aWRzKTsKICAgICAgICAgICAgaWYgKHBhcmFtSW5kZXggPiAtMSkgewogICAgICAgICAgICAgIGNvbnN0IGFyZyA9IHByb2NlZHVyZUJsb2NrLmlucHV0c1thcmdJZHNbcGFyYW1JbmRleF1dOwogICAgICAgICAgICAgIGlmIChhcmc/LmJsb2NrICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gdGhpcy50YXJnZXQuYmxvY2tzLmdldEJsb2NrKGFyZy5ibG9jayk7CiAgICAgICAgICAgICAgICBub2RlWyJpbnB1dCJdID0gdGhpcy5kZXNjZW5kSW5wdXQoaW5wdXQpOwogICAgICAgICAgICAgICAgbm9kZVsiaW5kZXgiXSA9IHBhcmFtSW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAiU1BtYnBDU1RfcnVuQnJhbmNoIjogewogICAgICAgICAgY29uc3Qgbm9kZSA9IHsga2luZDogIlNQbWJwQ1NULnJ1bkJyYW5jaCIsIGluZGV4OiB0aGlzLmRlc2NlbmRJbnB1dE9mQmxvY2soYmxvY2ssICJJTkRFWCIpIH07CiAgICAgICAgICBpZiAoIXRoaXMudGhyZWFkW3RhcmdldFByb2NEYXRhXSkgcmV0dXJuIG5vZGU7CiAgICAgICAgICBjb25zdCBwcm9jRGF0YSA9IHRoaXMudGhyZWFkW3RhcmdldFByb2NEYXRhXVt0aGlzLnNjcmlwdC5wcm9jZWR1cmVDb2RlXTsKICAgICAgICAgIGNvbnN0IHByb2NlZHVyZUJsb2NrID0gcHJvY0RhdGE/LmJsb2NrOwogICAgICAgICAgaWYgKHByb2NlZHVyZUJsb2NrKSBub2RlLmFwcGVuZGVycyA9IHByb2NEYXRhLmFwcGVuZGVyczsKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiByZXR1cm4gX29nSVJkZXNjZW5kU3RhY2suY2FsbCh0aGlzLCBibG9jayk7CiAgICAgIH0KICAgIH07CiAgICBjb25zdCBfb2dJUmRlc2NlbmRJbnAgPSBTY3JpcHRUcmVlR2VuZXJhdG9yLnByb3RvdHlwZS5kZXNjZW5kSW5wdXQ7CiAgICBTY3JpcHRUcmVlR2VuZXJhdG9yLnByb3RvdHlwZS5kZXNjZW5kSW5wdXQgPSBmdW5jdGlvbihibG9jaykgewogICAgICBpZiAoYmxvY2sub3Bjb2RlID09PSAiU1BtYnBDU1RfZ2V0UGFyYW0iKSByZXR1cm4geyBraW5kOiAiU1BtYnBDU1QuZ2V0UGFyYW0iLCBwYXJhbTogdGhpcy5kZXNjZW5kSW5wdXRPZkJsb2NrKGJsb2NrLCAiUEFSQU0iKSB9OwogICAgICBlbHNlIHJldHVybiBfb2dJUmRlc2NlbmRJbnAuY2FsbCh0aGlzLCBibG9jayk7CiAgICB9OwogICAgY29uc3QgX29nSlNkZXNjZW5kU3RhY2sgPSBKU0dlbmVyYXRvci5wcm90b3R5cGUuZGVzY2VuZFN0YWNrZWRCbG9jazsKICAgIEpTR2VuZXJhdG9yLnByb3RvdHlwZS5kZXNjZW5kU3RhY2tlZEJsb2NrID0gZnVuY3Rpb24obm9kZSkgewogICAgICBzd2l0Y2ggKG5vZGUua2luZCkgewogICAgICAgIGNhc2UgInByb2NlZHVyZXMuY2FsbCI6IHsKICAgICAgICAgIC8vIFRoaXMgYWxzbyBnZXRzIEdsb2JhbCBQcm9jZWR1cmVzIHRvIHdvcmsgZm9yIHNvbWUgcmVhc29uCiAgICAgICAgICBjb25zdCBhcmdJbmRleGVzID0gW107CiAgICAgICAgICBsZXQgZm9yY2VZaWVsZCA9IGZhbHNlOwogICAgICAgICAgY29uc3Qgb2dTb3VyY2UgPSB0aGlzLnNvdXJjZTsKICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZS5hcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgYXJnID0gbm9kZS5hcmd1bWVudHNbaV07CiAgICAgICAgICAgIGlmICghYXJnLnZhbHVlIHx8ICFhcmcubWJwS2V5KSBjb250aW51ZTsKICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSAiIjsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUubWJwUnVubmluZ0JyYW5jaCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuZGVzY2VuZFN0YWNrKGFyZy52YWx1ZSwgbmV3IGV4cC5GcmFtZShmYWxzZSwgImNvbnRyb2wuaWYiLCB0cnVlKSk7IC8vIDNyZCBwYXJhbSB1c2VkIGJ5IFBNCiAgICAgICAgICAgIGlmICh0aGlzLnNjcmlwdC55aWVsZHMpIHsKICAgICAgICAgICAgICBhcmcudmFsdWUgPSBgZnVuY3Rpb24qICgpIHsgJHt0aGlzLnNvdXJjZX0gfWA7CiAgICAgICAgICAgICAgZm9yY2VZaWVsZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBhcmcudmFsdWUgPSBgKCkgPT4geyAke3RoaXMuc291cmNlfSB9YDsKICAgICAgICAgICAgYXJnSW5kZXhlcy5wdXNoKGkpOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5zb3VyY2UgPSBvZ1NvdXJjZTsKCiAgICAgICAgICBpZiAoYXJnSW5kZXhlcy5sZW5ndGgpIHsKICAgICAgICAgICAgLy8gdHJhbnNmb3JtIHRoZSBicmFuY2ggc3RyaW5nIHRvIGEgZnVuY3Rpb24KICAgICAgICAgICAgLy8gbW9kaWZpZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vVHVyYm9XYXJwL3NjcmF0Y2gtdm0vYmxvYi9kZXZlbG9wL3NyYy9jb21waWxlci9qc2dlbi5qcwogICAgICAgICAgICBjb25zdCBwcm9jZWR1cmVDb2RlID0gbm9kZS5jb2RlOwogICAgICAgICAgICBjb25zdCBwcm9jZWR1cmVWYXJpYW50ID0gbm9kZS52YXJpYW50OwogICAgICAgICAgICBjb25zdCBwcm9jZWR1cmVEYXRhID0gdGhpcy5pci5wcm9jZWR1cmVzW3Byb2NlZHVyZVZhcmlhbnRdOwogICAgICAgICAgICBpZiAocHJvY2VkdXJlRGF0YS5zdGFjayA9PT0gbnVsbCkgYnJlYWs7CgogICAgICAgICAgICBjb25zdCB5aWVsZEZvclJlY3Vyc2lvbiA9ICF0aGlzLmlzV2FycCAmJiBwcm9jZWR1cmVDb2RlID09PSB0aGlzLnNjcmlwdC5wcm9jZWR1cmVDb2RlOwogICAgICAgICAgICBpZiAoeWllbGRGb3JSZWN1cnNpb24pIHRoaXMueWllbGROb3RXYXJwKCk7CiAgICAgICAgICAgIGlmIChwcm9jZWR1cmVEYXRhLnlpZWxkcyB8fCBmb3JjZVlpZWxkKSB0aGlzLnNvdXJjZSArPSAieWllbGQqICI7CgogICAgICAgICAgICB0aGlzLnNvdXJjZSArPSBgdGhyZWFkLnByb2NlZHVyZXNbIiR7c2FuaXRpemUocHJvY2VkdXJlVmFyaWFudCl9Il0oYDsKICAgICAgICAgICAgY29uc3QgYXJncyA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBub2RlLmFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICBpZiAoYXJnSW5kZXhlcy5pbmRleE9mKGkpID4gLTEpIGFyZ3MucHVzaChpbnB1dC52YWx1ZSk7CiAgICAgICAgICAgICAgZWxzZSBhcmdzLnB1c2godGhpcy5kZXNjZW5kSW5wdXQoaW5wdXQpLmFzU2FmZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnNvdXJjZSArPSBhcmdzLmpvaW4oIiwiKSArICIpO1xuIjsKICAgICAgICAgICAgdGhpcy5yZXNldFZhcmlhYmxlSW5wdXRzKCk7CgogICAgICAgICAgICBpZiAoZm9yY2VZaWVsZCkgdGhpcy5pci5wcm9jZWR1cmVzW3Byb2NlZHVyZVZhcmlhbnRdLnlpZWxkcyA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfSBlbHNlIHJldHVybiBfb2dKU2Rlc2NlbmRTdGFjay5jYWxsKHRoaXMsIG5vZGUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJTUG1icENTVC5zZXRQYXJhbSI6IHsKICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZGVzY2VuZElucHV0KG5vZGUudmFsKTsKICAgICAgICAgIGNvbnN0IGkgPSBub2RlLnBhcmFtSW5kZXg7CiAgICAgICAgICBpZiAoaSAhPT0gdW5kZWZpbmVkICYmIGkgIT09IC0xKSB0aGlzLnNvdXJjZSArPSBgcCR7aX0gPSAke3ZhbC5hc1NhZmUoKX07XG5gOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgIlNQbWJwQ1NULmV2YWxQYXJhbSI6IHsKICAgICAgICAgIGlmIChub2RlLmlucHV0ID09PSB1bmRlZmluZWQpIGJyZWFrOwogICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5kZXNjZW5kSW5wdXQobm9kZS5pbnB1dCk7CiAgICAgICAgICB0aGlzLnNvdXJjZSArPSBgcCR7bm9kZS5pbmRleH0gPSAke3ZhbC5hc1Vua25vd24oKX07XG5gOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGNhc2UgIlNQbWJwQ1NULnJ1bkJyYW5jaCI6IHsKICAgICAgICAgIGlmICh0aGlzLmlzUHJvY2VkdXJlKSB7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5sb2NhbFZhcmlhYmxlcy5uZXh0KCk7CiAgICAgICAgICAgIHRoaXMuc291cmNlICs9IGBjb25zdCAke2luZGV4fSA9ICR7dGhpcy5kZXNjZW5kSW5wdXQobm9kZS5pbmRleCkuYXNOdW1iZXIoKX0gLSAxO1xuYDsKICAgICAgICAgICAgdGhpcy5zb3VyY2UgKz0gYHN3aXRjaCAoJHtpbmRleH0udG9TdHJpbmcoKSkge1xuYDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmFwcGVuZGVycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNvbnN0IGFyZ0luZCA9IG5vZGUuYXBwZW5kZXJzW2ldWzBdOwogICAgICAgICAgICAgIHRoaXMuc291cmNlICs9IGBjYXNlICIke2l9Ijoge1xuYDsKICAgICAgICAgICAgICBpZiAodGhpcy5zY3JpcHQueWllbGRzKSB0aGlzLnNvdXJjZSArPSBgeWllbGQqIHAke2FyZ0luZH0oKTtcbmA7CiAgICAgICAgICAgICAgZWxzZSB0aGlzLnNvdXJjZSArPSBgcCR7YXJnSW5kfSgpO1xuYDsKICAgICAgICAgICAgICB0aGlzLnNvdXJjZSArPSBgYnJlYWs7XG5gOwogICAgICAgICAgICAgIHRoaXMuc291cmNlICs9IGB9XG5gOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc291cmNlICs9IGB9XG5gOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHJldHVybiBfb2dKU2Rlc2NlbmRTdGFjay5jYWxsKHRoaXMsIG5vZGUpOwogICAgICB9CiAgICB9OwogICAgY29uc3QgX29nSlNkZXNjZW5kSW5wID0gSlNHZW5lcmF0b3IucHJvdG90eXBlLmRlc2NlbmRJbnB1dDsKICAgIEpTR2VuZXJhdG9yLnByb3RvdHlwZS5kZXNjZW5kSW5wdXQgPSBmdW5jdGlvbihub2RlKSB7CiAgICAgIGlmIChub2RlLmtpbmQgPT09ICJTUG1icENTVC5nZXRQYXJhbSIpIHsKICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmRlc2NlbmRJbnB1dChub2RlLnBhcmFtKS5hc1NhZmUoKTsKICAgICAgICByZXR1cm4gbmV3IGV4cC5UeXBlZElucHV0KGAoKCkgPT4gewogICAgICAgICAgbGV0IGEgPSAke0pTT04uc3RyaW5naWZ5KHRoaXMuc2NyaXB0LmFyZ3VtZW50cyl9LCB2ID0gJHt2YWx9OwogICAgICAgICAgaWYgKHR5cGVvZiB2ICE9PSAnc3RyaW5nJykgdiA9ICh2KS50b1N0cmluZygpOwogICAgICAgICAgY29uc3QgaSA9IGEuaW5kZXhPZih2KTsKICAgICAgICAgIHJldHVybiBpID4gLTEgPyBhcmd1bWVudHNbaV0udG9TdHJpbmcoKSA6ICIiOwogICAgICAgIH0pKClgLCBleHAuVFlQRV9TVFJJTkcpOwogICAgICB9IGVsc2UgaWYgKG5vZGUua2luZCA9PT0gInByb2NlZHVyZXMuY2FsbCIpIHsKICAgICAgICAvLyBUaGlzIGdldHMgR2xvYmFsIFByb2NlZHVyZXMgdG8gd29yayBmb3Igc29tZSByZWFzb24KICAgICAgICByZXR1cm4gX29nSlNkZXNjZW5kSW5wLmNhbGwodGhpcywgbm9kZSk7CiAgICAgIH0gZWxzZSByZXR1cm4gX29nSlNkZXNjZW5kSW5wLmNhbGwodGhpcywgbm9kZSk7CiAgICB9OwogIH0KCiAgLy8gU2NyYXRjaEJsb2NrcyBhbmQgRWRpdG9yIFBhdGNoZXMKICBmdW5jdGlvbiBzeW5jRmllbGRDb2xvcnMoYmxvY2spIHsKICAgIGZvciAoY29uc3QgaW5wdXQgb2YgYmxvY2suaW5wdXRMaXN0KSB7CiAgICAgIGZvciAoY29uc3QgZmllbGQgb2YgaW5wdXQ/LmZpZWxkUm93KSB7CiAgICAgICAgaWYgKGZpZWxkLmFycm93XykgeyAvLyBkcm9wZG93biBmaWVsZHMKICAgICAgICAgIGlmIChmaWVsZC5zb3VyY2VCbG9ja18uaXNTaGFkb3coKSkgZmllbGQuc291cmNlQmxvY2tfLmNsZWFyU2hhZG93Q29sb3VyKCk7CiAgICAgICAgfQogICAgICAgIGlmIChmaWVsZC5ib3hfKSB7IC8vIHRleHQgaW5wdXQgZmllbGRzIGFuZCByb3VuZCBkcm9wZG93bnMKICAgICAgICAgIGZpZWxkLmJveF8uc2V0QXR0cmlidXRlKCJmaWxsIiwgZmllbGQuc291cmNlQmxvY2tfLmdldENvbG91cigpKTsKICAgICAgICAgIGlmIChmaWVsZC5ib3hfLmhhc0F0dHJpYnV0ZSgic3Ryb2tlIikpIGZpZWxkLmJveF8uc2V0QXR0cmlidXRlKCJzdHJva2UiLCBmaWVsZC5zb3VyY2VCbG9ja18uZ2V0Q29sb3VyVGVydGlhcnkoKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGZvciBzaGFkb3cgYmxvY2tzLCBpbmhlcml0IHRoZSB0ZXJ0aWFyeSBjb2xvcgogICAgICBpZiAoaW5wdXQ/LmNvbm5lY3Rpb24/LnRhcmdldENvbm5lY3Rpb24/LnNvdXJjZUJsb2NrXykgewogICAgICAgIGNvbnN0IG90aGVyQmxvY2sgPSBpbnB1dD8uY29ubmVjdGlvbj8udGFyZ2V0Q29ubmVjdGlvbj8uc291cmNlQmxvY2tfOwogICAgICAgIGlmIChvdGhlckJsb2NrLmlzU2hhZG93KCkpIHsKICAgICAgICAgIC8vIHBlbmd1aW5tb2QgZG9lc250IGhhdmUgcXVhdGVybmFyeSBjb2xvcnMgeWV0CiAgICAgICAgICBpZiAoaXNQTSkgb3RoZXJCbG9jay5zZXRDb2xvdXIob3RoZXJCbG9jay5nZXRDb2xvdXIoKSwgb3RoZXJCbG9jay5nZXRDb2xvdXJTZWNvbmRhcnkoKSwgYmxvY2suZ2V0Q29sb3VyVGVydGlhcnkoKSk7CiAgICAgICAgICBlbHNlIG90aGVyQmxvY2suc2V0Q29sb3VyKG90aGVyQmxvY2suZ2V0Q29sb3VyKCksIG90aGVyQmxvY2suZ2V0Q29sb3VyU2Vjb25kYXJ5KCksIGJsb2NrLmdldENvbG91clRlcnRpYXJ5KCksIG90aGVyQmxvY2suZ2V0Q29sb3VyUXVhdGVybmFyeSgpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChTY3JhdGNoLmd1aSkgU2NyYXRjaC5ndWkuZ2V0QmxvY2tseSgpLnRoZW4oU0IgPT4gewogICAgY29uc3QgcmVjb2xvcmFibGVzID0gWwogICAgICAiYXJndW1lbnRfcmVwb3J0ZXJfc3RyaW5nX251bWJlciIsICJhcmd1bWVudF9yZXBvcnRlcl9ib29sZWFuIiwKICAgICAgIlNQbWJwQ1NUX3NldFBhcmFtIiwgIlNQbWJwQ1NUX2dldFBhcmFtIiwgIlNQbWJwQ1NUX3J1bkJyYW5jaCIsCiAgICAgICJTUG1icENTVF9ldmFsUGFyYW0iLCAicHJvY2VkdXJlc19yZXR1cm4iLAogICAgICAvLyBwZW5ndWlubW9kCiAgICAgICJwcm9jZWR1cmVzX2RlZmluaXRpb25fcmV0dXJuIiwgInByb2NlZHVyZXNfc2V0IgogICAgXTsKCiAgICBsZXQgZG9tVG9CbG9ja1htbCA9IG51bGw7CiAgICBjb25zdCBvbGREVEJIID0gU0IuWG1sLmRvbVRvQmxvY2tIZWFkbGVzc187CiAgICBTQi5YbWwuZG9tVG9CbG9ja0hlYWRsZXNzXyA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgZG9tVG9CbG9ja1htbCA9IGFyZ3NbMF07CiAgICAgIGNvbnN0IHJldHVyblZhbHVlID0gb2xkRFRCSC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgZG9tVG9CbG9ja1htbCA9IG51bGw7CiAgICAgIHJldHVybiByZXR1cm5WYWx1ZTsKICAgIH0KCiAgICBjb25zdCBvbGRTY3JvbGxUb0NhdGVnb3J5ID0gU0IuVG9vbGJveC5wcm90b3R5cGUuc2Nyb2xsVG9DYXRlZ29yeUJ5SWQ7CiAgICBTQi5Ub29sYm94LnByb3RvdHlwZS5zY3JvbGxUb0NhdGVnb3J5QnlJZCA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgIGlmIChpZCA9PT0gIm15QmxvY2tzIiAmJiBzaG91bGRTY3JvbGxUb01CUCkgewogICAgICAgIHNob3VsZFNjcm9sbFRvTUJQID0gZmFsc2U7CiAgICAgICAgaWQgPSAiU1BtYnBDU1QiOwogICAgICB9CiAgICAgIHJldHVybiBvbGRTY3JvbGxUb0NhdGVnb3J5LmNhbGwodGhpcywgaWQpOwogICAgfQoKICAgIGNvbnN0IHV0aWxzID0gU0IuU2NyYXRjaEJsb2Nrcy5Qcm9jZWR1cmVVdGlsczsKICAgIGNvbnN0IG9nVXBkYXRlRGlzcGxheSA9IHV0aWxzLnVwZGF0ZURpc3BsYXlfOwogICAgdXRpbHMudXBkYXRlRGlzcGxheV8gPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKGV4dGVuc2lvblJlbW92YWJsZSkgcmV0dXJuIG9nVXBkYXRlRGlzcGxheS5jYWxsKHRoaXMpOwogICAgICBjb25zdCBzdG9yZSA9IHRoaXMuU1BtYnBDU1Rfc3RvcmUgfHwgc3RvcmVHZXQodGhpcy5wcm9jQ29kZV8pOwogICAgICBpZiAoc3RvcmUuY29sb3IgJiYgIXRoaXMuaXNJbnNlcnRpb25NYXJrZXIoKSkgewogICAgICAgIGNvbnN0IGJsb2NrQ29sb3IgPSB0aGVtZWlmeUNvbG9yKHN0b3JlLmNvbG9yKTsKICAgICAgICB0aGlzLnNldENvbG91ciguLi5ibG9ja0NvbG9yKTsKICAgICAgICBpZiAoaXNQTSkgdGhpcy5jb2xvciA9IGJsb2NrQ29sb3IKICAgICAgICBpZiAodGhpcy50eXBlID09PSAicHJvY2VkdXJlc19wcm90b3R5cGUiKSB7CiAgICAgICAgICAvLyBSZWNvbG9yIGFyZ3VtZW50IHJlcG9ydGVycyBhbmQgdGhlIGRlZmluZSBibG9jayB0byB0aGUgYmxvY2sgY29sb3IKICAgICAgICAgIC8vIERpc2FibGUgYnJhbmNoIGlucHV0cwogICAgICAgICAgdGhpcy5zZXRDb2xvdXIoLi4udGhlbWVpZnlDb2xvcihzdG9yZS5jb2xvcikpOwogICAgICAgICAgLy8gU2NyYXRjaEJsb2NrcyB3YXlzIG9mIGdldHRpbmcgdGhlIHBhcmVudCBibG9jayB3b24ndCB3b3JrIHdoaWxlIHRoZSBibG9ja3MgYXJlIGJlaW5nIGNyZWF0ZWQKICAgICAgICAgIHF1ZXVlTWljcm90YXNrKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgZGVmaW5lQmxvY2sgPSB0aGlzLmdldFBhcmVudCgpOwogICAgICAgICAgICBpZiAoIWRlZmluZUJsb2NrKSByZXR1cm47CiAgICAgICAgICAgIGRlZmluZUJsb2NrLnNldENvbG91ciguLi50aGVtZWlmeUNvbG9yKHN0b3JlLmNvbG9yKSk7CiAgICAgICAgICAgIHN5bmNGaWVsZENvbG9ycyhkZWZpbmVCbG9jayk7CiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy5pbnB1dExpc3QuZmlsdGVyKChpdGVtLCBpKSA9PiBpdGVtLmNvbm5lY3Rpb24gIT09IG51bGwpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKCFjaGlsZHJlbltpXS5jb25uZWN0aW9uKSBjb250aW51ZTsKICAgICAgICAgICAgICBjb25zdCBjaGlsZCA9IGNoaWxkcmVuW2ldLmNvbm5lY3Rpb24udGFyZ2V0QmxvY2soKTsKICAgICAgICAgICAgICBpZiAoc3RvcmUuaW5wdXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gc3RvcmUuaW5wdXRzW3RoaXMuYXJndW1lbnRJZHNfW2ldXT8udHlwZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAiYnJjIikgewogICAgICAgICAgICAgICAgICBjaGlsZC5zZXRPdXRwdXRTaGFwZSgzKTsKICAgICAgICAgICAgICAgICAgY2hpbGQuc2V0TmV4dFN0YXRlbWVudChmYWxzZSk7CiAgICAgICAgICAgICAgICAgIGNoaWxkLnNldE1vdmFibGUoZmFsc2UpOwogICAgICAgICAgICAgICAgICBjaGlsZFt0YXJnZXRQcm9jRGF0YV0gPSAiYnJhbmNoRHJhZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWNvbG9yYWJsZXMuaW5jbHVkZXMoY2hpbGQudHlwZSkpIHVwZGF0ZUFyZ3VtZW50UmVwb3J0ZXJDb2xvcihjaGlsZCwgZGVmaW5lQmxvY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgLy8gUmVjb2xvciBkcm9wZG93bnMgdG8gdGhlIGJsb2NrIGNvbG9yCiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gInByb2NlZHVyZXNfY2FsbCIpIHsKICAgICAgICAgIHF1ZXVlTWljcm90YXNrKCgpID0+IHsKICAgICAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB0aGlzLmdldENoaWxkcmVuKCkpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQuaXNTaGFkb3coKSAmJiBjaGlsZC5vdXRwdXRDb25uZWN0aW9uICYmICFpc05vcm1hbElucHV0KGNoaWxkLnR5cGUpKSBjaGlsZC5zZXRDb2xvdXIoLi4udGhlbWVpZnlDb2xvcihzdG9yZS5jb2xvcikpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIERpc2Nvbm5lY3QgYW5kIHJlY29ubmVjdCB0aGUgcHJvdG90eXBlIGZyb20gdGhlIGRlZmluZSBibG9jayB3aGVuCiAgICAgIC8vIGNoYW5naW5nIHRoZSBvdXRwdXQgdHlwZSBpbiBQTSBiZWNhdXNlIG90aGVyd2lzZSBlcnJvcnMgd2lsbCBoYXBwZW4KICAgICAgLy8gd2UgaGF2ZSB0byBjcmVhdGUgYSBuZXcgZGVmaW5lIGJsb2NrIHRvIGNoYW5nZSBpdHMgdHlwZQogICAgICBsZXQgZGVmaW5lQmxvY2sgPSAoCiAgICAgICAgaXNQTSAmJiB0aGlzLnR5cGUgPT09ICJwcm9jZWR1cmVzX3Byb3RvdHlwZSIgJiYgdGhpcy5nZXRQYXJlbnQoKT8udHlwZT8uc3RhcnRzV2l0aCgicHJvY2VkdXJlc19kZWZpbml0aW9uIikKICAgICAgKSA/IHRoaXMuZ2V0UGFyZW50KCkgOiBudWxsOwogICAgICBsZXQgc2F2ZWREZWZDb25uZWN0ID0gbnVsbCwgc2F2ZWRTaGFkb3cgPSBudWxsOwogICAgICBjb25zdCBuZXdPcGNvZGUgPSB0aGlzLm91dHB1dF8gPyAicHJvY2VkdXJlc19kZWZpbml0aW9uX3JldHVybiIgOiAicHJvY2VkdXJlc19kZWZpbml0aW9uIjsKICAgICAgaWYgKGlzUE0gJiYgZGVmaW5lQmxvY2sgJiYgZGVmaW5lQmxvY2sudHlwZSAhPT0gbmV3T3Bjb2RlKSB7CiAgICAgICAgc2F2ZWREZWZDb25uZWN0ID0gKHRoaXMucHJldmlvdXNDb25uZWN0aW9uIHx8IHRoaXMub3V0cHV0Q29ubmVjdGlvbikudGFyZ2V0Q29ubmVjdGlvbjsKICAgICAgICBzYXZlZFNoYWRvdyA9IHNhdmVkRGVmQ29ubmVjdC5nZXRTaGFkb3dEb20oKTsKICAgICAgICBjb25zdCBzYXZlZE5leHRDb25uZWN0ID0gZGVmaW5lQmxvY2submV4dENvbm5lY3Rpb24/LnRhcmdldENvbm5lY3Rpb247CgogICAgICAgIC8vIFJlbW92ZSB0aGUgc2hhZG93IERPTSwgdGhlbiBkaXNjb25uZWN0IHRoZSBibG9jay4gIE90aGVyd2lzZSBhIHNoYWRvdyBibG9jawogICAgICAgIC8vIHdpbGwgcmVzcGF3biBpbnN0YW50bHksIGFuZCB3ZSdkIGhhdmUgdG8gcmVtb3ZlIGl0IHdoZW4gd2UgcmVtb3ZlIHRoZSBpbnB1dC4KICAgICAgICBzYXZlZE5leHRDb25uZWN0Py5kaXNjb25uZWN0KCk7CgogICAgICAgIC8vIFJlY3JlYXRlIHRoZSBkZWZpbmUgYmxvY2sgd2l0aCBhIGNoYW5nZWQgdHlwZQogICAgICAgIGNvbnN0IHdzID0gZGVmaW5lQmxvY2sud29ya3NwYWNlOwogICAgICAgIGNvbnN0IHhtbCA9IFNCLlhtbC5ibG9ja1RvRG9tKGRlZmluZUJsb2NrKTsKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IGRlZmluZUJsb2NrLmdldFJlbGF0aXZlVG9TdXJmYWNlWFkoKTsKICAgICAgICB4bWwuc2V0QXR0cmlidXRlKCJ0eXBlIiwgbmV3T3Bjb2RlKTsKICAgICAgICBkZWZpbmVCbG9jay5kaXNwb3NlKCk7CiAgICAgICAgZGVmaW5lQmxvY2sgPSBTQi5YbWwuZG9tVG9CbG9jayh4bWwsIHdzKTsKICAgICAgICBkZWZpbmVCbG9jay5tb3ZlQnkocG9zaXRpb24ueCwgcG9zaXRpb24ueSk7CiAgICAgICAgaWYgKHNhdmVkTmV4dENvbm5lY3QpIHNhdmVkTmV4dENvbm5lY3QuY29ubmVjdChkZWZpbmVCbG9jay5uZXh0Q29ubmVjdGlvbik7CiAgICAgIH0KICAgICAgb2dVcGRhdGVEaXNwbGF5LmNhbGwodGhpcyk7CgogICAgICAvLyB0dXJuIGJyYW5jaCBhbmQgaW1hZ2UgaW5wdXRzIGludG8gYnJhbmNoZXMgYW5kIGltYWdlcwogICAgICAvLyAoZG9pbmcgaXQgaW4gYXR0YWNoU2hhZG93IG1ha2VzIGl0IG5vdCB3b3JrIG9uIGZ1cnRoZXIgdXBkYXRlcykKICAgICAgaWYgKHN0b3JlPy5pbnB1dHMgJiYgdGhpcy50eXBlICE9PSAicHJvY2VkdXJlc19kZWNsYXJhdGlvbiIpIGZvciAobGV0IGkgPSB0aGlzLmlucHV0TGlzdC5sZW5ndGg7IGktLTspIHsKICAgICAgICBjb25zdCBpbnB1dCA9IHRoaXMuaW5wdXRMaXN0W2ldOwogICAgICAgIGNvbnN0IHR5cGUgPSBzdG9yZS5pbnB1dHNbaW5wdXQubmFtZV0/LnR5cGU7CiAgICAgICAgaWYgKAogICAgICAgICAgKGlucHV0LnR5cGUgIT09IFNCLk5FWFRfU1RBVEVNRU5UICYmIHR5cGUgPT09ICJicmMiKSB8fCAoaW5wdXQudHlwZSAhPT0gU0IuRFVNTVlfSU5QVVQgJiYgdHlwZSA9PT0gImltZyIpCiAgICAgICAgKSB7CiAgICAgICAgICAvLyBmb3IgUHJvdG90eXBlIGJsb2NrcyB3ZSBqdXN0IHVzZSBhIHN0YXRpYyBzcXVhcmUgYmxvY2sgYXMgYSB2aXN1YWwgcmVwcmVzZW50YXRpb24KICAgICAgICAgIC8vIGZvciBicmFuY2ggaW5wdXRzLCB0aGlzIGlzIGRvbmUgaW4gJ3VwZGF0ZURpc3BsYXlfJwogICAgICAgICAgaWYgKHR5cGUgPT09ICJicmMiICYmIHRoaXMudHlwZSA9PT0gInByb2NlZHVyZXNfcHJvdG90eXBlIikgY29udGludWU7CiAgICAgICAgICBsZXQgY29ubmVjdGlvbiwgbmV3SW5wdXQ7CiAgICAgICAgICBpZiAodHlwZSA9PT0gImJyYyIpIHsKICAgICAgICAgICAgY29ubmVjdGlvbiA9IHRoaXMubWFrZUNvbm5lY3Rpb25fKFNCLk5FWFRfU1RBVEVNRU5UKTsKICAgICAgICAgICAgaWYgKGlzUE0pIGNvbm5lY3Rpb24uc2V0Q2hlY2soIm5vcm1hbCIpOwogICAgICAgICAgICBuZXdJbnB1dCA9IG5ldyBTQi5JbnB1dChTQi5ORVhUX1NUQVRFTUVOVCwgaW5wdXQubmFtZSwgdGhpcywgY29ubmVjdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbWFnZVVSTCA9IGdldFN0b3JlZEltYWdlKHN0b3JlLmlucHV0c1tpbnB1dC5uYW1lXS5zcmMpOwogICAgICAgICAgICBuZXdJbnB1dCA9IG5ldyBTQi5JbnB1dChTQi5EVU1NWV9JTlBVVCwgIiIsIHRoaXMpOwogICAgICAgICAgICBuZXdJbnB1dC5hcHBlbmRGaWVsZChuZXcgU2NyYXRjaEJsb2Nrcy5GaWVsZEltYWdlKGltYWdlVVJMLCAyNSwgMjUpKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZW1vdmUgdGhlIG9sZCBpbnB1dC4uLgogICAgICAgICAgaWYgKGlucHV0LmNvbm5lY3Rpb24gJiYgaW5wdXQuY29ubmVjdGlvbi5pc0Nvbm5lY3RlZCgpKSB7CiAgICAgICAgICAgIGlucHV0LmNvbm5lY3Rpb24uc2V0U2hhZG93RG9tKG51bGwpOwogICAgICAgICAgICB2YXIgYmxvY2sgPSBpbnB1dC5jb25uZWN0aW9uLnRhcmdldEJsb2NrKCk7CiAgICAgICAgICAgIGlmIChibG9jay5pc1NoYWRvdygpKSBibG9jay5kaXNwb3NlKCk7IC8vIERlc3Ryb3kgYW55IGF0dGFjaGVkIHNoYWRvdyBibG9jawogICAgICAgICAgICBlbHNlIGJsb2NrLnVucGx1ZygpOyAvLyBEaXNjb25uZWN0IGFueSBhdHRhY2hlZCBub3JtYWwgYmxvY2sKICAgICAgICAgIH0KICAgICAgICAgIGlucHV0LmRpc3Bvc2UoKTsKICAgICAgICAgIC8vIC4uLmJ1dCByZXBsYWNlIGl0IHdpdGggdGhlIG5ldyBvbmUgaW4gcGxhY2UKICAgICAgICAgIC8vIChjYWxsaW5nIHJlbW92ZUlucHV0KCkgc2hpZnRzIGFsbCBlbGVtZW50cyBvZiBpbnB1dExpc3Qgd2hpY2ggaXMgYSBiaXQgc2xvd2VyKQogICAgICAgICAgaWYgKHR5cGUgPT09ICJicmMiICYmIChpc1BNID8gdGhpcy5vdXRwdXRfIDogdGhpcy5nZXRSZXR1cm4oKSkpIHRoaXMuaW5wdXRMaXN0LnNwbGljZShpLCAxKTsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoaSB8fCB0eXBlID09PSAiaW1nIikgdGhpcy5pbnB1dExpc3RbaV0gPSBuZXdJbnB1dDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgLy8gZml4IHdlaXJkIHZpc3VhbCBnbGl0Y2ggd2l0aCBhIGJyYW5jaCBhcyB0aGUgZmlyc3QgaW5wdXQKICAgICAgICAgICAgICB0aGlzLmlucHV0TGlzdFtpXSA9IHRoaXMuYXBwZW5kRHVtbXlJbnB1dCgpOwogICAgICAgICAgICAgIHRoaXMuaW5wdXRMaXN0LnB1c2gobmV3SW5wdXQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoc2F2ZWREZWZDb25uZWN0KSB7CiAgICAgICAgc2F2ZWREZWZDb25uZWN0ID0gZGVmaW5lQmxvY2suZ2V0SW5wdXQoImN1c3RvbV9ibG9jayIpLmNvbm5lY3Rpb247CiAgICAgICAgKHRoaXMucHJldmlvdXNDb25uZWN0aW9uIHx8IHRoaXMub3V0cHV0Q29ubmVjdGlvbikuY29ubmVjdChzYXZlZERlZkNvbm5lY3QpOwogICAgICAgIHNhdmVkRGVmQ29ubmVjdC5zZXRTaGFkb3dEb20oc2F2ZWRTaGFkb3cpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuaXNJbnNlcnRpb25NYXJrZXIoKSkgewogICAgICAgIC8vIFNjcmF0Y2hCbG9ja3Mgd2F5cyBvZiBnZXR0aW5nIHRoZSBuZXh0IGJsb2NrIHdvbid0IHdvcmsgd2hpbGUgdGhlIGJsb2NrcyBhcmUgYmVpbmcgY3JlYXRlZAogICAgICAgIGNvbnN0IGFjdHVhbE5leHRCbG9jayA9IHRoaXMuZ2V0TmV4dEJsb2NrKCkgfHwgdm0/LmVkaXRpbmdUYXJnZXQ/LmJsb2Nrcz8uZ2V0QmxvY2sodGhpcy5pZCk/Lm5leHQgfHwgKGRvbVRvQmxvY2tYbWwgJiYgZG9tVG9CbG9ja1htbC5xdWVyeVNlbGVjdG9yKCJuZXh0IikpOwogICAgICAgIGNvbnN0IGlzUmV0dXJuZXIgPSBpc1BNID8gdGhpcy5vdXRwdXRfIDogdGhpcy5yZXR1cm5fOwogICAgICAgIGlmICghc3RvcmUuaXNUZXJtaW5hbCAhPT0gdW5kZWZpbmVkICYmICFpc1JldHVybmVyICYmICFhY3R1YWxOZXh0QmxvY2spIHsKICAgICAgICAgIHRoaXMuc2V0TmV4dFN0YXRlbWVudCgKICAgICAgICAgICAgIXN0b3JlLmlzVGVybWluYWwsCiAgICAgICAgICAgIHRoaXMudHlwZSA9PT0gInByb2NlZHVyZXNfcHJvdG90eXBlIiA/IHRydWUgOiBpc1BNID8gIm5vcm1hbCIgOiB1bmRlZmluZWQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFRoZSBpbnNlcnRpb24gbWFya2VyIHNob3VsZCBjb3B5IHRoZSB0ZXJtaW5hbC1uZXNzIG9mIHRoZSBzb3VyY2UgYmxvY2ssCiAgICAgICAgLy8gb3RoZXJ3aXNlIEJsb2NrbHkgd2lsbCB0aHJvdyBhbiBlcnJvcgogICAgICAgIGNvbnN0IHRhcmdldEJsb2NrID0gdGhpcy53b3Jrc3BhY2U/LmN1cnJlbnRHZXN0dXJlXz8udGFyZ2V0QmxvY2tfOwogICAgICAgIC8vIHRhcmdldEJsb2NrIGRvZXNuJ3QgZXhpc3Qgd2hlbiBkcmFnZ2luZyB0byB0aGUgc3RhcnQgb2YgYSBzdGFjawogICAgICAgIC8vIEluIHRoaXMgY2FzZSwgaXQgc2hvdWxkIGFsd2F5cyBiZSBhIHN0YWNrIGJsb2NrCiAgICAgICAgdGhpcy5zZXROZXh0U3RhdGVtZW50KHRhcmdldEJsb2NrID8gISF0YXJnZXRCbG9jaz8ubmV4dENvbm5lY3Rpb24gOiB0cnVlLCBpc1BNID8gIm5vcm1hbCIgOiB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IG9wY29kZSBvZiBbInByb2NlZHVyZXNfY2FsbCIsICJwcm9jZWR1cmVzX3Byb3RvdHlwZSIsICJwcm9jZWR1cmVzX2RlY2xhcmF0aW9uIl0pIHsKICAgICAgU0IuQmxvY2tzW29wY29kZV0udXBkYXRlRGlzcGxheV8gPSB1dGlscy51cGRhdGVEaXNwbGF5XzsKICAgIH0KCiAgICBjb25zdCBvZ0F0dGFjaFNoYWRvdyA9IHV0aWxzLmF0dGFjaFNoYWRvd187CiAgICB1dGlscy5hdHRhY2hTaGFkb3dfID0gZnVuY3Rpb24oaW5wdXQsIGFyZ3VtZW50VHlwZSkgewogICAgICBpZiAoZXh0ZW5zaW9uUmVtb3ZhYmxlKSByZXR1cm4gb2dBdHRhY2hTaGFkb3cuY2FsbCh0aGlzLCBpbnB1dCwgYXJndW1lbnRUeXBlKTsKICAgICAgY29uc3Qgc3RvcmUgPSB0aGlzLlNQbWJwQ1NUX3N0b3JlIHx8IHN0b3JlR2V0KHRoaXMuZ2V0UHJvY0NvZGUoKSk7CiAgICAgIGlmICghc3RvcmUgfHwgIXN0b3JlLmlucHV0cyB8fCAhc3RvcmUuaW5wdXRzW2lucHV0Lm5hbWVdKSByZXR1cm4gb2dBdHRhY2hTaGFkb3cuY2FsbCh0aGlzLCBpbnB1dCwgYXJndW1lbnRUeXBlKTsKICAgICAgY29uc3QgeyBvcGNvZGUsIGZpZWxkTmFtZSwgZGVmYXVsdFZhbHVlIH0gPSBnZXRJbnB1dERhdGEoc3RvcmUuaW5wdXRzW2lucHV0Lm5hbWVdKTsKICAgICAgaWYgKCFvcGNvZGUpIHJldHVybiBvZ0F0dGFjaFNoYWRvdy5jYWxsKHRoaXMsIGlucHV0LCBhcmd1bWVudFR5cGUpOwogICAgICBpZiAob3Bjb2RlID09PSAiYnJjIiB8fCBvcGNvZGUgPT09ICJlbXAiIHx8IG9wY29kZSA9PT0gImltZyIpIHJldHVybjsgLy8gdGhlc2UgYXJlIHNwZWNpYWwKCiAgICAgIC8vIEFkZCBjdXN0b20gaW5wdXRzCiAgICAgIGNvbnN0IGJsb2NrVHlwZSA9IG9wY29kZTsKICAgICAgU0IuRXZlbnRzLmRpc2FibGUoKTsKICAgICAgbGV0IG5ld0Jsb2NrOwogICAgICB0cnkgewogICAgICAgIG5ld0Jsb2NrID0gdGhpcy53b3Jrc3BhY2UubmV3QmxvY2soYmxvY2tUeXBlKTsKICAgICAgICBpZiAoZmllbGROYW1lKSBuZXdCbG9jay5zZXRGaWVsZFZhbHVlKGRlZmF1bHRWYWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uID8gZGVmYXVsdFZhbHVlKCkgOiBkZWZhdWx0VmFsdWUsIGZpZWxkTmFtZSk7CiAgICAgICAgbmV3QmxvY2suc2V0U2hhZG93KHRydWUpOwogICAgICAgIGlmICghdGhpcy5pc0luc2VydGlvbk1hcmtlcigpKSB7CiAgICAgICAgICBuZXdCbG9jay5pbml0U3ZnKCk7CiAgICAgICAgICBuZXdCbG9jay5yZW5kZXIoZmFsc2UpOwogICAgICAgIH0KICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBTQi5FdmVudHMuZW5hYmxlKCk7CiAgICAgIH0KICAgICAgaWYgKFNCLkV2ZW50cy5pc0VuYWJsZWQoKSkgU0IuRXZlbnRzLmZpcmUobmV3IFNCLkV2ZW50cy5CbG9ja0NyZWF0ZShuZXdCbG9jaykpOwogICAgICBuZXdCbG9jaz8ub3V0cHV0Q29ubmVjdGlvbj8uY29ubmVjdChpbnB1dC5jb25uZWN0aW9uKTsKICAgIH07CiAgICBTQi5CbG9ja3NbInByb2NlZHVyZXNfY2FsbCJdLmF0dGFjaFNoYWRvd18gPSB1dGlscy5hdHRhY2hTaGFkb3dfOwoKICAgIGNvbnN0IG9nUG9wQXJnID0gdXRpbHMucG9wdWxhdGVBcmd1bWVudE9uQ2FsbGVyXzsKICAgIHV0aWxzLnBvcHVsYXRlQXJndW1lbnRPbkNhbGxlcl8gPSBmdW5jdGlvbih0eXBlLCBpbmRleCwgY29ubmVjdGlvbk1hcCwgaWQsIGlucHV0KSB7CiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9UdXJib1dhcnAvc2NyYXRjaC1ibG9ja3MvYmxvYi9kZXZlbG9wL2Jsb2Nrc192ZXJ0aWNhbC9wcm9jZWR1cmVzLmpzI0w0NDUKICAgICAgdmFyIG9sZEJsb2NrID0gbnVsbCwgb2xkU2hhZG93ID0gbnVsbDsKICAgICAgaWYgKGNvbm5lY3Rpb25NYXAgJiYgKGlkIGluIGNvbm5lY3Rpb25NYXApKSB7CiAgICAgICAgdmFyIHNhdmVJbmZvID0gY29ubmVjdGlvbk1hcFtpZF07CiAgICAgICAgb2xkQmxvY2sgPSBzYXZlSW5mb1siYmxvY2siXTsKICAgICAgICBvbGRTaGFkb3cgPSBzYXZlSW5mb1sic2hhZG93Il07CiAgICAgIH0KCiAgICAgIGlmIChjb25uZWN0aW9uTWFwICYmIG9sZEJsb2NrKSB7CiAgICAgICAgLy8gUmVhdHRhY2ggdGhlIG9sZCBibG9jayBhbmQgc2hhZG93IERPTS4KICAgICAgICBjb25uZWN0aW9uTWFwW2lucHV0Lm5hbWVdID0gbnVsbDsKICAgICAgICBpZiAob2xkU2hhZG93ID09PSBudWxsICYmIG9sZEJsb2NrLm91dHB1dENvbm5lY3Rpb24gPT09IG51bGwpIHsKICAgICAgICAgIC8vIHRoaXMgaXMgYSBicmFuY2gKICAgICAgICAgIGNvbnN0IHBhcmVudCA9IGlucHV0LmNvbm5lY3Rpb24uc291cmNlQmxvY2tfOwogICAgICAgICAgaWYgKGlzUE0gJiYgdGhpcy5vdXRwdXRfKSByZXR1cm47CiAgICAgICAgICBjb25zdCBicmFuY2hJbmRleCA9IHBhcmVudC5pbnB1dExpc3QuaW5kZXhPZihpbnB1dCk7CiAgICAgICAgICBwYXJlbnQuaW5wdXRMaXN0W2JyYW5jaEluZGV4XS5jb25uZWN0aW9uLnR5cGUgPSAzOwogICAgICAgICAgcGFyZW50LmlucHV0TGlzdFticmFuY2hJbmRleF0udHlwZSA9IDM7CiAgICAgICAgICBwYXJlbnQuaW5wdXRMaXN0W2JyYW5jaEluZGV4XS5jb25uZWN0aW9uLmNvbm5lY3Qob2xkQmxvY2sucHJldmlvdXNDb25uZWN0aW9uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb2xkQmxvY2sub3V0cHV0Q29ubmVjdGlvbi5jb25uZWN0KGlucHV0LmNvbm5lY3Rpb24pOwogICAgICAgICAgaWYgKHR5cGUgIT0gImIiICYmIHRoaXMuZ2VuZXJhdGVTaGFkb3dzXykgewogICAgICAgICAgICB2YXIgc2hhZG93RG9tID0gb2xkU2hhZG93IHx8IHRoaXMuYnVpbGRTaGFkb3dEb21fKHR5cGUpOwogICAgICAgICAgICBpbnB1dC5jb25uZWN0aW9uLnNldFNoYWRvd0RvbShzaGFkb3dEb20pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0aGlzLmdlbmVyYXRlU2hhZG93c18pIHsKICAgICAgICB0aGlzLmF0dGFjaFNoYWRvd18oaW5wdXQsIHR5cGUpOwogICAgICB9CiAgICB9OwogICAgU0IuQmxvY2tzWyJwcm9jZWR1cmVzX2NhbGwiXS5wb3B1bGF0ZUFyZ3VtZW50XyA9IHV0aWxzLnBvcHVsYXRlQXJndW1lbnRPbkNhbGxlcl87CgogICAgZnVuY3Rpb24gdXBkYXRlQXJndW1lbnRSZXBvcnRlckNvbG9yKGJsb2NrLCBkZWZpbmVCbG9jayA9IG51bGwpIHsKICAgICAgLy8gSnVzdCBzdG9wcGVkIGRyYWdnaW5nIChhbmQgZHJvcHBpbmcpLCB1cGRhdGUgY29sb3IgYWNjb3JkaW5nIHRvIHRoZSB0b3AgZGVmaW5lIGJsb2NrCiAgICAgIGlmIChleHRlbnNpb25SZW1vdmFibGUpIHJldHVybjsKICAgICAgaWYgKCFkZWZpbmVCbG9jaykgewogICAgICAgIGRlZmluZUJsb2NrID0gYmxvY2s7CiAgICAgICAgd2hpbGUgKGRlZmluZUJsb2NrPy5nZXRQYXJlbnQoKSkgeyBkZWZpbmVCbG9jayA9IGRlZmluZUJsb2NrPy5nZXRQYXJlbnQoKSB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZUJsb2NrPy50eXBlLnN0YXJ0c1dpdGgoInByb2NlZHVyZXNfZGVmaW5pdGlvbiIpKSB7CiAgICAgICAgaWYgKGJsb2NrW3RhcmdldFByb2NEYXRhXSA9PT0gImJyYW5jaERyYWciKSB7CiAgICAgICAgICBibG9jay5zZXRDb2xvdXIoZGVmaW5lQmxvY2suY29sb3VyU2Vjb25kYXJ5XywgZGVmaW5lQmxvY2suY29sb3VyU2Vjb25kYXJ5XywgZGVmaW5lQmxvY2suY29sb3VyVGVydGlhcnlfKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmxvY2suc2V0Q29sb3VyKGRlZmluZUJsb2NrLmNvbG91cl8sIGRlZmluZUJsb2NrLmNvbG91clNlY29uZGFyeV8sIGRlZmluZUJsb2NrLmNvbG91clRlcnRpYXJ5Xyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGJsb2NrLnNldENvbG91ciguLi5PYmplY3QudmFsdWVzKFNCLkNvbG91cnMubW9yZSkpOwogICAgICB9CiAgICAgIHN5bmNGaWVsZENvbG9ycyhibG9jayk7CiAgICB9CgogICAgY29uc3Qgb2dTZXREcmFnZ2luZyA9IFNCLkJsb2NrU3ZnLnByb3RvdHlwZS5zZXREcmFnZ2luZzsKICAgIGNvbnN0IGFyZ3VtZW50UmVwb3J0ZXJTZXREcmFnZ2luZyA9IGZ1bmN0aW9uKGFkZGluZykgewogICAgICBpZiAoIWFkZGluZyAmJiAhZXh0ZW5zaW9uUmVtb3ZhYmxlICYmIHRoaXMuc3ZnR3JvdXBfLmNsYXNzTGlzdC5jb250YWlucygiYmxvY2tseURyYWdnaW5nIikpIHsKICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB1cGRhdGVBcmd1bWVudFJlcG9ydGVyQ29sb3IodGhpcykpOwogICAgICB9CiAgICAgIG9nU2V0RHJhZ2dpbmcuY2FsbCh0aGlzLCBhZGRpbmcpOwogICAgfTsKICAgIC8vIHRoaXMgd291bGQgcnVuIHdoZW4gdGhlIGJsb2NrIGlzIGFkZGVkIHRvIHRoZSB3b3Jrc3BhY2UKICAgIGNvbnN0IG9nU2V0UGFyZW50ID0gU0IuQmxvY2tTdmcucHJvdG90eXBlLnNldFBhcmVudDsKICAgIGNvbnN0IGFyZ3VtZW50UmVwb3J0ZXJTZXRQYXJlbnQgPSBmdW5jdGlvbihuZXdQYXJlbnQpIHsKICAgICAgaWYgKG5ld1BhcmVudCAmJiAhZXh0ZW5zaW9uUmVtb3ZhYmxlKSBxdWV1ZU1pY3JvdGFzaygoKSA9PiB1cGRhdGVBcmd1bWVudFJlcG9ydGVyQ29sb3IodGhpcykpOwogICAgICBvZ1NldFBhcmVudC5jYWxsKHRoaXMsIG5ld1BhcmVudCk7CiAgICB9OwoKICAgIGZvciAoY29uc3Qgb3Bjb2RlIG9mIHJlY29sb3JhYmxlcykgewogICAgICBpZiAoIVNCLkJsb2Nrc1tvcGNvZGVdKSBjb250aW51ZTsKICAgICAgU0IuQmxvY2tzW29wY29kZV0uc2V0RHJhZ2dpbmcgPSBhcmd1bWVudFJlcG9ydGVyU2V0RHJhZ2dpbmc7CiAgICAgIFNCLkJsb2Nrc1tvcGNvZGVdLnNldFBhcmVudCA9IGFyZ3VtZW50UmVwb3J0ZXJTZXRQYXJlbnQ7CiAgICB9CiAgICB0cnkgewogICAgICBTQi5FeHRlbnNpb25zLnJlZ2lzdGVyKCJTUG1icENTVF9kZWZpbmVDb2xvcmVkIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zZXREcmFnZ2luZyA9IGFyZ3VtZW50UmVwb3J0ZXJTZXREcmFnZ2luZzsKICAgICAgICB0aGlzLnNldFBhcmVudCA9IGFyZ3VtZW50UmVwb3J0ZXJTZXRQYXJlbnQ7CiAgICAgICAgdXBkYXRlQXJndW1lbnRSZXBvcnRlckNvbG9yKHRoaXMpOwogICAgICB9KTsKICAgIH0gY2F0Y2ggey8qIGFscmVhZHkgZGVmaW5lZCAqL30KCiAgICAvLyBUdXJuIHByb2NlZHVyZSBjYWxscyBtYXJrZWQgYXMgY2FwIGJsb2NrcyBpbnRvIGNhcCBibG9ja3MgaWYgdGhleSBjYW4gYmUgdHVybmVkIGludG8gY2FwIGJsb2NrcwogICAgZnVuY3Rpb24gY2hlY2tDYXBCbG9jayhibG9jaykgewogICAgICBpZiAoIWJsb2NrLmlzSW5zZXJ0aW9uTWFya2VyKCkpIHsKICAgICAgICBjb25zdCBzdG9yZSA9IHN0b3JlR2V0KGJsb2NrLnByb2NDb2RlXyk7CiAgICAgICAgaWYgKHN0b3JlICYmIHN0b3JlLmlzVGVybWluYWwgJiYgYmxvY2submV4dENvbm5lY3Rpb24gJiYgIWJsb2NrLmdldE5leHRCbG9jaygpKQogICAgICAgICAgYmxvY2suc2V0TmV4dFN0YXRlbWVudCghc3RvcmUuaXNUZXJtaW5hbCwgaXNQTSA/ICJub3JtYWwiIDogdW5kZWZpbmVkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBUaGUgaW5zZXJ0aW9uIG1hcmtlciBzaG91bGQgY29weSB0aGUgbmV4dCBjb25uZWN0aW9uIG9mIHRoZSBzb3VyY2UgYmxvY2sKICAgICAgICBibG9jay5zZXROZXh0U3RhdGVtZW50KEJvb2xlYW4oYmxvY2suZ2V0TmV4dEJsb2NrKCkpLCBpc1BNID8gIm5vcm1hbCIgOiB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgICAvLyBGb3IgdGhlIHByZXZpb3VzIGJsb2NrIHdoZW4gc3RhcnRpbmcgYSBkcmFnIG9mIHRoZSBjdXJyZW50IGJsb2NrCiAgICBjb25zdCBvZ1VucGx1ZyA9IFNCLkJsb2NrLnByb3RvdHlwZS51bnBsdWc7CiAgICBjb25zdCBwcm9jQ2FsbFVucGx1ZyA9IGZ1bmN0aW9uKG9wdF9oZWFsU3RhY2spIHsKICAgICAgaWYgKGV4dGVuc2lvblJlbW92YWJsZSB8fCB0aGlzLmlzSW5zZXJ0aW9uTWFya2VyKCkgfHwgdGhpcy5nZXRQYXJlbnQoKT8uaXNJbnNlcnRpb25NYXJrZXIoKSkgcmV0dXJuIG9nVW5wbHVnLmNhbGwodGhpcywgb3B0X2hlYWxTdGFjayk7CiAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuZ2V0UGFyZW50KCk7CiAgICAgIG9nVW5wbHVnLmNhbGwodGhpcywgb3B0X2hlYWxTdGFjayk7CiAgICAgIGNoZWNrQ2FwQmxvY2sodGhpcyk7CiAgICAgIGlmIChwYXJlbnQpIGNoZWNrQ2FwQmxvY2socGFyZW50KTsKICAgIH07CiAgICBTQi5CbG9ja3NbInByb2NlZHVyZXNfY2FsbCJdLnVucGx1ZyA9IHByb2NDYWxsVW5wbHVnOwoKICAgIC8vIENvcHkgdGhlIGRlZmluZSBibG9jaydzIGFyZ3VtZW50IGNvbG9yIHdoZW4gZHJhZ2dpbmcgYW4gYXJndW1lbnQgcmVwb3J0ZXIKICAgIGNvbnN0IG9sZER1cGxpY2F0ZU9uRHJhZ18gPSBTQi5HZXN0dXJlLnByb3RvdHlwZS5kdXBsaWNhdGVPbkRyYWdfOwogICAgU0IuR2VzdHVyZS5wcm90b3R5cGUuZHVwbGljYXRlT25EcmFnXyA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBzb3VyY2UgPSB0aGlzLnRhcmdldEJsb2NrXzsKICAgICAgb2xkRHVwbGljYXRlT25EcmFnXy5jYWxsKHRoaXMpOwogICAgICBjb25zdCBkdXBsaWNhdGVkID0gdGhpcy50YXJnZXRCbG9ja187CiAgICAgIGlmIChzb3VyY2UgJiYgZHVwbGljYXRlZCAmJiBzb3VyY2UudHlwZS5zdGFydHNXaXRoKCJhcmd1bWVudF9yZXBvcnRlcl8iKSkKICAgICAgICBkdXBsaWNhdGVkLnNldENvbG91cihzb3VyY2UuY29sb3VyXywgc291cmNlLmNvbG91clNlY29uZGFyeV8sIHNvdXJjZS5jb2xvdXJUZXJ0aWFyeV8pOwogICAgfTsKCiAgICAvLyBEaXNhYmxlIGJyYW5jaCBhcmd1bWVudCByZXBvcnRlciBkcmFnZ2luZwogICAgY29uc3Qgb2xkc3RhcnREcmFnZ2luZ18gPSBTQi5HZXN0dXJlLnByb3RvdHlwZS5zdGFydERyYWdnaW5nQmxvY2tfOwogICAgU0IuR2VzdHVyZS5wcm90b3R5cGUuc3RhcnREcmFnZ2luZ0Jsb2NrXyA9IGZ1bmN0aW9uKCkgewogICAgICBjb25zdCBzb3VyY2UgPSB0aGlzLnRhcmdldEJsb2NrXzsKICAgICAgaWYgKHNvdXJjZVt0YXJnZXRQcm9jRGF0YV0gPT09ICJicmFuY2hEcmFnIikgewogICAgICAgIHRoaXMuaXNEcmFnZ2luZ0Jsb2NrXyA9IGZhbHNlOwogICAgICAgIHRoaXMuZGlzcG9zZSgpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBvbGRzdGFydERyYWdnaW5nXy5jYWxsKHRoaXMpOwogICAgfTsKCiAgICAvLyBQYXRjaCBQcm9jZWR1cmUgRWRpdCBhbmQgQ3JlYXRlIHRvIGFsc28gb3BlbiBvdXIgTW9kYWwKICAgIGNvbnN0IHByb2NzID0gU0IuUHJvY2VkdXJlczsKICAgIGNvbnN0IG9nQ3JlYXRlQ2FsbCA9IHByb2NzLmNyZWF0ZVByb2NlZHVyZURlZkNhbGxiYWNrXzsKICAgIGlmIChydW50aW1lLlNQbWJwQ1NUT2xkU3RvcmFnZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIHByb2NzLmNyZWF0ZVByb2NlZHVyZURlZkNhbGxiYWNrXyA9IGZ1bmN0aW9uKHdvcmtzcGFjZSkgewogICAgICAgIGNvbnN0IHNoYXJlZFdvcmsgPSBTQi5tYWluV29ya3NwYWNlOwogICAgICAgIG9nQ3JlYXRlQ2FsbC5jYWxsKHRoaXMsIHdvcmtzcGFjZSk7CiAgICAgICAgb3BlbkJsb2NrTWFrZXIoc2hhcmVkV29yaywgZmFsc2UpOwogICAgICB9OwogICAgICBjb25zdCBvZ0VkaXRDYWxsID0gcHJvY3MuZWRpdFByb2NlZHVyZUNhbGxiYWNrXzsKICAgICAgcHJvY3MuZWRpdFByb2NlZHVyZUNhbGxiYWNrXyA9IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgICAgaWYgKGJsb2NrLnR5cGUgPT09ICJwcm9jZWR1cmVzX2NhbGwiKSB7CiAgICAgICAgICBjb25zdCBpc0dsb2JhbCA9IGdsb2JhbEJsb2Nrc0NhY2hlW2Jsb2NrLnByb2NDb2RlX107CiAgICAgICAgICBpZiAoaXNHbG9iYWwgJiYgaXNHbG9iYWwuaWQgIT09IHZtLmVkaXRpbmdUYXJnZXQuaWQpIHsKICAgICAgICAgICAgdm0ub25jZSgid29ya3NwYWNlVXBkYXRlIiwgKCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IGJsb2NrSWQgPSB2bS5lZGl0aW5nVGFyZ2V0LmJsb2Nrcy5nZXRQcm9jZWR1cmVEZWZpbml0aW9uKGJsb2NrLnByb2NDb2RlXyk7CiAgICAgICAgICAgICAgYmxvY2sgPSBTQi5tYWluV29ya3NwYWNlLmdldEJsb2NrQnlJZChibG9ja0lkKTsKICAgICAgICAgICAgICByZXR1cm4gcHJvY3MuZWRpdFByb2NlZHVyZUNhbGxiYWNrXy5jYWxsKHRoaXMsIGJsb2NrKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZtLnNldEVkaXRpbmdUYXJnZXQoaXNHbG9iYWwuaWQpOwogICAgICAgICAgICByZXR1cm47IAogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBzaGFyZWRXb3JrID0gU0IubWFpbldvcmtzcGFjZTsKICAgICAgICBjb25zdCB2YWwgPSBvZ0VkaXRDYWxsLmNhbGwodGhpcywgYmxvY2spOwogICAgICAgIG9wZW5CbG9ja01ha2VyKHNoYXJlZFdvcmssIHRydWUpOwogICAgICAgIHJldHVybiB2YWw7CiAgICAgIH0KICAgIH0KICAgIC8vIFBhdGNoIFByb2NlZHVyZSBGbHlvdXQgdG8gYWxzbyBpbnRlcmFjdCB3aXRoIHRoZSBleHRlbnNpb24KICAgIGNvbnN0IG9nRmx5b3V0Q2FsbCA9IHByb2NzLmZseW91dENhdGVnb3J5OwogICAgcHJvY3MuZmx5b3V0Q2F0ZWdvcnkgPSBmdW5jdGlvbih3b3Jrc3BhY2UpIHsKICAgICAgY29uc3QgdmFsID0gb2dGbHlvdXRDYWxsLmNhbGwodGhpcywgd29ya3NwYWNlKTsKICAgICAgaWYgKHZhbC5sZW5ndGggIT09IG9sZExpc3RMZW5ndGgpIGxpc3ROZWVkc1JlZnJlc2ggPSB0cnVlOwogICAgICBjb21waWxlUHJvY2VkdXJlcyh2YWwsIHdvcmtzcGFjZSwgcHJvY3MpOwogICAgICByZXR1cm4gdmFsOwogICAgfQogIH0pCgogIC8vIE90aGVyIHBhdGNoZXMKICBmdW5jdGlvbiBwYXRjaFRhcmdldCgpIHsKICAgIC8vIGNyZWF0ZSBhIHRhcmdldCB0byBwYXRjaCBUYXJnZXQuQmxvY2tzCiAgICBjb25zdCB0YXJnZXQgPSBuZXcgdm0uZXhwb3J0cy5SZW5kZXJlZFRhcmdldCh7YmxvY2tzOiBudWxsfSwgcnVudGltZSk7CgogICAgY29uc3QgQmxvY2tzID0gdGFyZ2V0LmJsb2Nrcy5jb25zdHJ1Y3RvcjsKICAgIGNvbnN0IG9sZEdldFByb2NEZWYgPSBCbG9ja3MucHJvdG90eXBlLmdldFByb2NlZHVyZURlZmluaXRpb247CiAgICBCbG9ja3MucHJvdG90eXBlLmdldFByb2NlZHVyZURlZmluaXRpb24gPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGNvbnN0IGRlZmluaXRpb24gPSBvbGRHZXRQcm9jRGVmLmNhbGwodGhpcywgbmFtZSk7CiAgICAgIGlmICghZGVmaW5pdGlvbiAmJiBnbG9iYWxCbG9ja3NDYWNoZVtuYW1lXSAmJiBnbG9iYWxCbG9ja3NDYWNoZVtuYW1lXS5ibG9ja3MgIT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gZ2xvYmFsQmxvY2tzQ2FjaGVbbmFtZV0uYmxvY2tzLmdldFByb2NlZHVyZURlZmluaXRpb24obmFtZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRlZmluaXRpb247CiAgICB9CiAgICBjb25zdCBvbGRHZXRCbG9jayA9IEJsb2Nrcy5wcm90b3R5cGUuZ2V0QmxvY2s7CiAgICBCbG9ja3MucHJvdG90eXBlLmdldEJsb2NrID0gZnVuY3Rpb24obmFtZSkgewogICAgICBsZXQgdGhpc0Jsb2NrOwoKICAgICAgLy8gZ2xvYmFscyB0YWtlIHByaW9yaXR5CiAgICAgIGlmIChnbG9iYWxUYXJnZXRGb2N1cykgewogICAgICAgIHRoaXNCbG9jayA9IG9sZEdldEJsb2NrLmNhbGwoZ2xvYmFsVGFyZ2V0Rm9jdXMuYmxvY2tzLCBuYW1lKTsKICAgICAgICBpZiAoIXRoaXNCbG9jayB8fCB0aGlzQmxvY2submV4dCA9PT0gbnVsbCkgZ2xvYmFsVGFyZ2V0Rm9jdXMgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHRoaXNCbG9jaykgcmV0dXJuIHRoaXNCbG9jazsKICAgICAgfQoKICAgICAgdGhpc0Jsb2NrID0gb2xkR2V0QmxvY2suY2FsbCh0aGlzLCBuYW1lKTsKICAgICAgaWYgKHRoaXNCbG9jaykgcmV0dXJuIHRoaXNCbG9jazsKCiAgICAgIGxldCBmb2N1c1RhcmdldDsKICAgICAgZm9yIChjb25zdCB0YXJnZXQgb2YgdGhpcy5ydW50aW1lLnRhcmdldHMpIHsKICAgICAgICBpZiAoIXRhcmdldC5pc09yaWdpbmFsIHx8IHRhcmdldC5ibG9ja3MgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgIHRoaXNCbG9jayA9IG9sZEdldEJsb2NrLmNhbGwodGFyZ2V0LmJsb2NrcywgbmFtZSk7CiAgICAgICAgaWYgKHRoaXNCbG9jaykgewogICAgICAgICAgZm9jdXNUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aGlzQmxvY2sgJiYgZ2xvYmFsVGFyZ2V0Rm9jdXMgPT09IHVuZGVmaW5lZCkgZ2xvYmFsVGFyZ2V0Rm9jdXMgPSBmb2N1c1RhcmdldDsKICAgICAgZWxzZSBpZiAoIXRoaXNCbG9jayB8fCB0aGlzQmxvY2submV4dCA9PT0gbnVsbCkgZ2xvYmFsVGFyZ2V0Rm9jdXMgPSB1bmRlZmluZWQ7CiAgICAgIHJldHVybiB0aGlzQmxvY2s7CiAgICB9CiAgICBjb25zdCBvbGRHZXRCcmFuY2ggPSBCbG9ja3MucHJvdG90eXBlLmdldEJyYW5jaDsKICAgIEJsb2Nrcy5wcm90b3R5cGUuZ2V0QnJhbmNoID0gZnVuY3Rpb24oaWQsIGJyYW5jaE51bSkgewogICAgICBjb25zdCB0aGlzQmxvY2sgPSBvbGRHZXRCcmFuY2guY2FsbCh0aGlzLCBpZCwgYnJhbmNoTnVtKTsKICAgICAgaWYgKHRoaXNCbG9jaykgcmV0dXJuIHRoaXNCbG9jazsKICAgICAgZm9yIChjb25zdCB0YXJnZXQgb2YgdGhpcy5ydW50aW1lLnRhcmdldHMpIHsKICAgICAgICBpZiAoIXRhcmdldC5pc09yaWdpbmFsIHx8IHRhcmdldC5ibG9ja3MgPT09IHRoaXMpIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IHRhcmdldEJsb2NrID0gb2xkR2V0QnJhbmNoLmNhbGwodGFyZ2V0LmJsb2NrcywgaWQsIGJyYW5jaE51bSk7CiAgICAgICAgaWYgKHRhcmdldEJsb2NrKSByZXR1cm4gdGFyZ2V0QmxvY2s7CiAgICAgIH0KICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGNvbnN0IG9sZFBvcFByb2NDYWNoZSA9IEJsb2Nrcy5wcm90b3R5cGUucG9wdWxhdGVQcm9jZWR1cmVDYWNoZTsKICAgIEJsb2Nrcy5wcm90b3R5cGUucG9wdWxhdGVQcm9jZWR1cmVDYWNoZSA9IGZ1bmN0aW9uKCkgewogICAgICBvbGRQb3BQcm9jQ2FjaGUuY2FsbCh0aGlzKTsKICAgICAgcmVmcmVzaEdsb2JhbEJsb2Nrc0NhY2hlKCk7CiAgICAgIGZvciAoY29uc3QgcHJvY2NvZGUgb2YgT2JqZWN0LmtleXMoZ2xvYmFsQmxvY2tzQ2FjaGUpKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0ID0gZ2xvYmFsQmxvY2tzQ2FjaGVbcHJvY2NvZGVdOwogICAgICAgIGlmICh0YXJnZXQuYmxvY2tzID09PSB0aGlzKSBjb250aW51ZTsKICAgICAgICBvbGRQb3BQcm9jQ2FjaGUuY2FsbCh0YXJnZXQuYmxvY2tzKTsKICAgICAgICAvLyBhZGQgZ2xvYmFsIGJsb2NrcyB0byB0aGlzIGNhY2hlIGlmIHRoZXkgYXJlbid0IHByZXNlbnQgYWxyZWFkeQogICAgICAgIHRoaXMuX2NhY2hlLnByb2NlZHVyZVBhcmFtTmFtZXNbcHJvY2NvZGVdID0gdGFyZ2V0LmJsb2Nrcy5fY2FjaGUucHJvY2VkdXJlUGFyYW1OYW1lc1twcm9jY29kZV07CiAgICAgICAgdGhpcy5fY2FjaGUucHJvY2VkdXJlRGVmaW5pdGlvbnNbcHJvY2NvZGVdID0gdGFyZ2V0LmJsb2Nrcy5fY2FjaGUucHJvY2VkdXJlRGVmaW5pdGlvbnNbcHJvY2NvZGVdOwogICAgICB9CiAgICB9OwogICAgY29uc3Qgb2xkR2V0SW5wdXRzID0gQmxvY2tzLnByb3RvdHlwZS5nZXRJbnB1dHM7CiAgICBCbG9ja3MucHJvdG90eXBlLmdldElucHV0cyA9IGZ1bmN0aW9uKGJsb2NrKSB7CiAgICAgIGlmIChibG9jay5vcGNvZGUgIT09ICJwcm9jZWR1cmVzX2NhbGwiKSByZXR1cm4gb2xkR2V0SW5wdXRzLmNhbGwodGhpcywgYmxvY2spOwoKICAgICAgaWYgKHR5cGVvZiBibG9jayA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwogICAgICBsZXQgaW5wdXRzID0gdGhpcy5fY2FjaGUuaW5wdXRzW2Jsb2NrLmlkXTsKICAgICAgaWYgKHR5cGVvZiBpbnB1dHMgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICByZXR1cm4gaW5wdXRzOwogICAgICB9CgogICAgICBsZXQgc3RvcmVUYXJnZXQgPSB2bS5lZGl0aW5nVGFyZ2V0OwogICAgICBmb3IgKGNvbnN0IHRhcmdldCBvZiB0aGlzLnJ1bnRpbWUudGFyZ2V0cykgewogICAgICAgIGlmICghdGFyZ2V0LmlzT3JpZ2luYWwgfHwgdGFyZ2V0LmJsb2NrcyAhPT0gdGhpcykgY29udGludWU7CiAgICAgICAgc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgCiAgICAgIGNvbnN0IHN0b3JlID0gc3RvcmVHZXQoYmxvY2subXV0YXRpb24ucHJvY2NvZGUsIHN0b3JlVGFyZ2V0KTsKICAgICAgaW5wdXRzID0ge307CiAgICAgIGZvciAoY29uc3QgaW5wdXQgaW4gYmxvY2suaW5wdXRzKSB7CiAgICAgICAgICAvLyBJZ25vcmUgYmxvY2tzIHByZWZpeGVkIHdpdGggYnJhbmNoIHByZWZpeCwgYW5kIGN1c3RvbSBicmFuY2ggaW5wdXRzLgogICAgICAgICAgaWYgKAogICAgICAgICAgICAhc3RvcmUuaW5wdXRzIHx8CiAgICAgICAgICAgIGlucHV0LnN1YnN0cmluZygwLCBCbG9ja3MuQlJBTkNIX0lOUFVUX1BSRUZJWC5sZW5ndGgpICE9PSBCbG9ja3MuQlJBTkNIX0lOUFVUX1BSRUZJWAogICAgICAgICAgICAmJiAhKHN0b3JlLmlucHV0c1tpbnB1dF0gJiYgc3RvcmUuaW5wdXRzW2lucHV0XS50eXBlID09PSAiYnJjIikKICAgICAgICAgICkgaW5wdXRzW2lucHV0XSA9IGJsb2NrLmlucHV0c1tpbnB1dF07CiAgICAgIH0KICAgICAgdGhpcy5fY2FjaGUuaW5wdXRzW2Jsb2NrLmlkXSA9IGlucHV0czsKICAgICAgcmV0dXJuIGlucHV0czsKICAgIH0KICB9CiAgcGF0Y2hUYXJnZXQoKTsKCiAgaWYgKHJ1bnRpbWUudGFyZ2V0cy5sZW5ndGgpIHsKICAgIC8vIE1ha2UgdGhlIGV4dGVuc2lvbiBzdGF5IGJ5IGFkZGluZyBhIGR1bW15IGJsb2NrCiAgICBjb25zdCBibG9ja3MgPSBydW50aW1lLnRhcmdldHNbMF0uYmxvY2tzOwogICAgYmxvY2tzLl9ibG9ja3NbVEVNUF9CTE9DS19PUENPREVdID0gewogICAgICBvcGNvZGU6IFRFTVBfQkxPQ0tfT1BDT0RFLCBpZDogVEVNUF9CTE9DS19PUENPREUsIGZpZWxkczoge30sCiAgICAgIG5leHQ6IG51bGwsIHBhcmVudDogbnVsbCwgc2hhZG93OiB0cnVlLCB0b0xldmVsOiB0cnVlLAogICAgICB4OiB1bmRlZmluZWQsIHk6IHVuZGVmaW5lZAogICAgfQogIH0KICAvLyBwcm9qZWN0IGxvYWRlZCwgYWRkIGluIHRoZSB0ZW1wIGJsb2NrIGlmIGl0IGlzbnQgdGhlcmUKICBydW50aW1lLm9uY2UoIlBST0pFQ1RfTE9BREVEIiwgKCkgPT4gewogICAgZm9yIChjb25zdCB0YXJnZXQgb2YgcnVudGltZS50YXJnZXRzKSB7CiAgICAgIGNvbnN0IGJsb2NrcyA9IE9iamVjdC52YWx1ZXModGFyZ2V0LmJsb2Nrcy5fYmxvY2tzKQogICAgICBpZiAoYmxvY2tzLnNvbWUoYmxvY2sgPT4gYmxvY2sub3Bjb2RlID09PSBURU1QX0JMT0NLX09QQ09ERSkpIHJldHVybjsKICAgIH0KICAgIGNvbnN0IGJsb2NrcyA9IHJ1bnRpbWUudGFyZ2V0c1swXS5ibG9ja3M7CiAgICBibG9ja3MuX2Jsb2Nrc1tURU1QX0JMT0NLX09QQ09ERV0gPSB7CiAgICAgIG9wY29kZTogVEVNUF9CTE9DS19PUENPREUsIGlkOiBURU1QX0JMT0NLX09QQ09ERSwgZmllbGRzOiB7fSwKICAgICAgbmV4dDogbnVsbCwgcGFyZW50OiBudWxsLCBzaGFkb3c6IHRydWUsIHRvTGV2ZWw6IHRydWUsCiAgICAgIHg6IHVuZGVmaW5lZCwgeTogdW5kZWZpbmVkCiAgICB9CiAgfSk7CiAgY29uc3Qgb2xkVG9KU09OID0gdm0uY29uc3RydWN0b3IucHJvdG90eXBlLnRvSlNPTjsKICB2bS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24oLi4uYXJncykgewogICAgaWYgKGV4dGVuc2lvblJlbW92YWJsZSkgcmV0dXJuIG9sZFRvSlNPTi5hcHBseSh0aGlzLCBhcmdzKTsKICAgIGlmICghaXNQTSkgewogICAgICAvLyBwZW5ndWlubW9kIGF1dG9tYXRpY2FsbHkgZG9lcyB0aGlzCiAgICAgIHN1c3BlbmRSZW1vdmFsID0gZmFsc2U7CiAgICAgIHJlbW92ZVVudXNlZFByb2NzKCk7CiAgICAgIHJlbW92ZVVudXNlZEltYWdlcygpOwogICAgICBleHQ/LnNlcmlhbGl6ZSgpOwogICAgfQoKICAgIGNvbnN0IGpzb25TdHIgPSBvbGRUb0pTT04uYXBwbHkodGhpcywgYXJncyk7CiAgICByZXR1cm4ganNvblN0cjsKICB9CgogIGNvbnN0IG9sZEdldE9wY29kZSA9IHJ1bnRpbWUuZ2V0T3Bjb2RlRnVuY3Rpb247CiAgcnVudGltZS5jb25zdHJ1Y3Rvci5wcm90b3R5cGUuZ2V0T3Bjb2RlRnVuY3Rpb24gPSBmdW5jdGlvbihvcGNvZGUpIHsKICAgIGlmIChvcGNvZGUgPT09ICJwcm9jZWR1cmVzX2NhbGwiKSByZXR1cm4gcGF0Y2hlZENhbGxGdW5jOwogICAgcmV0dXJuIG9sZEdldE9wY29kZS5jYWxsKHRoaXMsIG9wY29kZSk7CiAgfQoKICBjb25zdCBwYXRjaGVkQ2FsbEZ1bmMgPSAoYXJncywgdXRpbCkgPT4gewogICAgLy8gUGF0Y2hlZCBCbG9jayBjb2RlIGZyb206CiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vVHVyYm9XYXJwL3NjcmF0Y2gtdm0vYmxvYi9kZXZlbG9wL3NyYy9ibG9ja3Mvc2NyYXRjaDNfcHJvY2VkdXJlcy5qcyNMMjgtTDgyCiAgICBjb25zdCB0aHJlYWQgPSB1dGlsLnRocmVhZDsKICAgIGNvbnN0IHN0YWNrRnJhbWUgPSB1dGlsLnN0YWNrRnJhbWU7CiAgICBjb25zdCBpc1JlcG9ydGVyID0gISFhcmdzLm11dGF0aW9uLnJldHVybjsKICAgIGlmIChzdGFja0ZyYW1lLmV4ZWN1dGVkKSB7CiAgICAgIGlmICh0aHJlYWQuaXNNQlBQYXRjaGVkKSB7CiAgICAgICAgLy8gcGF0Y2ggdGhpcyBmdW5jdGlvbiBmb3IgdGhlIHRocmVhZAogICAgICAgIHRocmVhZC5pc01CUFBhdGNoZWQgPSB1bmRlZmluZWQ7CiAgICAgICAgdGhyZWFkLnRhcmdldC5ibG9ja3MuZ2V0TmV4dEJsb2NrID0gdGhyZWFkW3RhcmdldFByb2NEYXRhXS5vZ05leHQ7CiAgICAgIH0KICAgICAgaWYgKGlzUmVwb3J0ZXIpIHsKICAgICAgICBjb25zdCByZXR1cm5WYWx1ZSA9IHN0YWNrRnJhbWUucmV0dXJuVmFsdWU7CiAgICAgICAgY29uc3QgdGhyZWFkU3RhY2tGcmFtZSA9IHRocmVhZC5wZWVrU3RhY2tGcmFtZSgpOwogICAgICAgIHRocmVhZFN0YWNrRnJhbWUucGFyYW1zID0gbnVsbDsKICAgICAgICBkZWxldGUgc3RhY2tGcmFtZS5yZXR1cm5WYWx1ZTsKICAgICAgICBkZWxldGUgc3RhY2tGcmFtZS5leGVjdXRlZDsKICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IHByb2NlZHVyZUNvZGUgPSBhcmdzLm11dGF0aW9uLnByb2Njb2RlOwogICAgbGV0IGlzR2xvYmFsID0gZ2xvYmFsQmxvY2tzQ2FjaGVbcHJvY2VkdXJlQ29kZV07CiAgICBpZiAoaXNHbG9iYWwgJiYgaXNHbG9iYWwuaWQgPT09IHV0aWwudGFyZ2V0LnNwcml0ZS5jbG9uZXNbMF0uaWQpIGlzR2xvYmFsID0gdW5kZWZpbmVkOwoKICAgIGNvbnN0IHBhcmFtTmFtZXNJZHNBbmREZWZhdWx0cyA9IChpc0dsb2JhbCA/IGlzR2xvYmFsLmJsb2NrcyA6IHV0aWwpLmdldFByb2NlZHVyZVBhcmFtTmFtZXNJZHNBbmREZWZhdWx0cyhwcm9jZWR1cmVDb2RlKTsKICAgIGlmIChwYXJhbU5hbWVzSWRzQW5kRGVmYXVsdHMgPT09IG51bGwpIHsKICAgICAgaWYgKGlzUmVwb3J0ZXIpIHJldHVybiAiIjsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IFtwYXJhbU5hbWVzLCBwYXJhbUlkcywgcGFyYW1EZWZhdWx0c10gPSBwYXJhbU5hbWVzSWRzQW5kRGVmYXVsdHM7CiAgICB1dGlsLmluaXRQYXJhbXMoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1JZHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChhcmdzLCBwYXJhbUlkc1tpXSkpIHV0aWwucHVzaFBhcmFtKHBhcmFtTmFtZXNbaV0sIGFyZ3NbcGFyYW1JZHNbaV1dKTsKICAgICAgZWxzZSB1dGlsLnB1c2hQYXJhbShwYXJhbU5hbWVzW2ldLCBwYXJhbURlZmF1bHRzW2ldKTsKICAgIH0KCiAgICBjb25zdCBhZGRvbkJsb2NrID0gdXRpbC5ydW50aW1lLmdldEFkZG9uQmxvY2socHJvY2VkdXJlQ29kZSk7CiAgICBpZiAoYWRkb25CbG9jaykgewogICAgICBjb25zdCByZXN1bHQgPSBhZGRvbkJsb2NrLmNhbGxiYWNrKHRocmVhZC5nZXRBbGxwYXJhbXMoKSwgdXRpbCk7CiAgICAgIGlmICh0aHJlYWQuc3RhdHVzID09PSAxKSBzdGFja0ZyYW1lLmV4ZWN1dGVkID0gdHJ1ZTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBzdGFja0ZyYW1lLmV4ZWN1dGVkID0gdHJ1ZTsKICAgIGNvbnN0IGZyYW1lID0gdGhyZWFkLnBlZWtTdGFja0ZyYW1lKCk7CiAgICBpZiAoaXNSZXBvcnRlcikgewogICAgICBmcmFtZS53YWl0aW5nUmVwb3J0ZXIgPSB0cnVlOwogICAgICBzdGFja0ZyYW1lLnJldHVyblZhbHVlID0gIiI7CiAgICB9CiAgICB0aHJlYWRbdGFyZ2V0UHJvY0RhdGFdID0gewogICAgICBvZ05leHQ6IHRocmVhZC50YXJnZXQuYmxvY2tzLmdldE5leHRCbG9jaywKICAgICAgYmxvY2s6IGZyYW1lLm9wLCBmcmFtZSwKICAgICAgcGFyYW1zOiBwYXJhbU5hbWVzSWRzQW5kRGVmYXVsdHMKICAgIH07CiAgICB1dGlsLnN0YXJ0UHJvY2VkdXJlKHsgcHJvYzogcHJvY2VkdXJlQ29kZSwgaXNHbG9iYWwgfSk7CiAgfTsKCiAgY29uc3Qgb2xkU3RlcDJQcm9jID0gcnVudGltZS5zZXF1ZW5jZXIuc3RlcFRvUHJvY2VkdXJlOwogIHJ1bnRpbWUuc2VxdWVuY2VyLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGVwVG9Qcm9jZWR1cmUgPSBmdW5jdGlvbih0aHJlYWQsIHByb2NlZHVyZUNvZGUpIHsKICAgIGlmIChwcm9jZWR1cmVDb2RlLmlzR2xvYmFsID09PSB1bmRlZmluZWQpIG9sZFN0ZXAyUHJvYy5jYWxsKHRoaXMsIHRocmVhZCwgcHJvY2VkdXJlQ29kZS5wcm9jKTsKICAgIGVsc2UgewogICAgICBjb25zdCBvZ1RhcmdldCA9IHByb2NlZHVyZUNvZGUuaXNHbG9iYWw7CiAgICAgIGNvbnN0IGRlZiA9IG9nVGFyZ2V0LmJsb2Nrcy5nZXRQcm9jZWR1cmVEZWZpbml0aW9uKHByb2NlZHVyZUNvZGUucHJvYyk7CiAgICAgIGlmICghZGVmKSByZXR1cm47CiAgICAgIGlmICh0aHJlYWQuaXNNQlBQYXRjaGVkID09PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBwYXRjaCB0aGlzIGZ1bmN0aW9uIGZvciB0aGUgdGhyZWFkCiAgICAgICAgdGhyZWFkLmlzTUJQUGF0Y2hlZCA9IHRydWU7CiAgICAgICAgY29uc3Qgb2dHZXROZXh0ID0gdGhyZWFkLnRhcmdldC5ibG9ja3MuZ2V0TmV4dEJsb2NrOwogICAgICAgIHRocmVhZC50YXJnZXQuYmxvY2tzLmdldE5leHRCbG9jayA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICBjb25zdCBibG9jayA9IG9nR2V0TmV4dC5jYWxsKHRoaXMsIGlkKTsKICAgICAgICAgIGlmIChibG9jaykgcmV0dXJuIGJsb2NrOwogICAgICAgICAgZWxzZSByZXR1cm4gb2dUYXJnZXQuYmxvY2tzLmdldE5leHRCbG9jayhpZCkgPz8gbnVsbDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGlzUmVjdXJzaXZlID0gdGhyZWFkLmlzUmVjdXJzaXZlQ2FsbChwcm9jZWR1cmVDb2RlLnByb2MpOwogICAgICB0aHJlYWQucHVzaFN0YWNrKGRlZik7CiAgICAgIGlmICh0aHJlYWQucGVla1N0YWNrRnJhbWUoKS53YXJwTW9kZSAmJiB0aHJlYWQud2FycFRpbWVyLnRpbWVFbGFwc2VkKCkgPiBTZXF1ZW5jZXIuV0FSUF9USU1FKSB0aHJlYWQuc3RhdHVzID0gVGhyZWFkLlNUQVRVU19ZSUVMRDsKICAgICAgZWxzZSB7CiAgICAgICAgY29uc3QgZGVmQmxvY2sgPSBvZ1RhcmdldC5ibG9ja3MuZ2V0QmxvY2soZGVmKTsKICAgICAgICBjb25zdCBpbm5lckJsb2NrID0gb2dUYXJnZXQuYmxvY2tzLmdldEJsb2NrKGRlZkJsb2NrLmlucHV0cy5jdXN0b21fYmxvY2suYmxvY2spOwogICAgICAgIGxldCBkb1dhcnAgPSBmYWxzZTsKICAgICAgICBpZiAoaW5uZXJCbG9jayAmJiBpbm5lckJsb2NrLm11dGF0aW9uKSB7CiAgICAgICAgICBjb25zdCB3YXJwID0gaW5uZXJCbG9jay5tdXRhdGlvbi53YXJwOwogICAgICAgICAgaWYgKHR5cGVvZiB3YXJwID09PSAiYm9vbGVhbiIpIGRvV2FycCA9IHdhcnA7CiAgICAgICAgICBlbHNlIGlmICh0eXBlb2Ygd2FycCA9PT0gInN0cmluZyIpIGRvV2FycCA9IEpTT04ucGFyc2Uod2FycCk7CiAgICAgICAgfQogICAgICAgIGlmIChkb1dhcnApIHRocmVhZC5wZWVrU3RhY2tGcmFtZSgpLndhcnBNb2RlID0gdHJ1ZTsKICAgICAgICBlbHNlIGlmIChpc1JlY3Vyc2l2ZSkgdGhyZWFkLnN0YXR1cyA9IFRocmVhZC5TVEFUVVNfWUlFTEQ7CiAgICAgIH0KICAgIH0KICB9CgogIC8vIEludGVybmFscwogIC8vIFJlbW92ZSB1bnVzZWQgcHJvY2VkdXJlcyBiZWZvcmUgc2F2aW5nCiAgZnVuY3Rpb24gcmVtb3ZlVW51c2VkUHJvY3MoKSB7CiAgICBpZiAoc3VzcGVuZFJlbW92YWwpIHJldHVybjsKICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHJ1bnRpbWUudGFyZ2V0cykgewogICAgICBmb3IgKGNvbnN0IHByb2Njb2RlIG9mIE9iamVjdC5rZXlzKHN0b3JhZ2VbdGFyZ2V0LmlkXSB8fCB7fSkpIHsKICAgICAgICBpZiAoIXRhcmdldC5ibG9ja3MuZ2V0UHJvY2VkdXJlRGVmaW5pdGlvbihwcm9jY29kZSkpIGRlbGV0ZSBzdG9yYWdlW3RhcmdldC5pZF1bcHJvY2NvZGVdOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZW1vdmUgdW51c2VkIGltYWdlcyBiZWZvcmUgc2F2aW5nCiAgZnVuY3Rpb24gcmVtb3ZlVW51c2VkSW1hZ2VzKCkgewogICAgaWYgKHN1c3BlbmRSZW1vdmFsKSByZXR1cm47CiAgICBjb25zdCB1c2VkSWRzID0gbmV3IFNldCgpOwogICAgT2JqZWN0LnZhbHVlcyhzdG9yYWdlKS5mb3JFYWNoKHByb2MgPT4gT2JqZWN0LnZhbHVlcyhwcm9jID8/IHt9KS5mb3JFYWNoKGRhdGEgPT4gewogICAgICBpZiAoIWRhdGEuaW5wdXRzKSByZXR1cm47CiAgICAgIE9iamVjdC52YWx1ZXMoZGF0YS5pbnB1dHMpLmZvckVhY2goaW5wdXQgPT4gewogICAgICAgIGlmIChpbnB1dC50eXBlID09PSAiaW1nIikgdXNlZElkcy5hZGQoaW5wdXQuc3JjKTsKICAgICAgfSk7CiAgICB9KSk7CgogICAgZm9yIChsZXQgaSA9IDE7IGkgPCBpbWdTdG9yZVNpemU7IGkrKykgewogICAgICBpZiAoIXVzZWRJZHMuaGFzKGkpKSBkZWxldGUgaW1nU3RvcmFnZVtpXTsKICAgIH0KICB9CgogIC8vIHJlc2V0IHRoZSBjb21waWxlZCBjb2RlIGNhY2hlIGZvciBnbG9iYWwgYmxvY2tzIHRoYXQgZ2V0IGNoYW5nZWQKICBsZXQgY2FjaGVQYXRjaGVkID0gZmFsc2U7CiAgZnVuY3Rpb24gcGF0Y2hDYWNoZSgpIHsKICAgIGNhY2hlUGF0Y2hlZCA9IHRydWU7CiAgICBjb25zdCBvZ1Jlc2V0Q2FjaGUgPSB2bS5ydW50aW1lLnRhcmdldHNbMF0uYmxvY2tzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5yZXNldENhY2hlOwogICAgdm0ucnVudGltZS50YXJnZXRzWzBdLmJsb2Nrcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUucmVzZXRDYWNoZSA9IGZ1bmN0aW9uKGlnbm9yZUdsb2JhbCkgewogICAgICBpZiAoaWdub3JlR2xvYmFsKSB7CiAgICAgICAgb2dSZXNldENhY2hlLmNhbGwodGhpcyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCBnbG9iYWxQcm9jcyA9IE9iamVjdC5rZXlzKGdsb2JhbEJsb2Nrc0NhY2hlKTsKICAgICAgY29uc3QgY29tcGlsZWRQcm9jcyA9IE9iamVjdC5rZXlzKHRoaXMuX2NhY2hlLmNvbXBpbGVkUHJvY2VkdXJlcykKICAgICAgICAubWFwKChwKSA9PiBwLnN1YnN0cmluZygxLCBwLmxlbmd0aCkpOwoKICAgICAgaWYgKGdsb2JhbFByb2NzLnNvbWUocCA9PiBjb21waWxlZFByb2NzLmluY2x1ZGVzKHApKSkgewogICAgICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHJ1bnRpbWUudGFyZ2V0cykgdGFyZ2V0LmJsb2Nrcy5yZXNldENhY2hlKHRydWUpOwogICAgICB9IGVsc2UgewogICAgICAgIG9nUmVzZXRDYWNoZS5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBJcy1pbi1FZGl0b3IgQ2hlY2tlcgogIGxldCBzdGFydGVkRWRpdG9yV29ya2VyID0gZmFsc2U7CiAgZnVuY3Rpb24gc3RhcnRFZGl0b3JMaXN0ZW5lcigpIHsKICAgIHJlZnJlc2hHbG9iYWxCbG9ja3NDYWNoZSgpOwogICAgaWYgKHN0YXJ0ZWRFZGl0b3JXb3JrZXIpIHJldHVybjsKICAgIHN0YXJ0ZWRFZGl0b3JXb3JrZXIgPSBmYWxzZTsKICAgIGlmIChTY3JhdGNoLmd1aSkgU2NyYXRjaC5ndWkuZ2V0QmxvY2tseSgpLnRoZW4oU0IgPT4gewogICAgICBjb25zdCB3b3Jrc3BhY2UgPSBTQi5tYWluV29ya3NwYWNlOwogICAgICBpZiAoIWlzUE0pIHdvcmtzcGFjZS5lbmFibGVQcm9jZWR1cmVSZXR1cm5zKCk7CiAgICAgIHZtLm9uKCJ3b3Jrc3BhY2VVcGRhdGUiLCAoKSA9PiB7CiAgICAgICAgaWYgKCFleHRlbnNpb25SZW1vdmFibGUpIHsKICAgICAgICAgIGxpc3ROZWVkc1JlZnJlc2ggPSB0cnVlOwogICAgICAgICAgaWYgKHdvcmtzcGFjZT8ucmVuZGVyZWQpIFNCLlByb2NlZHVyZXMuZmx5b3V0Q2F0ZWdvcnkod29ya3NwYWNlKTsKICAgICAgICAgIGlmICghY2FjaGVQYXRjaGVkKSBwYXRjaENhY2hlKCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLy8gQmxvY2sgRXZlbnRzIEhhbmRsZXIKICBmdW5jdGlvbiBpbml0QmxvY2tFdmVudHMoKSB7CiAgICBpZiAoU2NyYXRjaC5ndWkpIFNjcmF0Y2guZ3VpLmdldEJsb2NrbHkoKS50aGVuKFNCID0+IHsKICAgICAgY29uc3QgeyBFdmVudHMsIG1haW5Xb3Jrc3BhY2UgfSA9IFNCOwogICAgICBpZiAoIW1haW5Xb3Jrc3BhY2U/LnJlbmRlcmVkKSByZXR1cm47CiAgICAgIGxldCBwYXRjaGVkID0gZmFsc2U7CiAgICAgIGNvbnN0IHdvcmtzcGFjZUV2ZW50cyA9IChlKSA9PiB7CiAgICAgICAgaWYgKG1haW5Xb3Jrc3BhY2UuaWQgPT09IGUud29ya3NwYWNlSWQpIHsKICAgICAgICAgIGlmICghaXNQTSAmJiAhcGF0Y2hlZCkgewogICAgICAgICAgICBjb25zdCBvZ1JldHVybnNXaWxsQ2hhbmdlID0gbWFpbldvcmtzcGFjZS5wcm9jZWR1cmVSZXR1cm5zV2lsbENoYW5nZTsKICAgICAgICAgICAgbWFpbldvcmtzcGFjZS5wcm9jZWR1cmVSZXR1cm5zV2lsbENoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIG9nUmV0dXJuc1dpbGxDaGFuZ2UuY2FsbCh0aGlzKTsKICAgICAgICAgICAgICBsaXN0TmVlZHNSZWZyZXNoID0gdHJ1ZTsKICAgICAgICAgICAgICBwYXRjaGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSBFdmVudHMuQ0hBTkdFOiB7CiAgICAgICAgICAgICAgbGV0IGJsb2NrID0gbWFpbldvcmtzcGFjZS5nZXRCbG9ja0J5SWQoZS5ibG9ja0lkKTsKICAgICAgICAgICAgICB3aGlsZSAoYmxvY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChibG9jayAmJiBibG9jay50eXBlID09PSAicHJvY2VkdXJlc19kZWZpbml0aW9uIikgewogICAgICAgICAgICAgICAgICBjb25zdCBwcm90byA9IGJsb2NrLmdldElucHV0KCJjdXN0b21fYmxvY2siKT8uY29ubmVjdGlvbj8udGFyZ2V0QmxvY2soKTsKICAgICAgICAgICAgICAgICAgaWYgKCFwcm90bykgcmV0dXJuOwogICAgICAgICAgICAgICAgICBjb25zdCBzdG9yZSA9IHN0b3JlR2V0KHByb3RvLnByb2NDb2RlXyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBibG9jayA9IGJsb2NrLmdldFBhcmVudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEV2ZW50cy5NT1ZFOiB7CiAgICAgICAgICAgICAgbGV0IGJsb2NrID0gbWFpbldvcmtzcGFjZS5nZXRCbG9ja0J5SWQoZS5ibG9ja0lkKSwgcGFyZW50ID0gbWFpbldvcmtzcGFjZS5nZXRCbG9ja0J5SWQoZS5uZXdQYXJlbnRJZCk7CgogICAgICAgICAgICAgIC8vIGZpeCBmaWVsZCBjb2xvdXJzCiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgZS5uZXdJbnB1dE5hbWUgJiYgYmxvY2s/LmNhdGVnb3J5XyA9PT0gbnVsbCAmJgogICAgICAgICAgICAgICAgYmxvY2suaW5wdXRMaXN0WzBdLmZpZWxkUm93WzBdPy5hcnJvd18gIT09IHVuZGVmaW5lZCAmJgogICAgICAgICAgICAgICAgcGFyZW50Py50eXBlID09PSAicHJvY2VkdXJlc19jYWxsIgogICAgICAgICAgICAgICkgYmxvY2suc2V0Q29sb3VyKHBhcmVudC5jb2xvdXJfKTsKCiAgICAgICAgICAgICAgLy8gdXBkYXRlIGdsb2JhbCBibG9jayBjYWNoZSBmb3IgcmV0dXJucwogICAgICAgICAgICAgIGlmICghaXNQTSkgewogICAgICAgICAgICAgICAgaWYgKHBhcmVudD8udHlwZSA9PT0gInByb2NlZHVyZXNfcmV0dXJuIikgewogICAgICAgICAgICAgICAgICBibG9jayA9IHBhcmVudDsKICAgICAgICAgICAgICAgICAgcGFyZW50ID0gYmxvY2suZ2V0UGFyZW50KCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uc3QgY2hhbmdlR2xvYmFsUmV0dXJuID0gKHBhcmVudCwgcmV0dXJucykgPT4gewogICAgICAgICAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudCAmJiBwYXJlbnQudHlwZSA9PT0gInByb2NlZHVyZXNfZGVmaW5pdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByb3RvID0gcGFyZW50LmdldElucHV0KCJjdXN0b21fYmxvY2siKT8uY29ubmVjdGlvbj8udGFyZ2V0QmxvY2soKTsKICAgICAgICAgICAgICAgICAgICAgIGlmICghcHJvdG8pIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0b3JlID0gc3RvcmVHZXQocHJvdG8ucHJvY0NvZGVfKTsKICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9jaz8udHlwZSA9PT0gInByb2NlZHVyZXNfcmV0dXJuIikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB2bVByb3RvID0gdm0uZWRpdGluZ1RhcmdldC5ibG9ja3MuZ2V0QmxvY2socHJvdG8uaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0dXJucykgdm1Qcm90by5tdXRhdGlvbi5yZXR1cm4gPSBTQi5Qcm9jZWR1cmVzLmdldEJsb2NrUmV0dXJuVHlwZShwYXJlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHZtUHJvdG8ubXV0YXRpb24ucmV0dXJuID0gMDsKCiAgICAgICAgICAgICAgICAgICAgICAgIGxpc3ROZWVkc1JlZnJlc2ggPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RvcmUuZ2xvYmFsKSBzdG9yZS5yZXR1cm4gPSB2bVByb3RvLm11dGF0aW9uLnJldHVybjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LmdldFBhcmVudCgpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGNoYW5nZUdsb2JhbFJldHVybihwYXJlbnQsIHRydWUpOyAvLyBoYW5kbGUgbmV3IGRlZmluaXRpb24KICAgICAgICAgICAgICAgIGlmIChlLm9sZFBhcmVudElkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkUGFyZW50ID0gbWFpbldvcmtzcGFjZS5nZXRCbG9ja0J5SWQoZS5vbGRQYXJlbnRJZCk7CiAgICAgICAgICAgICAgICAgIGNoYW5nZUdsb2JhbFJldHVybihvbGRQYXJlbnQsIGZhbHNlKTsgLy8gaGFuZGxlIG9sZCBkZWZpbml0aW9uCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICBtYWluV29ya3NwYWNlLmFkZENoYW5nZUxpc3RlbmVyKHdvcmtzcGFjZUV2ZW50cyk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gc3RhcnRCbG9ja0xpc3RlbmVyKCkgewogICAgcnVudGltZS5vbigiQkxPQ0tfRFJBR19FTkQiLCAobmV3U3RhY2ssIG9sZElEKSA9PiB7CiAgICAgIC8vIGFwcGVuZCBvbGQgZGF0YSB0byBuZXcgYmxvY2tzCiAgICAgIGlmIChuZXdTdGFja1swXS5vcGNvZGUgIT09ICJwcm9jZWR1cmVzX2RlZmluaXRpb24iKSByZXR1cm47CiAgICAgIGNvbnN0IHByb2Njb2RlID0gbmV3U3RhY2tbMV0ubXV0YXRpb24ucHJvY2NvZGU7CiAgICAgIGNvbnN0IHRoaXNUYXJnZXQgPSB2bS5lZGl0aW5nVGFyZ2V0OwogICAgICBjb25zdCBjb3B5U3RvcmUgPSBzdG9yZUdldChwcm9jY29kZSwgdGhpc1RhcmdldCk7CiAgICAgIGlmIChjb3B5U3RvcmUpIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIC8vIHRpbWVvdXQgd29ya3MgYmV0dGVyIHRoYW4gcXVldWVNaWNyb3Rhc2sgZm9yIHRoaXM/CiAgICAgICAgZm9yIChjb25zdCB0YXJnZXQgb2YgcnVudGltZS50YXJnZXRzKSB7CiAgICAgICAgICBpZiAoIXRhcmdldC5pc09yaWdpbmFsIHx8IHRhcmdldC5pZCA9PT0gdGhpc1RhcmdldC5pZCkgY29udGludWU7CiAgICAgICAgICBjb25zdCBkZWYgPSB0YXJnZXQuYmxvY2tzLmdldFByb2NlZHVyZURlZmluaXRpb24ocHJvY2NvZGUpOwogICAgICAgICAgaWYgKGRlZikgc3RvcmVTZXQocHJvY2NvZGUsIHN0cnVjdHVyZWRDbG9uZShjb3B5U3RvcmUpLCB0YXJnZXQpOwogICAgICAgIH0KICAgICAgfSwgMTApOwogICAgfSk7CgogICAgY29uc3QgY2hlY2tJbkVkaXRvciA9ICgpID0+ICFSZWR1eFN0b3JlLmdldFN0YXRlKCkuc2NyYXRjaEd1aS5tb2RlLmlzUGxheWVyT25seTsKICAgIGxldCBpbkVkaXRvciA9IGNoZWNrSW5FZGl0b3IoKTsKICAgIGlmIChpbkVkaXRvcikgaW5pdEJsb2NrRXZlbnRzKCk7CiAgICBSZWR1eFN0b3JlLnN1YnNjcmliZSgoKSA9PiB7CiAgICAgIGNvbnN0IGN1cnJlbnRJbkVkaXRvciA9IGNoZWNrSW5FZGl0b3IoKTsKICAgICAgaWYgKGluRWRpdG9yICE9PSBjdXJyZW50SW5FZGl0b3IpIHsKICAgICAgICBpbkVkaXRvciA9IGN1cnJlbnRJbkVkaXRvcjsKICAgICAgICBpZiAoaW5FZGl0b3IpIGluaXRCbG9ja0V2ZW50cygpOwogICAgICB9CiAgICB9KTsKICB9CiAgaWYgKHR5cGVvZiBzY2FmZm9sZGluZyA9PT0gInVuZGVmaW5lZCIpIHN0YXJ0QmxvY2tMaXN0ZW5lcigpOwoKICAvLyBDdXN0b20gQmxvY2tzIEludGVybmFscwogIGZ1bmN0aW9uIHN0b3JlR2V0KG5hbWUsIHRhcmdldCA9IG51bGwpIHsKICAgIC8vIGZpcnN0IGNoZWNrIGlmIGl0cyBhIGdsb2JhbCBibG9jayBwcm9jY29kZQogICAgY29uc3QgZ2xvYmFsU3RvcmUgPSBnbG9iYWxCbG9ja3NDYWNoZVtuYW1lXTsKICAgIGlmIChnbG9iYWxTdG9yZSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gc3RvcmFnZVtnbG9iYWxTdG9yZS5pZF0/LltuYW1lXSA/PyB7fTsKCiAgICBjb25zdCBpZCA9ICh0YXJnZXQgfHwgdm0uZWRpdGluZ1RhcmdldCk/LmlkOwogICAgcmV0dXJuIHN0b3JhZ2VbaWRdPy5bbmFtZV0gPz8ge307CiAgfQogIGZ1bmN0aW9uIHN0b3JlRGVsKG5hbWUsIHRhcmdldCA9IG51bGwpIHsKICAgIGNvbnN0IGlkID0gKHRhcmdldCB8fCB2bS5lZGl0aW5nVGFyZ2V0KS5pZDsKICAgIGRlbGV0ZSBzdG9yYWdlW2lkXVtuYW1lXTsKICB9CiAgZnVuY3Rpb24gc3RvcmVTZXQobmFtZSwgdmFsdWUsIHRhcmdldCA9IG51bGwpIHsKICAgIGNvbnN0IGlkID0gKHRhcmdldCB8fCB2bS5lZGl0aW5nVGFyZ2V0KS5pZDsKICAgIGlmICghc3RvcmFnZVtpZF0pIHN0b3JhZ2VbaWRdID0ge307CiAgICBzdG9yYWdlW2lkXVtuYW1lXSA9IHZhbHVlOwogICAgcnVudGltZS5TUG1icENTVE9sZFN0b3JhZ2UgPSBzdG9yYWdlOwogIH0KCiAgZnVuY3Rpb24gc3RvcmVJbWFnZSh1cmwpIHsKICAgIGNvbnN0IHVybEV4aXN0cyA9IE9iamVjdC52YWx1ZXMoaW1nU3RvcmFnZSkuaW5kZXhPZih1cmwpOwogICAgaWYgKHVybEV4aXN0cyA+IC0xKSByZXR1cm4gdXJsRXhpc3RzICsgMTsKCiAgICBpbWdTdG9yZVNpemUrKzsKICAgIGltZ1N0b3JhZ2VbaW1nU3RvcmVTaXplXSA9IHVybDsKICAgIHJldHVybiBpbWdTdG9yZVNpemU7CiAgfQogIGZ1bmN0aW9uIGdldFN0b3JlZEltYWdlKGluZGV4KSB7CiAgICByZXR1cm4gaW1nU3RvcmFnZVtpbmRleF0gPz8gIiI7CiAgfQoKICBmdW5jdGlvbiBkZXNlcmlhbGl6ZVN0b3JhZ2UoZGF0YSkgewogICAgaWYgKGlzUE0pIHsKICAgICAgc3RvcmFnZSA9IGRhdGEuU1BtYnBDU1QgfHwge307CiAgICAgIGltZ1N0b3JhZ2UgPSBkYXRhLlNQbWJwQ1NUPy5pbWdTdG9yYWdlID8/IHt9OwogICAgICBpbWdTdG9yZVNpemUgPSBPYmplY3Qua2V5cyhpbWdTdG9yYWdlKS5sZW5ndGg7CiAgICAgIHN0YXJ0RWRpdG9yTGlzdGVuZXIoKTsKICAgICAgaWYgKFNjcmF0Y2guZ3VpKSBTY3JhdGNoLmd1aS5nZXRCbG9ja2x5KCkudGhlbihTQiA9PiB7CiAgICAgICAgcnVudGltZS5vbmNlKCJQUk9KRUNUX0xPQURFRCIsICgpID0+IHsKICAgICAgICAgIGlmIChTQi5tYWluV29ya3NwYWNlLnJlbmRlcmVkKSBTQi5Qcm9jZWR1cmVzLmZseW91dENhdGVnb3J5KFNCLm1haW5Xb3Jrc3BhY2UpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHN1c3BlbmRSZW1vdmFsID0gdHJ1ZTsKCiAgICAgIGltZ1N0b3JhZ2UgPSBydW50aW1lLmV4dGVuc2lvblN0b3JhZ2VbIlNQbWJwQ1NUIl0uaW1nU3RvcmFnZSA/PyB7fTsKICAgICAgaW1nU3RvcmVTaXplID0gT2JqZWN0LmtleXMoaW1nU3RvcmFnZSkubGVuZ3RoOwogICAgICBzdG9yYWdlID0ge307IC8vIHRhcmdldCBJRCdzIGNoYW5nZSB3aGVuIHNhdmluZyA6KAogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJ1bnRpbWUudGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHRhcmdldCA9IHJ1bnRpbWUudGFyZ2V0c1tpXTsKICAgICAgICBjb25zdCBzdG9yZSA9IHRhcmdldC5leHRlbnNpb25TdG9yYWdlPy5TUG1icENTVDsKICAgICAgICBpZiAoc3RvcmUgIT09IHVuZGVmaW5lZCkgc3RvcmFnZVt0YXJnZXQuaWRdID0geyAuLi5zdG9yZSB9OwogICAgICB9CiAgICAgIGNvbnN0IHRlbXBTdG9yZSA9IHN0cnVjdHVyZWRDbG9uZShzdG9yYWdlKTsKICAgICAgcnVudGltZS5TUG1icENTVE9sZFN0b3JhZ2UgPSB0ZW1wU3RvcmU7CiAgICAgIHN0YXJ0RWRpdG9yTGlzdGVuZXIoKTsKICAgICAgdm0ub25jZSgid29ya3NwYWNlVXBkYXRlIiwgKCkgPT4geyBzdG9yYWdlID0gdGVtcFN0b3JlIH0pOwogICAgICB2bS5lbWl0V29ya3NwYWNlVXBkYXRlKCk7CiAgICAgIGlmIChTY3JhdGNoLmd1aSkgU2NyYXRjaC5ndWkuZ2V0QmxvY2tseSgpLnRoZW4oU0IgPT4gewogICAgICAgIFNCLlByb2NlZHVyZXMuZmx5b3V0Q2F0ZWdvcnkoU0IubWFpbldvcmtzcGFjZSk7CiAgICAgIH0pOwogICAgfQogIH0KICAvLyB1c2UgZXhpc3Rpbmcgc3RvcmFnZSB3aGVuIGxvYWRlZCB0d2ljZQogIHN0b3JhZ2UgPSBydW50aW1lLlNQbWJwQ1NUT2xkU3RvcmFnZSB8fCB7fTsKICBpZiAoIWlzUE0pIHJ1bnRpbWUub25jZSgiUFJPSkVDVF9MT0FERUQiLCAoKSA9PiBkZXNlcmlhbGl6ZVN0b3JhZ2UoKSk7CgogIGZ1bmN0aW9uIHJlZnJlc2hHbG9iYWxCbG9ja3NDYWNoZSgpIHsKICAgIGdsb2JhbEJsb2Nrc0NhY2hlID0ge307CiAgICB2bS5nbG9iYWxCbG9ja3NDYWNoZSA9IGdsb2JhbEJsb2Nrc0NhY2hlOwogICAgZm9yIChjb25zdCB0YXJnZXRJZCBvZiBPYmplY3Qua2V5cyhzdG9yYWdlKSkgewogICAgICBjb25zdCB0YXJnZXQgPSBydW50aW1lLmdldFRhcmdldEJ5SWQodGFyZ2V0SWQpOwogICAgICBpZiAoIXRhcmdldCkgY29udGludWU7CiAgICAgIGZvciAoY29uc3QgcHJvY2NvZGUgb2YgT2JqZWN0LmtleXMoc3RvcmFnZVt0YXJnZXRJZF0gPz8ge30pKSB7CiAgICAgICAgaWYgKHN0b3JhZ2VbdGFyZ2V0SWRdW3Byb2Njb2RlXT8uZ2xvYmFsKSBnbG9iYWxCbG9ja3NDYWNoZVtwcm9jY29kZV0gPSB0YXJnZXQ7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldEJsb2NrUHJvdG90eXBlKHRhcmdldCwgcHJvY2NvZGUpIHsKICAgIGZvciAoY29uc3QgaWQgaW4gdGFyZ2V0LmJsb2Nrcy5fYmxvY2tzKSB7CiAgICAgIGlmICghT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRhcmdldC5ibG9ja3MuX2Jsb2NrcywgaWQpKSBjb250aW51ZTsKICAgICAgY29uc3QgYmxvY2sgPSB0YXJnZXQuYmxvY2tzLl9ibG9ja3NbaWRdOwogICAgICBpZiAoYmxvY2sub3Bjb2RlID09PSAicHJvY2VkdXJlc19wcm90b3R5cGUiICYmIGJsb2NrLm11dGF0aW9uICYmIGJsb2NrLm11dGF0aW9uLnByb2Njb2RlID09PSBwcm9jY29kZSkgewogICAgICAgIHJldHVybiBibG9jazsKICAgICAgfQogICAgfQogICAgcmV0dXJuOwogIH0KCiAgZnVuY3Rpb24gY29tcGlsZVByb2NlZHVyZXMoeG1sTGlzdCwgd29ya3NwYWNlLCB1dGlscykgewogICAgaWYgKCFsaXN0TmVlZHNSZWZyZXNoKSByZXR1cm47CiAgICBjb25zdCByZXR1cm5hYmxlcyA9IGlzUE0gPyB7fSA6IHV0aWxzLmdldEFsbFByb2NlZHVyZVJldHVyblR5cGVzKHdvcmtzcGFjZSk7CiAgICByZWZyZXNoR2xvYmFsQmxvY2tzQ2FjaGUoKTsKCiAgICAvLyBnZXQgcHJpdmF0ZSBwcm9jZWR1cmVzCiAgICBwcm9jZWR1cmVzWE1MID0gIiI7CiAgICBjb25zdCBnbG9iYWxQcm9jcyA9IG5ldyBTZXQoT2JqZWN0LmtleXMoZ2xvYmFsQmxvY2tzQ2FjaGUpKTsKICAgIGNvbnN0IHRlbXBDYWNoZSA9IHt9OwogICAgb2xkTGlzdExlbmd0aCA9IHhtbExpc3QubGVuZ3RoOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvbGRMaXN0TGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3QgcHJvYyA9IHhtbExpc3RbaV07CiAgICAgIGlmIChwcm9jLmdldEF0dHJpYnV0ZSgidHlwZSIpID09PSAicHJvY2VkdXJlc19jYWxsIikgewogICAgICAgIGNvbnN0IHByb2Njb2RlID0gcHJvYy5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgicHJvY2NvZGUiKTsKICAgICAgICBpZiAoZ2xvYmFsUHJvY3MuaGFzKHByb2Njb2RlKSkgdGVtcENhY2hlW3Byb2Njb2RlXSA9IHByb2Mub3V0ZXJIVE1MOwogICAgICAgIGVsc2UgcHJvY2VkdXJlc1hNTCArPSBwcm9jLm91dGVySFRNTDsKICAgICAgfQogICAgfQoKICAgIGlmIChnbG9iYWxQcm9jcy5zaXplID4gMCkgewogICAgICBsZXQgdGVtcExpc3QgPSBgPHNlcCBnYXA9IjEyIi8+PGxhYmVsIHRleHQ9Ikdsb2JhbCBCbG9ja3MiLz48c2VwIGdhcD0iNiIvPmA7CiAgICAgIGZvciAoY29uc3QgcHJvY2NvZGUgb2YgZ2xvYmFsUHJvY3MpIHsKICAgICAgICBjb25zdCB0YXJnZXQgPSBnbG9iYWxCbG9ja3NDYWNoZVtwcm9jY29kZV07CiAgICAgICAgaWYgKHRhcmdldC5pZCA9PT0gdm0uZWRpdGluZ1RhcmdldD8uaWQpIHsKICAgICAgICAgIHRlbXBMaXN0ICs9IHRlbXBDYWNoZVtwcm9jY29kZV07CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHByb3RvID0gZ2V0QmxvY2tQcm90b3R5cGUodGFyZ2V0LCBwcm9jY29kZSk7CiAgICAgICAgaWYgKHByb3RvKSB7CiAgICAgICAgICBpZiAocHJvdG8ubXV0YXRpb24ucmV0dXJuID09PSB1bmRlZmluZWQpIHByb3RvLm11dGF0aW9uLnJldHVybiA9IHN0b3JlR2V0KHByb2Njb2RlKS5yZXR1cm47CiAgICAgICAgICBjb25zdCBuZXdNdXRhdGlvbiA9IHsuLi5wcm90by5tdXRhdGlvbn07CiAgICAgICAgICBuZXdNdXRhdGlvbi5nZW5lcmF0ZXNoYWRvd3MgPSB0cnVlOwogICAgICAgICAgdGVtcExpc3QgKz0gYDxibG9jayB0eXBlPSJwcm9jZWR1cmVzX2NhbGwiIGdhcD0iMTIiPiR7dGFyZ2V0LmJsb2Nrcy5tdXRhdGlvblRvWE1MKG5ld011dGF0aW9uKX08L2Jsb2NrPmA7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRlbXBMaXN0ICs9IGA8c2VwIGdhcD0iNiIvPjxsYWJlbCB0ZXh0PSJQcml2YXRlIEJsb2NrcyIvPjxzZXAgZ2FwPSI2Ii8+YDsKICAgICAgcHJvY2VkdXJlc1hNTCA9IHRlbXBMaXN0ICsgcHJvY2VkdXJlc1hNTDsKICAgIH0KICAgIHZtLmV4dGVuc2lvbk1hbmFnZXIucmVmcmVzaEJsb2NrcygiU1BtYnBDU1QiKTsKICAgIGxpc3ROZWVkc1JlZnJlc2ggPSBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZUV4dGVuc2lvbigpIHsKICAgIGV4dGVuc2lvblJlbW92YWJsZSA9IHRydWU7CiAgICBzaG91bGRTY3JvbGxUb01CUCA9IGZhbHNlOyAvLyBqdXN0IGluIGNhc2UKICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHJ1bnRpbWUudGFyZ2V0cykgewogICAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIE9iamVjdC52YWx1ZXModGFyZ2V0LmJsb2Nrcy5fYmxvY2tzKSkgewogICAgICAgIGlmIChibG9jay5vcGNvZGUuc3RhcnRzV2l0aCgiU1BtYnBDU1RfIikpIGRlbGV0ZUJsb2NrKHRhcmdldCwgYmxvY2suaWQpOwogICAgICB9CiAgICB9CiAgICBmb3IgKGNvbnN0IGtleSBpbiBzdG9yYWdlKSBkZWxldGUgc3RvcmFnZVtrZXldOwogICAgZm9yIChjb25zdCBrZXkgaW4gdGVtcFN0b3JlKSBkZWxldGUgdGVtcFN0b3JlW2tleV07CiAgICBydW50aW1lLlNQbWJwQ1NUT2xkU3RvcmFnZSA9IHN0b3JhZ2U7CiAgICB2bS5yZWZyZXNoV29ya3NwYWNlKCk7CiAgICBhbGVydCgiU2F2ZSBhbmQgcmVsb2FkIHRoZSBwcm9qZWN0IGZvciB0aGUgZXh0ZW5zaW9uIHRvIGZ1bGx5IGJlIHJlbW92ZWQuIik7CiAgfQoKICBmdW5jdGlvbiBkZWxldGVCbG9jayh0YXJnZXQsIGJsb2NrSWQpIHsKICAgIGlmICh0YXJnZXQgPT09IHZtLmVkaXRpbmdUYXJnZXQgJiYgU2NyYXRjaC5ndWkpIHsKICAgICAgU2NyYXRjaC5ndWkuZ2V0QmxvY2tseSgpLnRoZW4oU0IgPT4gewogICAgICAgIFNCLmdldE1haW5Xb3Jrc3BhY2UoKS5nZXRCbG9ja0J5SWQoYmxvY2tJZCk/LmRpc3Bvc2UodHJ1ZSwgZmFsc2UpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldC5ibG9ja3MuZGVsZXRlQmxvY2soYmxvY2tJZCk7CiAgICB9CiAgfQoKICBjb25zdCBvZ0R1cFNwcml0ZSA9IHZtLmR1cGxpY2F0ZVNwcml0ZTsKICB2bS5kdXBsaWNhdGVTcHJpdGUgPSBmdW5jdGlvbih0YXJnZXRJZCkgewogICAgcmV0dXJuIG9nRHVwU3ByaXRlLmNhbGwodGhpcywgdGFyZ2V0SWQpLnRoZW4oKCkgPT4gewogICAgICBjb25zdCBuZXdUYXJnZXQgPSB0aGlzLnJ1bnRpbWUudGFyZ2V0c1t0aGlzLnJ1bnRpbWUudGFyZ2V0cy5sZW5ndGggLSAxXTsKICAgICAgaWYgKCFzdG9yYWdlW25ld1RhcmdldC5pZF0pIHsKICAgICAgICBzdG9yYWdlW25ld1RhcmdldC5pZF0gPSBzdHJ1Y3R1cmVkQ2xvbmUoc3RvcmFnZVt0YXJnZXRJZF0pOwogICAgICAgIHRoaXMuZW1pdFdvcmtzcGFjZVVwZGF0ZSgpOwogICAgICB9CiAgICAgIHJldHVybiBuZXdUYXJnZXQ7CiAgICB9KTsKICB9CgogIC8qIEJhY2twYWNrIFN1cHBvcnQgKEJMT0NLUykgKi8KICBjb25zdCBoYW5kbGVDdXN0b21JbnB1dEV4cG9ydHMgPSAoaW5wdXRzKSA9PiB7CiAgICAvLyBUT0RPIGV4cG9ydCBpbWFnZXMgdG9vCiAgICBpZiAoIXJ1bnRpbWUuZXh0ZW5zaW9uTWFuYWdlci5pc0V4dGVuc2lvbkxvYWRlZCgiU1Awek1lbnVNYWtlciIpKSByZXR1cm47CgogICAgY29uc3QgbWVudU1ha2VyID0gcnVudGltZS5leHRfU1Awek1lbnVNYWtlcjsKICAgIGNvbnN0IGFsbE1lbnVzID0gbWVudU1ha2VyLmdldE1lbnVzKCk7CiAgICBjb25zdCB2YWx1ZXMgPSBPYmplY3QudmFsdWVzKGlucHV0cyk7CgogICAgbGV0IG91dHB1dCA9IHsgbWVudXM6IHt9IH07CiAgICBmb3IgKGNvbnN0IGlucHV0IG9mIHZhbHVlcykgewogICAgICAvKiBjdXN0b20gbWVudSBzdXBwb3J0ICovCiAgICAgIGlmIChpbnB1dC5pc0Ryb3AgJiYgaW5wdXQudHlwZS5zdGFydHNXaXRoKENVU1RPTV9NRU5VX0lEKSkgewogICAgICAgIGNvbnN0IG5hbWUgPSBpbnB1dC50eXBlLnN1YnN0cmluZyhDVVNUT01fTUVOVV9JRC5sZW5ndGgsIGlucHV0LnR5cGUubGVuZ3RoKTsKICAgICAgICBvdXRwdXQubWVudXNbbmFtZV0gPSBhbGxNZW51c1tuYW1lXS5pdGVtczsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXRwdXQ7CiAgfTsKICBjb25zdCBvZ0V4cG9ydEJsb2NrcyA9IHZtLmV4cG9ydFN0YW5kYWxvbmVCbG9ja3M7CiAgdm0uZXhwb3J0U3RhbmRhbG9uZUJsb2NrcyA9IGZ1bmN0aW9uKGJsb2NrT2JqZWN0cykgewogICAgY29uc3QgZXhwb3J0ZWQgPSBvZ0V4cG9ydEJsb2Nrcy5jYWxsKHRoaXMsIGJsb2NrT2JqZWN0cyk7CiAgICBsZXQgc3RhY2s7CgogICAgLy8gYXBwZW5kIGN1c3RvbSBibG9jayBkYXRhIGZvciBpbXBvcnRpbmcgaWYgdGhlcmVzIGEgZGVmaW5pdGlvbgogICAgaWYgKGV4cG9ydGVkLmNvbnN0cnVjdG9yPy5uYW1lID09PSAiT2JqZWN0Iikgc3RhY2sgPSBleHBvcnRlZC5ibG9ja3M7CiAgICBlbHNlIHN0YWNrID0gZXhwb3J0ZWQ7CiAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIHN0YWNrKSB7CiAgICAgIGlmIChibG9jay5vcGNvZGUgIT09ICJwcm9jZWR1cmVzX3Byb3RvdHlwZSIpIGNvbnRpbnVlOwogICAgICBjb25zdCBzdG9yZSA9IHN0b3JlR2V0KGJsb2NrLm11dGF0aW9uLnByb2Njb2RlKTsKICAgICAgaWYgKCFzdG9yZSkgY29udGludWU7CiAgICAgIGJsb2NrLk15QmxvY2tzUGx1c0RhdGEgPSBzdG9yZTsKICAgICAgYmxvY2suTXlCbG9ja3NQbHVzRXh0ZXJuYWxzID0gaGFuZGxlQ3VzdG9tSW5wdXRFeHBvcnRzKHN0b3JlLmlucHV0cyk7CiAgICB9CiAgICByZXR1cm4gZXhwb3J0ZWQ7CiAgfQoKICBjb25zdCBoYW5kbGVDdXN0b21JbnB1dEltcG9ydHMgPSAoZXh0ZXJuYWxzKSA9PiB7CiAgICBpZiAoIXJ1bnRpbWUuZXh0ZW5zaW9uTWFuYWdlci5pc0V4dGVuc2lvbkxvYWRlZCgiU1Awek1lbnVNYWtlciIpKSByZXR1cm47CgogICAgY29uc3QgbWVudU1ha2VyID0gcnVudGltZS5leHRfU1Awek1lbnVNYWtlcjsKICAgIGNvbnN0IG1lbnVzID0gT2JqZWN0LmVudHJpZXMoZXh0ZXJuYWxzLm1lbnVzKTsKICAgIGZvciAoY29uc3QgW25hbWUsIGl0ZW1zXSBvZiBtZW51cykgewogICAgICBtZW51TWFrZXIuc2V0TWVudXMobmFtZSwgaXRlbXMpOwogICAgfQoKICAgIG1lbnVNYWtlci5yZWZyZXNoQ2F0ZWdvcnkoKTsKICB9OwogIGNvbnN0IG9nU2hhcmVCbG9ja3MgPSB2bS5zaGFyZUJsb2Nrc1RvVGFyZ2V0OwogIHZtLnNoYXJlQmxvY2tzVG9UYXJnZXQgPSBmdW5jdGlvbihibG9ja3MsIHRhcmdldElkLCBvcHRGcm9tVGFyZ2V0SWQpIHsKICAgIC8vIGxvYWQgcG90ZW50aWFsIGN1c3RvbSBibG9jayBkYXRhCiAgICBsZXQgcmVhbEJsb2NrczsKICAgIGlmIChibG9ja3MuY29uc3RydWN0b3I/Lm5hbWUgPT09ICJPYmplY3QiKSByZWFsQmxvY2tzID0gYmxvY2tzLmJsb2NrczsKICAgIGVsc2UgcmVhbEJsb2NrcyA9IGJsb2NrczsKCiAgICBsZXQgaGFzUHJvY0Jsb2NrID0gZmFsc2U7CiAgICBmb3IgKGNvbnN0IGJsb2NrIG9mIHJlYWxCbG9ja3MpIHsKICAgICAgaWYgKGJsb2NrLm9wY29kZSAhPT0gInByb2NlZHVyZXNfcHJvdG90eXBlIikgY29udGludWU7CiAgICAgIGNvbnN0IG1icERhdGEgPSBibG9jaz8uTXlCbG9ja3NQbHVzRGF0YTsKICAgICAgaWYgKG1icERhdGEpIHsKICAgICAgICBjb25zdCB0YXJnZXQgPSBydW50aW1lLmdldFRhcmdldEJ5SWQodGFyZ2V0SWQpOwogICAgICAgIHN0b3JlU2V0KGJsb2NrLm11dGF0aW9uLnByb2Njb2RlLCBtYnBEYXRhLCB0YXJnZXQpOwogICAgICAgIGhhbmRsZUN1c3RvbUlucHV0SW1wb3J0cyhibG9jay5NeUJsb2Nrc1BsdXNFeHRlcm5hbHMpOwogICAgICAgIGhhc1Byb2NCbG9jayA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICBjb25zdCBzaGFyZWQgPSBvZ1NoYXJlQmxvY2tzLmNhbGwodGhpcywgYmxvY2tzLCB0YXJnZXRJZCwgb3B0RnJvbVRhcmdldElkKTsKICAgIGlmIChoYXNQcm9jQmxvY2sgJiYgU2NyYXRjaC5ndWkpIFNjcmF0Y2guZ3VpLmdldEJsb2NrbHkoKS50aGVuKFNCID0+IHsKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgY29uc3Qgd29ya3NwYWNlID0gU0IubWFpbldvcmtzcGFjZTsKICAgICAgICBsaXN0TmVlZHNSZWZyZXNoID0gdHJ1ZTsKICAgICAgICBTQi5Qcm9jZWR1cmVzLmZseW91dENhdGVnb3J5KHdvcmtzcGFjZSk7CiAgICAgIH0sIDEwKTsKICAgIH0pOwogICAgcmV0dXJuIHNoYXJlZDsKICB9CiAgLyogQmFja3BhY2svSW1wb3J0L0V4cG9ydCBTdXBwb3J0IChTUFJJVEVTKSAqLwogIGNvbnN0IG9nRXhwb3J0U3ByaXRlID0gdm0uZXhwb3J0U3ByaXRlOwogIHZtLmV4cG9ydFNwcml0ZSA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgIC8vIGluamVjdCBvdXIgZHVtbXkgYmxvY2sgdG8gcHJldmVudCBleHRlbnNpb24gZGVsZXRpb24KICAgIGNvbnN0IHRhcmdldElEID0gYXJnc1swXTsKICAgIGlmIChzdG9yYWdlW3RhcmdldElEXSkgewogICAgICBjb25zdCB0YXJnZXQgPSBydW50aW1lLmdldFRhcmdldEJ5SWQodGFyZ2V0SUQpOwogICAgICB0YXJnZXQuYmxvY2tzLl9ibG9ja3NbVEVNUF9CTE9DS19PUENPREVdID0gewogICAgICAgIG9wY29kZTogVEVNUF9CTE9DS19PUENPREUsIGlkOiBURU1QX0JMT0NLX09QQ09ERSwgZmllbGRzOiB7fSwKICAgICAgICBuZXh0OiBudWxsLCBwYXJlbnQ6IG51bGwsIHNoYWRvdzogdHJ1ZSwgdG9MZXZlbDogdHJ1ZSwKICAgICAgICB4OiB1bmRlZmluZWQsIHk6IHVuZGVmaW5lZAogICAgICB9OwogICAgfQogICAgcmV0dXJuIG9nRXhwb3J0U3ByaXRlLmNhbGwodGhpcywgLi4uYXJncyk7CiAgfQogIGNvbnN0IG9nSW1wb3J0U3ByaXRlID0gdm0uX2FkZFNwcml0ZTM7CiAgdm0uX2FkZFNwcml0ZTMgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICBjb25zdCBpbXBvcnRUYXJnZXQgPSBhcmdzWzBdOwogICAgLy8gcmVtb3ZlIGR1bW15IGJsb2NrIGlmIHByZXNlbnQsIHRoaXMgaXMgbmV2ZXIgdGhlIHN0YWdlICh3aGVyZSBpdHMgc2F2ZWQpIHNvIG5vdGhpbmcgYmFkIHNob3VsZCBoYXBwZW4KICAgIGRlbGV0ZSBpbXBvcnRUYXJnZXQuYmxvY2tzW1RFTVBfQkxPQ0tfT1BDT0RFXTsKCiAgICAvLyBleHRyYWN0IHN0b3JhZ2UgdG8gY29weSBvdmVyCiAgICBsZXQgc3RvcmVkOwogICAgaWYgKGlzUE0pIHsKICAgICAgc3RvcmVkID0gaW1wb3J0VGFyZ2V0LmV4dGVuc2lvbkRhdGE/LlsiU1BtYnBDU1QiXT8uU1BtYnBDU1Q7CiAgICAgIGlmIChzdG9yZWQpIHsKICAgICAgICBjb25zdCBvZ1N0b3JlID0gc3RvcmFnZVtpbXBvcnRUYXJnZXQuaWRdOwogICAgICAgIHJ1bnRpbWUub25jZSgidGFyZ2V0V2FzQ3JlYXRlZCIsICh0YXJnZXQpID0+IHsKICAgICAgICAgIGlmIChTY3JhdGNoLmd1aSkgU2NyYXRjaC5ndWkuZ2V0QmxvY2tseSgpLnRoZW4oU0IgPT4gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIHN0b3JhZ2VbdGFyZ2V0LmlkXSA9IHN0b3JlZFtpbXBvcnRUYXJnZXQuaWRdOwogICAgICAgICAgICBzdG9yYWdlW2ltcG9ydFRhcmdldC5pZF0gPSBvZ1N0b3JlOwogICAgICAgICAgICBsaXN0TmVlZHNSZWZyZXNoID0gdHJ1ZTsKICAgICAgICAgICAgU0IuUHJvY2VkdXJlcy5mbHlvdXRDYXRlZ29yeShTQi5tYWluV29ya3NwYWNlKTsKICAgICAgICAgICAgcXVldWVNaWNyb3Rhc2soKCkgPT4gdm0uZW1pdFdvcmtzcGFjZVVwZGF0ZSgpKTsKICAgICAgICAgIH0sIDEwMCkpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBydW50aW1lLm9uY2UoInRhcmdldFdhc0NyZWF0ZWQiLCAodGFyZ2V0KSA9PiBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7CiAgICAgICAgc3RvcmVkID0gdGFyZ2V0LmV4dGVuc2lvblN0b3JhZ2VbIlNQbWJwQ1NUIl07CiAgICAgICAgaWYgKHN0b3JlZCkgewogICAgICAgICAgc3RvcmFnZVt0YXJnZXQuaWRdID0gc3RvcmVkOwogICAgICAgICAgbGlzdE5lZWRzUmVmcmVzaCA9IHRydWU7CiAgICAgICAgICBsZXQgaGFzR2xvYmFsID0gZmFsc2U7CiAgICAgICAgICBmb3IgKGNvbnN0IHByb2Mgb2YgT2JqZWN0LnZhbHVlcyhzdG9yZWQpKSB7CiAgICAgICAgICAgIGlmIChwcm9jLmdsb2JhbCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGhhc0dsb2JhbCA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gCiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGhhc0dsb2JhbCAmJiBTY3JhdGNoLmd1aSkgU2NyYXRjaC5ndWkuZ2V0QmxvY2tseSgpLnRoZW4oU0IgPT4gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGxpc3ROZWVkc1JlZnJlc2ggPSB0cnVlOwogICAgICAgICAgICBTQi5Qcm9jZWR1cmVzLmZseW91dENhdGVnb3J5KFNCLm1haW5Xb3Jrc3BhY2UpOwogICAgICAgICAgfSwgMTAwKSk7CiAgICAgICAgfQogICAgICB9KSk7CiAgICB9CgogICAgcmV0dXJuIG9nSW1wb3J0U3ByaXRlLmNhbGwodGhpcywgLi4uYXJncyk7CiAgfQoKICBjbGFzcyBTUG1icENTVCB7CiAgICBnZXRJbmZvKCkgewogICAgICByZXR1cm4gewogICAgICAgIGlkOiAiU1BtYnBDU1QiLAogICAgICAgIG5hbWU6IFNjcmF0Y2gudHJhbnNsYXRlKCJNeSBCbG9ja3MrIiksCiAgICAgICAgY29sb3IxOiAiI0ZGNjY4MCIsCiAgICAgICAgbWVudUljb25VUkksCiAgICAgICAgYmxvY2tzOiBbCiAgICAgICAgICB7CiAgICAgICAgICAgIGZ1bmM6ICJjcmVhdGVCbG9jayIsCiAgICAgICAgICAgIGJsb2NrVHlwZTogU2NyYXRjaC5CbG9ja1R5cGUuQlVUVE9OLAogICAgICAgICAgICBoaWRlRnJvbVBhbGV0dGU6IGV4dGVuc2lvblJlbW92YWJsZSwKICAgICAgICAgICAgdGV4dDogU2NyYXRjaC50cmFuc2xhdGUoIk1ha2UgYSBCbG9jaysiKSwKICAgICAgICAgIH0sCiAgICAgICAgICAvLyB7CiAgICAgICAgICAvLyAgIGZ1bmM6ICJyZW1vdmVFeHQiLAogICAgICAgICAgLy8gICBibG9ja1R5cGU6IFNjcmF0Y2guQmxvY2tUeXBlLkJVVFRPTiwKICAgICAgICAgIC8vICAgaGlkZUZyb21QYWxldHRlOiBleHRlbnNpb25SZW1vdmFibGUsCiAgICAgICAgICAvLyAgIHRleHQ6IFNjcmF0Y2gudHJhbnNsYXRlKCJSZW1vdmUgVGhpcyBFeHRlbnNpb24iKSwKICAgICAgICAgIC8vIH0sCiAgICAgICAgICAvLyDmiJHku6zmiZPnrpflsIbku5bnlKjkuo7mj5Lku7bvvIzmiYDku6XkuI3kvJrmlL7liKDpmaTmjInpkq4KICAgICAgICAgIHsKICAgICAgICAgICAgb3Bjb2RlOiAic2V0UGFyYW0iLAogICAgICAgICAgICBibG9ja1R5cGU6IFNjcmF0Y2guQmxvY2tUeXBlLkNPTU1BTkQsCiAgICAgICAgICAgIHRleHQ6IFNjcmF0Y2gudHJhbnNsYXRlKCJzZXQgW1BBUkFNXSB0byBbVkFMVUVdIiksCiAgICAgICAgICAgIGV4dGVuc2lvbnM6IFsiU1BtYnBDU1RfZGVmaW5lQ29sb3JlZCJdLAogICAgICAgICAgICBoaWRlRnJvbVBhbGV0dGU6IGV4dGVuc2lvblJlbW92YWJsZSwKICAgICAgICAgICAgYXJndW1lbnRzOiB7CiAgICAgICAgICAgICAgUEFSQU06IHsgdHlwZTogU2NyYXRjaC5Bcmd1bWVudFR5cGUuU1RSSU5HLCBtZW51OiAicHJvY2VkdXJlUGFyYW1NZW51IiB9LAogICAgICAgICAgICAgIFZBTFVFOiB7IHR5cGU6IFNjcmF0Y2guQXJndW1lbnRUeXBlLlNUUklORywgZGVmYXVsdFZhbHVlOiBTY3JhdGNoLnRyYW5zbGF0ZSgidmFsdWUiKSB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICB9LAogICAgICAgICAgLy8gewogICAgICAgICAgLy8gICBvcGNvZGU6ICJldmFsUGFyYW0iLAogICAgICAgICAgLy8gICBibG9ja1R5cGU6IFNjcmF0Y2guQmxvY2tUeXBlLkNPTU1BTkQsCiAgICAgICAgICAvLyAgIHRleHQ6IFNjcmF0Y2gudHJhbnNsYXRlKCJyZWV2YWx1YXRlIFtQQVJBTV0iKSwKICAgICAgICAgIC8vICAgZXh0ZW5zaW9uczogWyJTUG1icENTVF9kZWZpbmVDb2xvcmVkIl0sCiAgICAgICAgICAvLyAgIGhpZGVGcm9tUGFsZXR0ZTogZXh0ZW5zaW9uUmVtb3ZhYmxlLAogICAgICAgICAgLy8gICBhcmd1bWVudHM6IHsKICAgICAgICAgIC8vICAgICBQQVJBTTogeyB0eXBlOiBTY3JhdGNoLkFyZ3VtZW50VHlwZS5TVFJJTkcsIG1lbnU6ICJwcm9jZWR1cmVQYXJhbU1lbnUiIH0KICAgICAgICAgIC8vICAgfSwKICAgICAgICAgIC8vIH0sCiAgICAgICAgICAvLyDov5nkuKrnp6/mnKjkuI3lhbzlrrlUVwogICAgICAgICAgewogICAgICAgICAgICBvcGNvZGU6ICJnZXRQYXJhbSIsCiAgICAgICAgICAgIGJsb2NrVHlwZTogU2NyYXRjaC5CbG9ja1R5cGUuUkVQT1JURVIsCiAgICAgICAgICAgIHRleHQ6IFNjcmF0Y2gudHJhbnNsYXRlKCJnZXQgW1BBUkFNXSIpLAogICAgICAgICAgICBleHRlbnNpb25zOiBbIlNQbWJwQ1NUX2RlZmluZUNvbG9yZWQiXSwKICAgICAgICAgICAgYWxsb3dEcm9wQW55d2hlcmU6IHRydWUsCiAgICAgICAgICAgIGhpZGVGcm9tUGFsZXR0ZTogZXh0ZW5zaW9uUmVtb3ZhYmxlLAogICAgICAgICAgICBhcmd1bWVudHM6IHsKICAgICAgICAgICAgICBQQVJBTTogeyB0eXBlOiBTY3JhdGNoLkFyZ3VtZW50VHlwZS5TVFJJTkcsIGRlZmF1bHRWYWx1ZTogU2NyYXRjaC50cmFuc2xhdGUoInBhcmFtZXRlciBuYW1lIikgfQogICAgICAgICAgICB9LAogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgb3Bjb2RlOiAicnVuQnJhbmNoIiwKICAgICAgICAgICAgYmxvY2tUeXBlOiBTY3JhdGNoLkJsb2NrVHlwZS5DT01NQU5ELAogICAgICAgICAgICB0ZXh0OiBTY3JhdGNoLnRyYW5zbGF0ZSgic3RhcnQgYnJhbmNoIFtJTkRFWF0gW0lDT05dIiksCiAgICAgICAgICAgIGV4dGVuc2lvbnM6IFsiU1BtYnBDU1RfZGVmaW5lQ29sb3JlZCJdLAogICAgICAgICAgICBoaWRlRnJvbVBhbGV0dGU6IGlzUE0gfHwgZXh0ZW5zaW9uUmVtb3ZhYmxlLAogICAgICAgICAgICBhcmd1bWVudHM6IHsKICAgICAgICAgICAgICBJTkRFWDogeyB0eXBlOiBTY3JhdGNoLkFyZ3VtZW50VHlwZS5OVU1CRVIsIGRlZmF1bHRWYWx1ZTogMSB9LAogICAgICAgICAgICAgIElDT046IHsgdHlwZTogU2NyYXRjaC5Bcmd1bWVudFR5cGUuSU1BR0UsIGRhdGFVUkk6IGd1aVVSSXMoImJyYW5jaFN0YXJ0IikgfQogICAgICAgICAgICB9LAogICAgICAgICAgfSwKICAgICAgICAgIHsKICAgICAgICAgICAgb3Bjb2RlOiAic3RvcENhbGxlclNjcmlwdCIsCiAgICAgICAgICAgIGJsb2NrVHlwZTogU2NyYXRjaC5CbG9ja1R5cGUuQ09NTUFORCwKICAgICAgICAgICAgdGV4dDogU2NyYXRjaC50cmFuc2xhdGUoInN0b3AgY2FsbGVyIHNjcmlwdCIpLAogICAgICAgICAgICBleHRlbnNpb25zOiBbIlNQbWJwQ1NUX2RlZmluZUNvbG9yZWQiXSwKICAgICAgICAgICAgaXNUZXJtaW5hbDogdHJ1ZSwKICAgICAgICAgICAgaGlkZUZyb21QYWxldHRlOiBleHRlbnNpb25SZW1vdmFibGUKICAgICAgICAgIH0sCiAgICAgICAgICB7CiAgICAgICAgICAgIGJsb2NrVHlwZTogU2NyYXRjaC5CbG9ja1R5cGUuWE1MLAogICAgICAgICAgICBoaWRlRnJvbVBhbGV0dGU6IGV4dGVuc2lvblJlbW92YWJsZSwKICAgICAgICAgICAgeG1sOiBgPGJsb2NrIHR5cGU9InByb2NlZHVyZXNfcmV0dXJuIj48dmFsdWUgbmFtZT0iJHtpc1BNID8gInJldHVybiIgOiAiVkFMVUUifSI+PHNoYWRvdyB0eXBlPSJ0ZXh0Ij48ZmllbGQgbmFtZT0iVEVYVCI+PC9maWVsZD48L3NoYWRvdz48L3ZhbHVlPjwvYmxvY2s+YCwKICAgICAgICAgIH0KICAgICAgICBdLAogICAgICAgIG1lbnVzOiB7CiAgICAgICAgICBwcm9jZWR1cmVQYXJhbU1lbnU6IHsKICAgICAgICAgICAgYWNjZXB0UmVwb3J0ZXJzOiBmYWxzZSwgaXRlbXM6ICJnZXRQcm9jZWR1cmVQYXJhbU1lbnUiCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgfTsKICAgIH0KCiAgICBjcmVhdGVCbG9jaygpIHsKICAgICAgY29uc3Qgd29ya3NwYWNlID0gU2NyYXRjaEJsb2Nrcy5tYWluV29ya3NwYWNlOwogICAgICBTY3JhdGNoQmxvY2tzLlByb2NlZHVyZXMuY3JlYXRlUHJvY2VkdXJlRGVmQ2FsbGJhY2tfKHdvcmtzcGFjZSk7CiAgICB9CgogICAgcmVtb3ZlRXh0KCkgewogICAgICBpZiAoY29uZmlybSgiUmVtb3ZlIHRoaXMgZXh0ZW5zaW9uPyBUaGlzIHdpbGwgcmVtb3ZlIGFsbCBuZXcgZmVhdHVyZXMgYXR0cmlidXRlZCB0byBNeSBCbG9ja3MrIikpCiAgICAgICAgcmVtb3ZlRXh0ZW5zaW9uKCk7CiAgICB9CgogICAgZ2V0UHJvY2VkdXJlUGFyYW1NZW51KCkgewogICAgICBpZiAoCiAgICAgICAgIVNjcmF0Y2hCbG9ja3MgfHwgIVNjcmF0Y2hCbG9ja3Muc2VsZWN0ZWQgfHwgU2NyYXRjaEJsb2Nrcy5zZWxlY3RlZC5pc0luRmx5b3V0IHx8CiAgICAgICAgKFNjcmF0Y2hCbG9ja3Muc2VsZWN0ZWQudHlwZSAhPT0gIlNQbWJwQ1NUX3NldFBhcmFtIiAmJiBTY3JhdGNoQmxvY2tzLnNlbGVjdGVkLnR5cGUgIT09ICJTUG1icENTVF9ldmFsUGFyYW0iKQogICAgICApIHJldHVybiBbU2NyYXRjaC50cmFuc2xhdGUoInBhcmFtZXRlciBuYW1lIildOwogICAgICBsZXQgdG9wQmxvY2sgPSBTY3JhdGNoQmxvY2tzLnNlbGVjdGVkLCBwYXJlbnQgPSBudWxsOwogICAgICB3aGlsZSAoKHBhcmVudCA9IHRvcEJsb2NrPy5nZXRQYXJlbnQoKSkpIHsgdG9wQmxvY2sgPSBwYXJlbnQgfQogICAgICBpZiAoIXRvcEJsb2NrIHx8ICF0b3BCbG9jay50eXBlLnN0YXJ0c1dpdGgoInByb2NlZHVyZXNfZGVmaW5pdGlvbiIpKSByZXR1cm4gWyIobm90IGluIGEgZGVmaW5lIHNjcmlwdCEpIl07CiAgICAgIGNvbnN0IGlubmVyQmxvY2sgPSB0b3BCbG9jay5nZXRJbnB1dCgiY3VzdG9tX2Jsb2NrIik/LmNvbm5lY3Rpb24/LnRhcmdldEJsb2NrKCk7CiAgICAgIGlmICghaW5uZXJCbG9jayB8fCAhaW5uZXJCbG9jay50eXBlID09ICJwcm9jZWR1cmVzX3Byb3RvdHlwZSIpIHJldHVybiBbIihpbnZhbGlkIGRlZmluZSBibG9jayEpIl07CgogICAgICBpZiAoaW5uZXJCbG9jay5kaXNwbGF5TmFtZXNfLmxlbmd0aCkgewogICAgICAgIGNvbnN0IHN0b3JlID0gc3RvcmVHZXQoaW5uZXJCbG9jay5wcm9jQ29kZV8pOwogICAgICAgIGlmICghc3RvcmUgfHwgIXN0b3JlLmlucHV0cykgcmV0dXJuIGlubmVyQmxvY2suZGlzcGxheU5hbWVzXzsKICAgICAgICBlbHNlIHsKICAgICAgICAgIGNvbnN0IG5hbWVzID0gc3RydWN0dXJlZENsb25lKGlubmVyQmxvY2suZGlzcGxheU5hbWVzXyk7CiAgICAgICAgICBjb25zdCBhbGxJbnB1dHMgPSBPYmplY3QuZW50cmllcyhzdG9yZS5pbnB1dHMpOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxJbnB1dHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKGFsbElucHV0c1tpXVsxXS50eXBlID09PSAiYnJjIikgewogICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gaW5uZXJCbG9jay5hcmd1bWVudElkc18uaW5kZXhPZihhbGxJbnB1dHNbaV1bMF0pOwogICAgICAgICAgICAgIG5hbWVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuYW1lcy5sZW5ndGggPyBuYW1lcyA6IFsiIl07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBbIiJdOwogICAgfQoKICAgIHNldFBhcmFtKGFyZ3MsIHV0aWwpIHsKICAgICAgY29uc3QgdGhyZWFkID0gdXRpbC50aHJlYWQ7CiAgICAgIGNvbnN0IHBhcmFtID0gU2NyYXRjaC5DYXN0LnRvU3RyaW5nKGFyZ3MuUEFSQU0pOwogICAgICBmb3IgKGxldCBpID0gdGhyZWFkLnN0YWNrRnJhbWVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgY29uc3QgZnJhbWUgPSB0aHJlYWQuc3RhY2tGcmFtZXNbaV07CiAgICAgICAgaWYgKGZyYW1lLnBhcmFtcyA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgZnJhbWUucGFyYW1zW3BhcmFtXSA9IGFyZ3MuVkFMVUU7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIC8vIFBhcmFtZXRlcnMgbm90IHByZXNlbnQuIFByb2JhYmx5IGEgbG9uZSBzY3JpcHQgb3IgYSBzdGFjay1jbGlja2VkIGRlZmluZSBibG9jay4KICAgICAgLy8gSW4gdGhpcyBjYXNlLCBhZGQgdGhlIHBhcmFtcyB0byB0aGUgYm90dG9tIG9mIHRoZSBzdGFjawogICAgICAvLyAoYW5kIHB1c2ggdGhlIGN1cnJlbnQgYmxvY2sgdG8gaXQgc28gdGhleSBhcmVuJ3QgcmVzZXQgZm9yIHNvbWUgcmVhc29uKQogICAgICB0aHJlYWQuc3RhY2tGcmFtZXNbMF0ucGFyYW1zID0geyBbcGFyYW1dOiBhcmdzLlZBTFVFIH07CiAgICAgIHRocmVhZC5wdXNoU3RhY2sodGhyZWFkLnBlZWtTdGFjaygpKTsKICAgICAgLy8gTWFrZSB0aGUgYm90dG9tIG9mIHRoZSBzdGFjayBwb2ludCB0byBhIG5vbmV4aXN0ZW50IGJsb2NrIHNvIHRoZSBzY3JpcHQganVzdCBlbmRzCiAgICAgIC8vIGluc3RlYWQgb2YgcnVubmluZyBwYXJ0IG9mIGl0IGFnYWluCiAgICAgIHRocmVhZC5zdGFja1swXSA9ICIiOwogICAgfQoKICAgIGV2YWxQYXJhbShhcmdzLCB1dGlsKSB7CiAgICAgIGlmICghVGhyZWFkIHx8ICFleGVjdXRlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiTXkgQmxvY2tzKyBjb3VsZCBub3QgYWNjZXNzIEV4cG9ydHMhIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zdCB0aHJlYWQgPSB1dGlsLnRocmVhZDsKICAgICAgaWYgKCF0aHJlYWRbdGFyZ2V0UHJvY0RhdGFdKSByZXR1cm47CgogICAgICBjb25zdCB7IHBhcmFtcywgYmxvY2ssIGZyYW1lIH0gPSB0aHJlYWRbdGFyZ2V0UHJvY0RhdGFdOwogICAgICBjb25zdCBwYXJhbSA9IFNjcmF0Y2guQ2FzdC50b1N0cmluZyhhcmdzLlBBUkFNKTsKICAgICAgY29uc3QgaW5kZXggPSBwYXJhbXNbMF0uaW5kZXhPZihwYXJhbSk7CiAgICAgIGlmIChpbmRleCA9PT0gLTEpIHJldHVybjsKCiAgICAgIGNvbnN0IGJsb2NrVmFsdWUgPSBibG9jay5pbnB1dHNbcGFyYW1zWzFdW2luZGV4XV07CiAgICAgIGlmICghYmxvY2tWYWx1ZSkgcmV0dXJuOwoKICAgICAgY29uc3QgdGVtcFRocmVhZCA9IG5ldyBUaHJlYWQ7CiAgICAgIHRlbXBUaHJlYWQudG9wQmxvY2sgPSBibG9ja1ZhbHVlLmJsb2NrOwogICAgICB0ZW1wVGhyZWFkLnB1c2hTdGFjayhibG9ja1ZhbHVlLmJsb2NrKQogICAgICB0ZW1wVGhyZWFkLmJsb2NrQ29udGFpbmVyID0gdGhyZWFkLmJsb2NrQ29udGFpbmVyOwogICAgICB0ZW1wVGhyZWFkLnRhcmdldCA9IHRocmVhZC50YXJnZXQ7CiAgICAgIHRlbXBUaHJlYWQucHVzaFJlcG9ydGVkVmFsdWUgPSAodmFsdWUpID0+IHsgZnJhbWUucGFyYW1zW3BhcmFtXSA9IHZhbHVlIH07CiAgICAgIGV4ZWN1dGUocnVudGltZS5zZXF1ZW5jZXIsIHRlbXBUaHJlYWQpOwogICAgfQoKICAgIGdldFBhcmFtKGFyZ3MsIHV0aWwpIHsKICAgICAgY29uc3QgcGFyYW0gPSB1dGlsLnRocmVhZC5nZXRQYXJhbShTY3JhdGNoLkNhc3QudG9TdHJpbmcoYXJncy5QQVJBTSkpOwogICAgICByZXR1cm4gcGFyYW0gPz8gIiI7CiAgICB9CgogICAgc3RvcENhbGxlclNjcmlwdChfLCB1dGlsKSB7CiAgICAgIC8vIHN0b3BzIHRocmVhZHMgZW50aXJlbHksIGluY2x1ZGluZyBjdXN0b20gYmxvY2tzIGNvbnRleHRzCiAgICAgIC8vIG1vcmUgcG93ZXJmdWwgdGhhbiAndXRpbC5zdG9wVGhpc1NjcmlwdCgpJwogICAgICB1dGlsLnRocmVhZC5zdGF0dXMgPSA0OwogICAgfQoKICAgIHJ1bkJyYW5jaChhcmdzLCB1dGlsKSB7CiAgICAgIGNvbnN0IHRocmVhZCA9IHV0aWwudGhyZWFkOwogICAgICBpZiAoIXV0aWwudGhyZWFkW3RhcmdldFByb2NEYXRhXSkgcmV0dXJuOwoKICAgICAgY29uc3QgcHJvY0Jsb2NrID0gdXRpbC50aHJlYWRbdGFyZ2V0UHJvY0RhdGFdLmJsb2NrOwogICAgICBjb25zdCBzdG9yZSA9IHN0b3JlR2V0KHByb2NCbG9jay5tdXRhdGlvbi5wcm9jY29kZSwgdGhyZWFkLnRhcmdldCk7CiAgICAgIGlmICghc3RvcmUgfHwgIXN0b3JlLmlucHV0cykgcmV0dXJuOwoKICAgICAgY29uc3QgYWxsSW5wdXRzID0gdXRpbC50aHJlYWRbdGFyZ2V0UHJvY0RhdGFdLnBhcmFtc1sxXTsKICAgICAgY29uc3QgYnJhbmNoZXMgPSBbXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxJbnB1dHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoc3RvcmUuaW5wdXRzW2FsbElucHV0c1tpXV0/LnR5cGUgPT09ICJicmMiKSBicmFuY2hlcy5wdXNoKGFsbElucHV0c1tpXSk7CiAgICAgIH0KCiAgICAgIGlmIChicmFuY2hlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgaW5kZXggPSBTY3JhdGNoLkNhc3QudG9OdW1iZXIoYXJncy5JTkRFWCkgLSAxOwogICAgICAgIGNvbnN0IHJlYWxQcm9jQmxvY2sgPSB0aHJlYWQuYmxvY2tDb250YWluZXIuZ2V0QmxvY2socHJvY0Jsb2NrLmlkKTsKICAgICAgICBjb25zdCBicmFuY2ggPSByZWFsUHJvY0Jsb2NrLmlucHV0c1ticmFuY2hlc1tpbmRleF1dPy5ibG9jazsKICAgICAgICBpZiAoYnJhbmNoKSB1dGlsLnRocmVhZC5wdXNoU3RhY2soYnJhbmNoKTsKICAgICAgfQogICAgfQoKICAgIC8vIFN0b3JhZ2Ugc2V0L2dldAogICAgc2VyaWFsaXplKCkgewogICAgICBpZiAoaXNQTSkgewogICAgICAgIHN1c3BlbmRSZW1vdmFsID0gZmFsc2U7CiAgICAgICAgcmVtb3ZlVW51c2VkUHJvY3MoKTsKICAgICAgICByZW1vdmVVbnVzZWRJbWFnZXMoKTsKICAgICAgICByZXR1cm4geyBTUG1icENTVDogeyAuLi5zdG9yYWdlLCBpbWdTdG9yYWdlIH0gfTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB0YXJnZXQgSUQncyBjaGFuZ2Ugd2hlbiBzYXZpbmcgOigKICAgICAgICBydW50aW1lLmV4dGVuc2lvblN0b3JhZ2VbIlNQbWJwQ1NUIl0gPSB7IGxvYWRlZDogdHJ1ZSwgaW1nU3RvcmFnZSB9OwogICAgICAgIGZvciAoY29uc3QgW2lkLCBwcm9jc10gb2YgT2JqZWN0LmVudHJpZXMoc3RvcmFnZSkpIHsKICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHJ1bnRpbWUuZ2V0VGFyZ2V0QnlJZChpZCk7CiAgICAgICAgICBpZiAoIXRhcmdldCkgY29udGludWU7CiAgICAgICAgICB0YXJnZXQuZXh0ZW5zaW9uU3RvcmFnZVsiU1BtYnBDU1QiXSA9IHsgLi4ucHJvY3MgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGRlc2VyaWFsaXplKGRhdGEpIHsKICAgICAgZGVzZXJpYWxpemVTdG9yYWdlKGRhdGEpOwogICAgfQogIH0KCiAgZXh0ID0gbmV3IFNQbWJwQ1NUKCk7CiAgU2NyYXRjaC5leHRlbnNpb25zLnJlZ2lzdGVyKGV4dCk7Cn0pKFNjcmF0Y2gpOwo=\n      ", true);
  };
  if (vm.editingTarget) {
    loadExtensions();
  } else {
    vm.runtime.once("PROJECT_LOADED", loadExtensions);
  }
});

/***/ })

}]);
//# sourceMappingURL=addon-entry-my-blocks-plus.js.map